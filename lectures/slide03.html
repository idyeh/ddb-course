<!DOCTYPE html>
<html lang="zh-CN"><head>
<script src="slide03_files/libs/clipboard/clipboard.min.js"></script>
<script src="slide03_files/libs/quarto-html/tabby.min.js"></script>
<script src="slide03_files/libs/quarto-html/popper.min.js"></script>
<script src="slide03_files/libs/quarto-html/tippy.umd.min.js"></script>
<link href="slide03_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="slide03_files/libs/quarto-html/light-border.css" rel="stylesheet">
<link href="slide03_files/libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.7.33">

  <meta name="author" content="叶鸿">
  <meta name="dcterms.date" content="2025-09-17">
  <title>分布式数据库开发</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="slide03_files/libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="slide03_files/libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="slide03_files/libs/revealjs/dist/theme/quarto-f563837468303362081e247dddd440d0.css">
  <link href="slide03_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="slide03_files/libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="slide03_files/libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="slide03_files/libs/revealjs/plugin/reveal-chalkboard/font-awesome/css/all.css" rel="stylesheet">
  <link href="slide03_files/libs/revealjs/plugin/reveal-chalkboard/style.css" rel="stylesheet">
  <link href="slide03_files/libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
  <script src="slide03_files/libs/quarto-diagram/mermaid-postprocess-shim.js"></script>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">分布式数据库开发</h1>
  <p class="subtitle">第2讲：复制语义与共识</p>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
叶鸿 
</div>
</div>
</div>

  <p class="date">2025-09-17</p>
</section>
<section id="热身场景" class="slide level2">
<h2>热身场景</h2>
<ul>
<li>多节点数据库集群同时接到“从 Alice 账户转 100 元给 Bob”（<code>transfer(A→B, 100)</code>）
<ul>
<li><code>A -= 100</code></li>
<li><code>B += 100</code></li>
</ul></li>
<li>如果各节点看到的顺序<strong>不一致</strong>，最终余额<strong>对不上</strong></li>
</ul>
</section>
<section id="引子为什么需要共识" class="slide level2 smaller">
<h2>引子：为什么需要共识？</h2>
<ul>
<li>我们希望<strong>多个副本（Replica）</strong>在面对<strong>并发写入、宕机、网络抖动</strong>时，仍对“系统发生了什么”达成<strong>同一个历史叙事</strong>。</li>
<li>两个目标：
<ul>
<li><strong>安全性（Safety）</strong>：永不出现“两个不同结果都被当成真”的情况<br>
</li>
<li><strong>活性（Liveness）</strong>：在故障可容忍范围内，系统最终能前进，别永远卡关</li>
</ul></li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>注记</strong></p>
</div>
<div class="callout-content">
<p>类比小组成员一起写论文</p>
<ul>
<li>安全性：不能出现两个最终版本同时投稿<br>
</li>
<li>活性：别因为吵架/人不在而一直没法定稿</li>
</ul>
</div>
</div>
</div>
</section>
<section id="本讲导览" class="slide level2">
<h2>本讲导览</h2>
<ul>
<li>从<strong>复制语义</strong>出发：复制“状态” VS 复制“操作”</li>
<li>状态机复制（SMR）与<strong>一致性</strong>目标</li>
<li><strong>Raft</strong>：选主、日志复制、安全性</li>
<li><strong>Paxos</strong>：核心相位与与 Raft 的关系</li>
<li>实验演示与课堂练习</li>
</ul>
</section>
<section>
<section id="复制语义状态-vs-操作" class="title-slide slide level1 center">
<h1>复制语义：状态 vs 操作</h1>

</section>
<section id="复制状态" class="slide level2">
<h2>复制状态</h2>
<ul>
<li>直接把<strong>最终内存/存储状态</strong>打包发给别人</li>
<li>技术：全量/增量同步、<strong>快照复制</strong></li>
<li>优点：<strong>快</strong>，一次到位；新副本追上进度简单</li>
<li>难点：<strong>差异合并</strong>、冲突解决、频繁更新时的带宽与一致性窗口</li>
<li>风险：需要明确<strong>状态格式/版本</strong>；跨版本回放易出错</li>
</ul>
</section>
<section id="复制操作" class="slide level2">
<h2>复制操作</h2>
<ul>
<li>广播<strong>操作日志</strong>，各副本按同样顺序、在<strong>确定性状态机</strong>中重放</li>
<li>技术：<strong>状态机复制（State Machine Replication，SMR）</strong>，把写请求作为<strong>日志条目</strong>顺序执行</li>
<li>优点：更<strong>可审计</strong>，可重放、可回溯、<strong>因果顺序清晰</strong>；跨版本演进更平滑</li>
<li>难点：<strong>全体副本</strong>必须对执行顺序达成一致，这就需要<strong>共识协议</strong></li>
</ul>
</section>
<section id="一致性模型与复制语义的关系" class="slide level2">
<h2>一致性模型与复制语义的关系</h2>
<ul>
<li><strong>强一致性</strong>（线性一致性）：看起来像一台<strong>单机</strong>按实时<strong>时序</strong>执行</li>
<li><strong>顺序一致性</strong>：保留同一客户端的操作顺序，整体顺序可能不同</li>
<li><strong>最终一致性</strong>：允许节点之间出现暂时的不一致，优先考虑高可用性和低延迟，而非即时数据同步</li>
</ul>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>重要</strong></p>
</div>
<div class="callout-content">
<p><strong>状态复制</strong>常与较弱一致性搭配；<strong>操作复制 + 共识</strong>指向更强的一致性语义，甚至可达线性一致</p>
</div>
</div>
</div>
</section>
<section id="一致性模型与状态机复制" class="slide level2">
<h2>一致性模型与状态机复制</h2>
<p>状态机复制（SMR）给出实现路线：</p>
<ol type="1">
<li>用<strong>共识协议</strong>给操作定<strong>总顺序</strong></li>
<li>各节点在<strong>同一顺序</strong>下执行，状态保持一致</li>
</ol>
</section></section>
<section>
<section id="paxos" class="title-slide slide level1 center">
<h1>Paxos</h1>

</section>
<section id="paxos-1" class="slide level2" data-background-image="./assets/paxos_island.jpg" data-background-opacity="0.1">
<h2>Paxos</h2>
<object data="https://lamport.azurewebsites.net/pubs/paxos-simple.pdf" type="application/pdf" width="100%" height="90%">
    <p>如果没有显示 PDF，莫慌，你可以<a href="https://lamport.azurewebsites.net/pubs/paxos-simple.pdf">点击下载</a>。</p>
</object>
</section>
<section id="paxos-概览" class="slide level2 smaller">
<h2>Paxos 概览</h2>
<ul>
<li><p>角色：<strong>Proposer / Acceptor / Learner</strong></p></li>
<li><p>多数派交集保证<strong>唯一性</strong>（安全性）</p></li>
<li><p>分两个阶段：</p>
<ol type="1">
<li><strong>Prepare / Promise（1a/1b）</strong>：锁定更高提案号，承诺不再接受更低号</li>
<li><strong>Accept / Accepted（2a/2b）</strong>：多数 Acceptor 接受某个提，该值被选定接受</li>
</ol></li>
<li><p>多值（日志）用 <strong>Multi-Paxos</strong>：等价于“长期 Leader”不断发提案</p></li>
<li><p><strong>Raft ≈ Multi-Paxos 的工程化</strong>：固定 Leader，化繁为简，把多数复杂性放在日志复制与任期机制</p></li>
</ul>
</section>
<section id="paxos-概念图示" class="slide level2">
<h2>Paxos 概念图示</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<svg aria-roledescription="sequence" role="graphics-document document" viewbox="-50 -10 850 539" style="; display: block; margin: auto auto auto auto" xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="960" id="mermaid-figure-1" height="480">
<g><rect class="actor actor-bottom" ry="3" rx="3" name="L" height="65" width="150" stroke="#666" fill="#eaeaea" y="453" x="600"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="485.5" x="675"><tspan dy="0" x="675">Learner</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="A2" height="65" width="150" stroke="#666" fill="#eaeaea" y="453" x="400"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="485.5" x="475"><tspan dy="0" x="475">Acceptor2</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="A1" height="65" width="150" stroke="#666" fill="#eaeaea" y="453" x="200"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="485.5" x="275"><tspan dy="0" x="275">Acceptor1</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="P" height="65" width="150" stroke="#666" fill="#eaeaea" y="453" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="485.5" x="75"><tspan dy="0" x="75">Proposer</tspan></text></g><g><line name="L" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="453" x2="675" y1="5" x1="675" id="actor3"></line><g id="root-3"><rect class="actor actor-top" ry="3" rx="3" name="L" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="600"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="675"><tspan dy="0" x="675">Learner</tspan></text></g></g><g><line name="A2" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="453" x2="475" y1="5" x1="475" id="actor2"></line><g id="root-2"><rect class="actor actor-top" ry="3" rx="3" name="A2" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="400"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="475"><tspan dy="0" x="475">Acceptor2</tspan></text></g></g><g><line name="A1" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="453" x2="275" y1="5" x1="275" id="actor1"></line><g id="root-1"><rect class="actor actor-top" ry="3" rx="3" name="A1" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="200"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="275"><tspan dy="0" x="275">Acceptor1</tspan></text></g></g><g><line name="P" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="453" x2="75" y1="5" x1="75" id="actor0"></line><g id="root-0"><rect class="actor actor-top" ry="3" rx="3" name="P" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="75"><tspan dy="0" x="75">Proposer</tspan></text></g></g>
<style>#mermaid-figure-1{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-figure-1 .error-icon{fill:#552222;}#mermaid-figure-1 .error-text{fill:#552222;stroke:#552222;}#mermaid-figure-1 .edge-thickness-normal{stroke-width:1px;}#mermaid-figure-1 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-figure-1 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-figure-1 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-figure-1 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-figure-1 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-figure-1 .marker{fill:#333333;stroke:#333333;}#mermaid-figure-1 .marker.cross{stroke:#333333;}#mermaid-figure-1 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-figure-1 p{margin:0;}#mermaid-figure-1 .actor{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-1 text.actor>tspan{fill:black;stroke:none;}#mermaid-figure-1 .actor-line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-1 .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaid-figure-1 .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaid-figure-1 #mermaid-figure-1-arrowhead path{fill:#333;stroke:#333;}#mermaid-figure-1 .sequenceNumber{fill:white;}#mermaid-figure-1 #mermaid-figure-1-sequencenumber{fill:#333;}#mermaid-figure-1 #mermaid-figure-1-crosshead path{fill:#333;stroke:#333;}#mermaid-figure-1 .messageText{fill:#333;stroke:none;}#mermaid-figure-1 .labelBox{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-1 .labelText,#mermaid-figure-1 .labelText>tspan{fill:black;stroke:none;}#mermaid-figure-1 .loopText,#mermaid-figure-1 .loopText>tspan{fill:black;stroke:none;}#mermaid-figure-1 .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-1 .note{stroke:#aaaa33;fill:#fff5ad;}#mermaid-figure-1 .noteText,#mermaid-figure-1 .noteText>tspan{fill:black;stroke:none;}#mermaid-figure-1 .activation0{fill:#f4f4f4;stroke:#666;}#mermaid-figure-1 .activation1{fill:#f4f4f4;stroke:#666;}#mermaid-figure-1 .activation2{fill:#f4f4f4;stroke:#666;}#mermaid-figure-1 .actorPopupMenu{position:absolute;}#mermaid-figure-1 .actorPopupMenuPanel{position:absolute;fill:#ECECFF;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);filter:drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4));}#mermaid-figure-1 .actor-man line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-1 .actor-man circle,#mermaid-figure-1 line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;stroke-width:2px;}#mermaid-figure-1 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style>
<g></g><defs><symbol height="24" width="24" id="mermaid-figure-1-computer"><path d="M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z" transform="scale(.5)"></path></symbol></defs><defs><symbol clip-rule="evenodd" fill-rule="evenodd" id="mermaid-figure-1-database"><path d="M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z" transform="scale(.5)"></path></symbol></defs><defs><symbol height="24" width="24" id="mermaid-figure-1-clock"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z" transform="scale(.5)"></path></symbol></defs><defs><marker orient="auto-start-reverse" markerheight="12" markerwidth="12" markerunits="userSpaceOnUse" refy="5" refx="7.9" id="mermaid-figure-1-arrowhead"><path d="M -1 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker refy="4.5" refx="4" orient="auto" markerheight="8" markerwidth="15" id="mermaid-figure-1-crosshead"><path style="stroke-dasharray: 0, 0;" d="M 1,2 L 6,7 M 6,2 L 1,7" stroke-width="1pt" stroke="#000000" fill="none"></path></marker></defs><defs><marker orient="auto" markerheight="28" markerwidth="20" refy="7" refx="15.5" id="mermaid-figure-1-filled-head"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerheight="40" markerwidth="60" refy="15" refx="15" id="mermaid-figure-1-sequencenumber"><circle r="6" cy="15" cx="15"></circle></marker></defs><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="80" x="174">Prepare(n)</text><line style="fill: none;" marker-end="url(#mermaid-figure-1-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="111" x2="271" y1="111" x1="76"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="126" x="274">Prepare(n)</text><line style="fill: none;" marker-end="url(#mermaid-figure-1-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="157" x2="471" y1="157" x1="76"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="172" x="177">Promise(max seen)</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-end="url(#mermaid-figure-1-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="203" x2="79" y1="203" x1="274"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="218" x="277">Promise(max seen)</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-end="url(#mermaid-figure-1-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="249" x2="79" y1="249" x1="474"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="264" x="174">Accept(n, value)</text><line style="fill: none;" marker-end="url(#mermaid-figure-1-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="295" x2="271" y1="295" x1="76"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="310" x="274">Accept(n, value)</text><line style="fill: none;" marker-end="url(#mermaid-figure-1-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="341" x2="471" y1="341" x1="76"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="356" x="474">Accepted(n,value)</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-end="url(#mermaid-figure-1-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="387" x2="671" y1="387" x1="276"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="402" x="574">Accepted(n,value)</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-end="url(#mermaid-figure-1-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="433" x2="671" y1="433" x1="476"></line>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section></section>
<section>
<section id="raft" class="title-slide slide level1 center">
<h1>Raft</h1>

</section>
<section id="raft-概述" class="slide level2">
<h2>Raft 概述</h2>
<object data="https://raft.github.io/raft.pdf" type="application/pdf" width="100%" height="90%">
    <p>如果没有显示 PDF，莫慌，你可以<a href="https://raft.github.io/raft.pdf">点击下载</a>。</p>
</object>
</section>
<section id="raft-总览复杂问题拆开做" class="slide level2">
<h2>Raft 总览：复杂问题拆开做</h2>
<ul>
<li>子问题（规则制定）：
<ol type="1">
<li><strong>选 Leader</strong>：谁当组长，负责统一收作业、发口令？</li>
<li><strong>复制日志</strong>：组长如何让大家按<strong>同一顺序</strong>抄过程？</li>
<li><strong>保证安全性</strong>：如何避免定稿的作业被推翻或分叉？</li>
</ol></li>
</ul>
</section>
<section id="raft-关键术语" class="slide level2 smaller">
<h2>Raft 关键术语</h2>
<ul>
<li><strong>角色</strong>：Follower / Candidate / Leader</li>
<li><strong>Leader</strong> 类似“组长”，统一收发，避免多人同时指挥</li>
<li><strong>Term（任期）</strong>：单调递增的逻辑时钟，一段时间内的第 N 任组长</li>
<li><strong>Log（日志）</strong>：要执行的操作序列，格式 <code>[(index, term, command), ...]</code></li>
<li><strong>AppendEntries</strong> 群发作业进度通知，对齐上次抄到哪一行</li>
<li><strong>prevLogIndex/prevLogTerm</strong>：附带“对齐点”做一致性检查</li>
<li><strong>commitIndex</strong>：已被多数（≥ ⌊N/2⌋+1）确认、可<strong>提交</strong>到状态机的最高日志索引</li>
<li><strong>nextIndex/matchIndex（Leader→每个Follower）</strong>：用来回退/追赶复制进度</li>
</ul>
</section>
<section id="角色的状态转移" class="slide level2 smaller">
<h2>角色的状态转移</h2>
<div class="columns">
<div class="column">
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<svg aria-roledescription="stateDiagram" role="graphics-document document" viewbox="0 0 168.48983764648438 422.1499938964844" style="; display: block; margin: auto auto auto auto" class="statediagram" xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="480" id="mermaid-figure-6" height="480">
<style>#mermaid-figure-6{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-figure-6 .error-icon{fill:#552222;}#mermaid-figure-6 .error-text{fill:#552222;stroke:#552222;}#mermaid-figure-6 .edge-thickness-normal{stroke-width:1px;}#mermaid-figure-6 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-figure-6 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-figure-6 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-figure-6 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-figure-6 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-figure-6 .marker{fill:#333333;stroke:#333333;}#mermaid-figure-6 .marker.cross{stroke:#333333;}#mermaid-figure-6 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-figure-6 p{margin:0;}#mermaid-figure-6 defs #statediagram-barbEnd{fill:#333333;stroke:#333333;}#mermaid-figure-6 g.stateGroup text{fill:#9370DB;stroke:none;font-size:10px;}#mermaid-figure-6 g.stateGroup text{fill:#333;stroke:none;font-size:10px;}#mermaid-figure-6 g.stateGroup .state-title{font-weight:bolder;fill:#131300;}#mermaid-figure-6 g.stateGroup rect{fill:#ECECFF;stroke:#9370DB;}#mermaid-figure-6 g.stateGroup line{stroke:#333333;stroke-width:1;}#mermaid-figure-6 .transition{stroke:#333333;stroke-width:1;fill:none;}#mermaid-figure-6 .stateGroup .composit{fill:white;border-bottom:1px;}#mermaid-figure-6 .stateGroup .alt-composit{fill:#e0e0e0;border-bottom:1px;}#mermaid-figure-6 .state-note{stroke:#aaaa33;fill:#fff5ad;}#mermaid-figure-6 .state-note text{fill:black;stroke:none;font-size:10px;}#mermaid-figure-6 .stateLabel .box{stroke:none;stroke-width:0;fill:#ECECFF;opacity:0.5;}#mermaid-figure-6 .edgeLabel .label rect{fill:#ECECFF;opacity:0.5;}#mermaid-figure-6 .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#mermaid-figure-6 .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#mermaid-figure-6 .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#mermaid-figure-6 .edgeLabel .label text{fill:#333;}#mermaid-figure-6 .label div .edgeLabel{color:#333;}#mermaid-figure-6 .stateLabel text{fill:#131300;font-size:10px;font-weight:bold;}#mermaid-figure-6 .node circle.state-start{fill:#333333;stroke:#333333;}#mermaid-figure-6 .node .fork-join{fill:#333333;stroke:#333333;}#mermaid-figure-6 .node circle.state-end{fill:#9370DB;stroke:white;stroke-width:1.5;}#mermaid-figure-6 .end-state-inner{fill:white;stroke-width:1.5;}#mermaid-figure-6 .node rect{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-figure-6 .node polygon{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-figure-6 #statediagram-barbEnd{fill:#333333;}#mermaid-figure-6 .statediagram-cluster rect{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-figure-6 .cluster-label,#mermaid-figure-6 .nodeLabel{color:#131300;}#mermaid-figure-6 .statediagram-cluster rect.outer{rx:5px;ry:5px;}#mermaid-figure-6 .statediagram-state .divider{stroke:#9370DB;}#mermaid-figure-6 .statediagram-state .title-state{rx:5px;ry:5px;}#mermaid-figure-6 .statediagram-cluster.statediagram-cluster .inner{fill:white;}#mermaid-figure-6 .statediagram-cluster.statediagram-cluster-alt .inner{fill:#f0f0f0;}#mermaid-figure-6 .statediagram-cluster .inner{rx:0;ry:0;}#mermaid-figure-6 .statediagram-state rect.basic{rx:5px;ry:5px;}#mermaid-figure-6 .statediagram-state rect.divider{stroke-dasharray:10,10;fill:#f0f0f0;}#mermaid-figure-6 .note-edge{stroke-dasharray:5;}#mermaid-figure-6 .statediagram-note rect{fill:#fff5ad;stroke:#aaaa33;stroke-width:1px;rx:0;ry:0;}#mermaid-figure-6 .statediagram-note rect{fill:#fff5ad;stroke:#aaaa33;stroke-width:1px;rx:0;ry:0;}#mermaid-figure-6 .statediagram-note text{fill:black;}#mermaid-figure-6 .statediagram-note .nodeLabel{color:black;}#mermaid-figure-6 .statediagram .edgeLabel{color:red;}#mermaid-figure-6 #dependencyStart,#mermaid-figure-6 #dependencyEnd{fill:#333333;stroke:#333333;stroke-width:1;}#mermaid-figure-6 .statediagramTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-figure-6 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style>
<g><defs><marker orient="auto" markerunits="userSpaceOnUse" markerheight="14" markerwidth="20" refy="7" refx="19" id="mermaid-figure-6-mermaid-1758125487282_stateDiagram-barbEnd"><path d="M 19,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><g class="root"><g class="clusters"></g><g class="edgePaths"><path marker-end="url(#mermaid-figure-6-mermaid-1758125487282_stateDiagram-barbEnd)" style=";fill:none" class="edge-thickness-normal edge-pattern-solid transition" id="edge0" d="M90.801,22L90.801,26.167C90.801,30.333,90.801,38.667,90.801,44.917C90.801,51.167,90.801,55.333,90.801,59.5C90.801,63.667,90.801,67.833,90.801,69.917L90.801,72"></path><path marker-end="url(#mermaid-figure-6-mermaid-1758125487282_stateDiagram-barbEnd)" style=";fill:none" class="edge-thickness-normal edge-pattern-solid transition" id="edge1" d="M113.781,112L120.867,118.167C127.952,124.333,142.123,136.667,147.033,145.917C151.942,155.167,147.59,161.333,143.238,167.5C138.886,173.667,134.534,179.833,132.358,182.917L130.182,186"></path><path style=";fill:none" class="edge-thickness-normal edge-pattern-solid transition" id="Candidate-cyclic-special-1" d="M129.812,226L134.05,232.167C138.288,238.333,146.765,250.667,151.003,261.579C155.241,272.492,155.241,281.983,155.241,291.475C155.241,300.967,155.241,310.458,155.241,315.204L155.241,319.95"></path><path style=";fill:none" class="edge-thickness-normal edge-pattern-solid transition" id="Candidate-cyclic-special-mid" d="M155.241,320.05L155.241,329.542C155.241,339.033,155.241,358.017,154.446,370.592C153.651,383.167,152.062,389.333,150.472,395.5C148.882,401.667,147.292,407.833,146.497,410.917L145.702,414"></path><path marker-end="url(#mermaid-figure-6-mermaid-1758125487282_stateDiagram-barbEnd)" style=";fill:none" class="edge-thickness-normal edge-pattern-solid transition" id="Candidate-cyclic-special-2" d="M145.655,414L141.411,407.833C137.167,401.667,128.679,389.333,124.435,373.667C120.191,358,120.191,339,120.191,320C120.191,301,120.191,282,119.968,269.417C119.745,256.833,119.299,250.667,118.853,244.5C118.406,238.333,117.96,232.167,117.737,229.083L117.514,226"></path><path marker-end="url(#mermaid-figure-6-mermaid-1758125487282_stateDiagram-barbEnd)" style=";fill:none" class="edge-thickness-normal edge-pattern-solid transition" id="edge3" d="M99.971,226L95.009,232.167C90.046,238.333,80.121,250.667,73.554,259.917C66.988,269.167,63.78,275.333,60.573,281.5C57.365,287.667,54.157,293.833,52.554,296.917L50.95,300"></path><path marker-end="url(#mermaid-figure-6-mermaid-1758125487282_stateDiagram-barbEnd)" style=";fill:none" class="edge-thickness-normal edge-pattern-solid transition" id="edge4" d="M107.201,186L104.468,179.833C101.734,173.667,96.268,161.333,93.534,152.083C90.801,142.833,90.801,136.667,90.801,130.5C90.801,124.333,90.801,118.167,90.801,115.083L90.801,112"></path><path marker-end="url(#mermaid-figure-6-mermaid-1758125487282_stateDiagram-barbEnd)" style=";fill:none" class="edge-thickness-normal edge-pattern-solid transition" id="edge5" d="M36.302,300L34.993,293.833C33.684,287.667,31.067,275.333,29.758,259.667C28.449,244,28.449,225,28.449,206C28.449,187,28.449,168,31.822,155.417C35.195,142.833,41.94,136.667,48.686,130.5C55.432,124.333,62.177,118.167,65.55,115.083L68.923,112"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0">
<div class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" data-xmlns="http://www.w3.org/1999/xhtml">
<span class="edgeLabel"></span>
</div>
</foreignobject></g></g><g transform="translate(156.29453125037253, 149)" class="edgeLabel"><g transform="translate(-4.1953125, -12)" class="label"><foreignobject height="24" width="8.390625">
<div class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" data-xmlns="http://www.w3.org/1999/xhtml">
<span class="edgeLabel">
<p>
1
</p>
</span>
</div>
</foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0">
<div class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" data-xmlns="http://www.w3.org/1999/xhtml">
<span class="edgeLabel"></span>
</div>
</foreignobject></g></g><g transform="translate(155.24140625074506, 377)" class="edgeLabel"><g transform="translate(-4.1953125, -12)" class="label"><foreignobject height="24" width="8.390625">
<div class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" data-xmlns="http://www.w3.org/1999/xhtml">
<span class="edgeLabel">
<p>
2
</p>
</span>
</div>
</foreignobject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignobject height="0" width="0">
<div class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" data-xmlns="http://www.w3.org/1999/xhtml">
<span class="edgeLabel"></span>
</div>
</foreignobject></g></g><g transform="translate(70.1953125, 263)" class="edgeLabel"><g transform="translate(-4.1953125, -12)" class="label"><foreignobject height="24" width="8.390625">
<div class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" data-xmlns="http://www.w3.org/1999/xhtml">
<span class="edgeLabel">
<p>
3
</p>
</span>
</div>
</foreignobject></g></g><g transform="translate(90.80078125, 149)" class="edgeLabel"><g transform="translate(-21.2109375, -12)" class="label"><foreignobject height="24" width="42.421875">
<div class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" data-xmlns="http://www.w3.org/1999/xhtml">
<span class="edgeLabel">
<p>
4 或 5
</p>
</span>
</div>
</foreignobject></g></g><g transform="translate(28.44921875, 206)" class="edgeLabel"><g transform="translate(-4.1953125, -12)" class="label"><foreignobject height="24" width="8.390625">
<div class="labelBkg" style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" data-xmlns="http://www.w3.org/1999/xhtml">
<span class="edgeLabel">
<p>
4
</p>
</span>
</div>
</foreignobject></g></g></g><g class="nodes"><g transform="translate(90.80078125, 15)" id="state-root_start-0" class="node default"><circle height="14" width="14" r="7" class="state-start"></circle></g><g transform="translate(90.80078125, 92)" id="state-Follower-5" class="node  statediagram-state"><rect height="40" width="77.859375" y="-20" x="-38.9296875" ry="5" data-et="node" data-id="abc" rx="5" style="" class="basic label-container"></rect><g transform="translate(-30.9296875, -12)" style="" class="label"><rect></rect><foreignobject height="24" width="61.859375">
<div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" data-xmlns="http://www.w3.org/1999/xhtml">
<span class="nodeLabel">
<p>
Follower
</p>
</span>
</div>
</foreignobject></g></g><g transform="translate(116.06640625, 206)" id="state-Candidate-4" class="node  statediagram-state"><rect height="40" width="88.59375" y="-20" x="-44.296875" ry="5" data-et="node" data-id="abc" rx="5" style="" class="basic label-container"></rect><g transform="translate(-36.296875, -12)" style="" class="label"><rect></rect><foreignobject height="24" width="72.59375">
<div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" data-xmlns="http://www.w3.org/1999/xhtml">
<span class="nodeLabel">
<p>
Candidate
</p>
</span>
</div>
</foreignobject></g></g><g transform="translate(40.546875, 320)" id="state-Leader-5" class="node  statediagram-state"><rect height="40" width="65.09375" y="-20" x="-32.546875" ry="5" data-et="node" data-id="abc" rx="5" style="" class="basic label-container"></rect><g transform="translate(-24.546875, -12)" style="" class="label"><rect></rect><foreignobject height="24" width="49.09375">
<div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;" data-xmlns="http://www.w3.org/1999/xhtml">
<span class="nodeLabel">
<p>
Leader
</p>
</span>
</div>
</foreignobject></g></g><g transform="translate(155.24140625074506, 320)" id="Candidate---Candidate---1" class="label edgeLabel"><rect height="0.1" width="0.1"></rect><g transform="translate(0, 0)" style="" class="label"><rect></rect><foreignobject height="0" width="0">
<div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 10px; text-align: center;" data-xmlns="http://www.w3.org/1999/xhtml">
<span class="nodeLabel"></span>
</div>
</foreignobject></g></g><g transform="translate(145.68906250037253, 414.05000000074506)" id="Candidate---Candidate---2" class="label edgeLabel"><rect height="0.1" width="0.1"></rect><g transform="translate(0, 0)" style="" class="label"><rect></rect><foreignobject height="0" width="0">
<div style="display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 10px; text-align: center;" data-xmlns="http://www.w3.org/1999/xhtml">
<span class="nodeLabel"></span>
</div>
</foreignobject></g></g></g></g></g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div><div class="column">
<p>各角色主要工作</p>
<ul>
<li><strong>Follower</strong>：被动接收，按 Leader 指令执行</li>
<li><strong>Candidate</strong>：发起拉票</li>
<li><strong>Leader</strong>：发心跳、发日志、推进提交</li>
</ul>
<p><strong>状态转移条件</strong></p>
<ol type="1">
<li>收到选举超时信号</li>
<li>选举超时而开始新一轮选举</li>
<li>获得大多数节点的投票</li>
<li>发现任期更高Leader</li>
<li>收到其他Candidate的心跳</li>
</ol>
</div></div>
</section>
<section id="选举触发与随机超时" class="slide level2 smaller">
<h2>选举触发与随机超时</h2>
<ul>
<li>每个 Follower 设置<strong>随机选举超时</strong>（如 150–300ms）</li>
<li>在超时前如果<strong>收到 Leader 心跳</strong>（AppendEntries），就<strong>重置</strong>计时器</li>
<li>超时后变 <strong>Candidate</strong>，<code>term += 1</code>，给所有人发 <strong>RequestVote</strong></li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>注记</strong></p>
</div>
<div class="callout-content">
<p>由随机超时决定<strong>谁先喊我当组长</strong>，减少<strong>同时喊</strong>导致的冲突</p>
</div>
</div>
</div>
</section>
<section id="投票规则requestvote" class="slide level2 smaller">
<h2>投票规则（RequestVote）</h2>
<ul>
<li><p><strong>单任期一票</strong>：<code>voted_for</code> 限制</p></li>
<li><p><strong>任期比较</strong>：落后任期的请求一律拒绝</p></li>
<li><p><strong>日志新鲜度</strong>：候选人的<strong>最后一条日志</strong>必须不比自己旧</p>
<ol type="1">
<li>先比<strong>term</strong></li>
<li>若相等再比<strong>index</strong></li>
</ol></li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>注记</strong></p>
</div>
<div class="callout-content">
<p><strong>只把票投给“作业最完整的同学”</strong>当组长，否则容易带崩全组的对齐进度</p>
</div>
</div>
</div>
</section>
<section id="日志复制appendentries" class="slide level2 smaller">
<h2>日志复制（AppendEntries）</h2>
<ul>
<li><p>Leader 携带 <code>prevLogIndex/prevLogTerm</code> 与若干 <code>entries</code>：</p>
<ol type="1">
<li>Leader 接到客户端写请求 → 先把命令<strong>追加</strong>（append）到自己的日志</li>
<li>向 Follower 发送 <code>AppendEntries(term, prevLogIndex, prevLogTerm, entries, leaderCommit)</code></li>
</ol></li>
<li><p>Follower 做<strong>一致性检查</strong>：</p>
<ol type="1">
<li>如果我在 <code>prevLogIndex</code> 的 term 和你发来的<strong>不一致</strong>则产生<strong>冲突</strong>，我<strong>回退</strong></li>
<li>否则才<strong>追加</strong>新条目</li>
</ol></li>
<li><p>多数副本<strong>追加成功</strong>则 Leader <strong>提升 <code>commitIndex</code></strong>，再<strong>应用</strong>到状态机，并通知 Follower 提交</p></li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>注记</strong></p>
</div>
<div class="callout-content">
<p><strong>对齐参照点</strong>再抄后续步骤。找到大家都确认的“同一行”，从这一行往后统一写</p>
</div>
</div>
</div>
</section>
<section id="日志复制图示" class="slide level2">
<h2>日志复制图示</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<svg aria-roledescription="sequence" role="graphics-document document" viewbox="-50 -10 1097 654" style="; display: block; margin: auto auto auto auto" xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="960" id="mermaid-figure-5" height="480">
<g><rect class="actor actor-bottom" ry="3" rx="3" name="F2" height="65" width="150" stroke="#666" fill="#eaeaea" y="568" x="847"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="600.5" x="922"><tspan dy="0" x="922">Follower2</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="F1" height="65" width="150" stroke="#666" fill="#eaeaea" y="568" x="647"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="600.5" x="722"><tspan dy="0" x="722">Follower1</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="L" height="65" width="150" stroke="#666" fill="#eaeaea" y="568" x="200"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="600.5" x="275"><tspan dy="0" x="275">Leader</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="C" height="65" width="150" stroke="#666" fill="#eaeaea" y="568" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="600.5" x="75"><tspan dy="0" x="75">Client</tspan></text></g><g><line name="F2" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="568" x2="922" y1="5" x1="922" id="actor3"></line><g id="root-3"><rect class="actor actor-top" ry="3" rx="3" name="F2" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="847"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="922"><tspan dy="0" x="922">Follower2</tspan></text></g></g><g><line name="F1" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="568" x2="722" y1="5" x1="722" id="actor2"></line><g id="root-2"><rect class="actor actor-top" ry="3" rx="3" name="F1" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="647"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="722"><tspan dy="0" x="722">Follower1</tspan></text></g></g><g><line name="L" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="568" x2="275" y1="5" x1="275" id="actor1"></line><g id="root-1"><rect class="actor actor-top" ry="3" rx="3" name="L" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="200"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="275"><tspan dy="0" x="275">Leader</tspan></text></g></g><g><line name="C" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="568" x2="75" y1="5" x1="75" id="actor0"></line><g id="root-0"><rect class="actor actor-top" ry="3" rx="3" name="C" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="75"><tspan dy="0" x="75">Client</tspan></text></g></g>
<style>#mermaid-figure-5{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-figure-5 .error-icon{fill:#552222;}#mermaid-figure-5 .error-text{fill:#552222;stroke:#552222;}#mermaid-figure-5 .edge-thickness-normal{stroke-width:1px;}#mermaid-figure-5 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-figure-5 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-figure-5 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-figure-5 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-figure-5 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-figure-5 .marker{fill:#333333;stroke:#333333;}#mermaid-figure-5 .marker.cross{stroke:#333333;}#mermaid-figure-5 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-figure-5 p{margin:0;}#mermaid-figure-5 .actor{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-5 text.actor>tspan{fill:black;stroke:none;}#mermaid-figure-5 .actor-line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-5 .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaid-figure-5 .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaid-figure-5 #mermaid-figure-5-arrowhead path{fill:#333;stroke:#333;}#mermaid-figure-5 .sequenceNumber{fill:white;}#mermaid-figure-5 #mermaid-figure-5-sequencenumber{fill:#333;}#mermaid-figure-5 #mermaid-figure-5-crosshead path{fill:#333;stroke:#333;}#mermaid-figure-5 .messageText{fill:#333;stroke:none;}#mermaid-figure-5 .labelBox{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-5 .labelText,#mermaid-figure-5 .labelText>tspan{fill:black;stroke:none;}#mermaid-figure-5 .loopText,#mermaid-figure-5 .loopText>tspan{fill:black;stroke:none;}#mermaid-figure-5 .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-5 .note{stroke:#aaaa33;fill:#fff5ad;}#mermaid-figure-5 .noteText,#mermaid-figure-5 .noteText>tspan{fill:black;stroke:none;}#mermaid-figure-5 .activation0{fill:#f4f4f4;stroke:#666;}#mermaid-figure-5 .activation1{fill:#f4f4f4;stroke:#666;}#mermaid-figure-5 .activation2{fill:#f4f4f4;stroke:#666;}#mermaid-figure-5 .actorPopupMenu{position:absolute;}#mermaid-figure-5 .actorPopupMenuPanel{position:absolute;fill:#ECECFF;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);filter:drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4));}#mermaid-figure-5 .actor-man line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-5 .actor-man circle,#mermaid-figure-5 line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;stroke-width:2px;}#mermaid-figure-5 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style>
<g></g><defs><symbol height="24" width="24" id="mermaid-figure-5-computer"><path d="M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z" transform="scale(.5)"></path></symbol></defs><defs><symbol clip-rule="evenodd" fill-rule="evenodd" id="mermaid-figure-5-database"><path d="M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z" transform="scale(.5)"></path></symbol></defs><defs><symbol height="24" width="24" id="mermaid-figure-5-clock"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z" transform="scale(.5)"></path></symbol></defs><defs><marker orient="auto-start-reverse" markerheight="12" markerwidth="12" markerunits="userSpaceOnUse" refy="5" refx="7.9" id="mermaid-figure-5-arrowhead"><path d="M -1 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker refy="4.5" refx="4" orient="auto" markerheight="8" markerwidth="15" id="mermaid-figure-5-crosshead"><path style="stroke-dasharray: 0, 0;" d="M 1,2 L 6,7 M 6,2 L 1,7" stroke-width="1pt" stroke="#000000" fill="none"></path></marker></defs><defs><marker orient="auto" markerheight="28" markerwidth="20" refy="7" refx="15.5" id="mermaid-figure-5-filled-head"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerheight="40" markerwidth="60" refy="15" refx="15" id="mermaid-figure-5-sequencenumber"><circle r="6" cy="15" cx="15"></circle></marker></defs><g><line class="loopLine" y2="197" x2="933" y1="197" x1="264"></line><line class="loopLine" y2="334" x2="933" y1="197" x1="933"></line><line class="loopLine" y2="334" x2="933" y1="334" x1="264"></line><line class="loopLine" y2="334" x2="264" y1="197" x1="264"></line><polygon class="labelBox" points="264,197 314,197 314,210 305.6,217 264,217"></polygon><text style="font-size: 16px; font-weight: 400;" class="labelText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="210" x="289">par</text><text style="font-size: 16px; font-weight: 400;" class="loopText" text-anchor="middle" y="215" x="623.5"><tspan x="623.5">[并行复制]</tspan></text></g><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="80" x="174">写请求(cmd)</text><line style="fill: none;" marker-end="url(#mermaid-figure-5-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="111" x2="271" y1="111" x1="76"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="126" x="276">追加日志[term=t, cmd]</text><path style="fill: none;" marker-end="url(#mermaid-figure-5-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 276,157 C 336,147 336,187 276,177"></path><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="247" x="497">AppendEntries(prevIdx, prevTerm, [entry], leaderCommit)</text><line style="fill: none;" marker-end="url(#mermaid-figure-5-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="278" x2="718" y1="278" x1="276"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="293" x="597">AppendEntries(prevIdx, prevTerm, [entry], leaderCommit)</text><line style="fill: none;" marker-end="url(#mermaid-figure-5-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="324" x2="918" y1="324" x1="276"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="349" x="500">成功/失败(带回退线索)</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-end="url(#mermaid-figure-5-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="380" x2="279" y1="380" x1="721"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="395" x="600">成功</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-end="url(#mermaid-figure-5-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="426" x2="279" y1="426" x1="921"></line><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="441" x="276">收到多数成功 → 提交、应用</text><path style="fill: none;" marker-end="url(#mermaid-figure-5-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 276,472 C 336,462 336,502 276,492"></path><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="517" x="177">成功回执</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-end="url(#mermaid-figure-5-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="548" x2="79" y1="548" x1="274"></line>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="日志匹配与-leader-完全性" class="slide level2 smaller">
<h2>日志匹配与 Leader 完全性</h2>
<ul>
<li><strong>日志匹配性质</strong>：两个日志在某索引 <code>i</code> 处的 <code>term</code> 相同 → 它们在 <code>i</code> 及之前完全一致</li>
<li><strong>领导者完全性（Leader Completeness）</strong>：任何已提交的条目<strong>必定</strong>出现在<strong>后续</strong>当选的 Leader 的日志中</li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>注记</strong></p>
</div>
<div class="callout-content">
<p>“抄到第 50 行并被多数同学确认”的内容，下一届组长上任后也必须至少抄到第 50 行，否则他拿不到票</p>
</div>
</div>
</div>
</section>
<section id="提交规则与当前任期定稿" class="slide level2 smaller">
<h2>提交规则与“当前任期”定稿</h2>
<ul>
<li><p>Leader 将 <code>commitIndex</code> 推进到<strong>某个索引 <code>N</code></strong> 当且仅当：</p>
<ol type="1">
<li>有<strong>多数</strong>节点的 <code>matchIndex ≥ N</code>，且</li>
<li>日志条目<strong>属于当前任期</strong><code>log[N].term == currentTerm</code></li>
</ol></li>
<li><p>这样避免“上一任期的条目<strong>看似</strong>多数复制，但后来被覆盖”的<strong>假提交</strong>。</p></li>
</ul>
<blockquote>
<p>正确做法：先在<strong>当前任期</strong>追加一个“锚点”条目并复制到多数，再<strong>连带</strong>确认之前的条目都安全</p>
</blockquote>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>注记</strong></p>
</div>
<div class="callout-content">
<p><strong>本届组长</strong>只对<strong>本届提交</strong>负责；上一届遗留的内容，需要先写出本届新内容并多数确认，再连带前文一起认定为“最终版”</p>
</div>
</div>
</div>
</section>
<section id="同步复制-vs-异步复制" class="slide level2 smaller">
<h2>同步复制 vs 异步复制</h2>
<table class="caption-top" style="width:100%;">
<colgroup>
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header">
<th>复制模式</th>
<th>确认时机</th>
<th>延迟</th>
<th>可用性</th>
<th>数据丢失窗口</th>
<th>典型风险</th>
<th>常见场景</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>异步（本地 Ack）</strong></td>
<td>Leader 本地写入日志/存储即返回</td>
<td>低</td>
<td>高（对慢副本不敏感）</td>
<td>可能 &gt; 0（Leader 在复制前宕机会丢“已确认”写）</td>
<td>主从切换后<strong>已确认写丢失</strong></td>
<td>跨地域追赶型只读副本、分析副本</td>
</tr>
<tr class="even">
<td><strong>多数派同步（Quorum）</strong></td>
<td><strong>达到多数副本</strong>写入成功再返回</td>
<td>中</td>
<td>中（≥多数可用）</td>
<td><strong>≈0（≤f 故障）</strong></td>
<td>少数派落后但不影响安全</td>
<td>大多数共识系统的<strong>默认</strong></td>
</tr>
<tr class="odd">
<td><strong>全同步</strong></td>
<td><strong>全部副本</strong>写入成功再返回</td>
<td>高</td>
<td>低</td>
<td>0</td>
<td>容错性差、抖动放大</td>
<td>强一致但低吞吐小集群</td>
</tr>
</tbody>
</table>
</section>
<section id="客户端交互" class="slide level2 smaller">
<h2>客户端交互</h2>
<ul>
<li><p>写请求：</p>
<ul>
<li>所有写请求<strong>只发 Leader</strong>（把作业交给组长统一记录）</li>
<li>Leader 在<strong>提交后</strong>向客户端回执，保证<strong>线性一致</strong>的可见性</li>
</ul></li>
<li><p>读请求：</p>
<ul>
<li>快速读：基于租约/心跳的新鲜度</li>
<li><strong>读在心跳后</strong>（严格线性）：Leader 通过心跳或 <code>ReadIndex</code> 确保自己仍为多数认可的 Leader</li>
<li><strong>先写后读</strong>：在读之前提交一个空日志（成本较高）</li>
</ul></li>
</ul>
</section>
<section id="网络分区与脑裂" class="slide level2 smaller">
<h2>网络分区与脑裂</h2>
<ul>
<li>多数派原则：<strong>只有包含多数的分区</strong>可以继续选出 Leader 并对外服务</li>
<li>少数派：不断超时 → 发起选举 → 得不到多数 → <strong>保持 Follower/Candidate 徘徊</strong></li>
<li>待到分区恢复后：较小分区通过 <strong>Log Matching</strong> 与当前 Leader <strong>回放对齐</strong></li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>注记</strong></p>
</div>
<div class="callout-content">
<p>抄作业小组分到两间教室，人数多的那间能继续“有效投票”。合并后，以<strong>多数派定稿</strong>为准，组长带领大家对齐</p>
</div>
</div>
</div>
</section>
<section id="成员变更-快照" class="slide level2 smaller">
<h2>成员变更 &amp; 快照</h2>
<ul>
<li>成员变更常用<strong>联合共识（Joint Consensus）</strong>两阶段过渡，保证每一步都有<strong>交叠多数</strong></li>
<li>快照：压缩旧日志（像把“抄到第 500 行”的内容装订成册），从快照点继续</li>
<li>快照复制 = <strong>状态复制</strong>的一种；与日志复制并行互补</li>
</ul>
</section>
<section id="工程取舍" class="slide level2 smaller">
<h2>工程取舍</h2>
<ul>
<li>Paxos 抽象简洁，但多值/成员变更等<strong>工程化复杂度高</strong></li>
<li>Raft <strong>把工程问题前置入规范</strong>，实现更直接</li>
</ul>
<table class="caption-top">
<thead>
<tr class="header">
<th>方面</th>
<th>Raft</th>
<th>Paxos</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>心智负担</td>
<td>低，直观</td>
<td>高，抽象</td>
</tr>
<tr class="even">
<td>领导者</td>
<td>强 Leader，职责清晰</td>
<td>可无固定 Leader</td>
</tr>
<tr class="odd">
<td>日志</td>
<td>严格顺序对齐</td>
<td>更偏值的选举与传播</td>
</tr>
<tr class="even">
<td>提交规则</td>
<td>当前任期多数更安全</td>
<td>需自行处理同等语义</td>
</tr>
<tr class="odd">
<td>成员变更</td>
<td>联合共识步骤明确</td>
<td>实践复杂，需额外构造</td>
</tr>
<tr class="even">
<td>工程实现</td>
<td>文档 &amp; 开源实现丰富</td>
<td>概念简洁，偏学术研究</td>
</tr>
</tbody>
</table>
</section>
<section id="银行转账案例" class="slide level2">
<h2>银行转账案例</h2>
<p>设集群有 3节点：Leader <strong>L</strong>、Follower <strong>F1</strong> 和 <strong>F2</strong>。当前 <strong>Term=12</strong>，之前已提交到 <strong>index=41</strong>。</p>
<p>客户端发起转账操作 <code>transfer(A→B, 100)</code> 作为日志条目 <strong>index=42, term=12</strong>。</p>
</section>
<section id="raft-多数派同步" class="slide level2">
<h2>Raft 多数派同步</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<svg aria-roledescription="sequence" role="graphics-document document" viewbox="-50 -10 1032 770" style="; display: block; margin: auto auto auto auto" xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="960" id="mermaid-figure-4" height="480">
<g><rect class="actor actor-bottom" ry="3" rx="3" name="F2" height="65" width="150" stroke="#666" fill="#eaeaea" y="684" x="781"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="716.5" x="856"><tspan dy="0" x="856">F2</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="F1" height="65" width="150" stroke="#666" fill="#eaeaea" y="684" x="581"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="716.5" x="656"><tspan dy="0" x="656">F1</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="L" height="65" width="150" stroke="#666" fill="#eaeaea" y="684" x="254"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="716.5" x="329"><tspan dy="0" x="329">L (Term 12)</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="C" height="65" width="150" stroke="#666" fill="#eaeaea" y="684" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="716.5" x="75"><tspan dy="0" x="75">Client</tspan></text></g><g><line name="F2" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="684" x2="856" y1="5" x1="856" id="actor3"></line><g id="root-3"><rect class="actor actor-top" ry="3" rx="3" name="F2" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="781"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="856"><tspan dy="0" x="856">F2</tspan></text></g></g><g><line name="F1" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="684" x2="656" y1="5" x1="656" id="actor2"></line><g id="root-2"><rect class="actor actor-top" ry="3" rx="3" name="F1" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="581"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="656"><tspan dy="0" x="656">F1</tspan></text></g></g><g><line name="L" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="684" x2="329" y1="5" x1="329" id="actor1"></line><g id="root-1"><rect class="actor actor-top" ry="3" rx="3" name="L" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="254"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="329"><tspan dy="0" x="329">L (Term 12)</tspan></text></g></g><g><line name="C" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="684" x2="75" y1="5" x1="75" id="actor0"></line><g id="root-0"><rect class="actor actor-top" ry="3" rx="3" name="C" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="75"><tspan dy="0" x="75">Client</tspan></text></g></g>
<style>#mermaid-figure-4{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-figure-4 .error-icon{fill:#552222;}#mermaid-figure-4 .error-text{fill:#552222;stroke:#552222;}#mermaid-figure-4 .edge-thickness-normal{stroke-width:1px;}#mermaid-figure-4 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-figure-4 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-figure-4 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-figure-4 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-figure-4 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-figure-4 .marker{fill:#333333;stroke:#333333;}#mermaid-figure-4 .marker.cross{stroke:#333333;}#mermaid-figure-4 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-figure-4 p{margin:0;}#mermaid-figure-4 .actor{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-4 text.actor>tspan{fill:black;stroke:none;}#mermaid-figure-4 .actor-line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-4 .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaid-figure-4 .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaid-figure-4 #mermaid-figure-4-arrowhead path{fill:#333;stroke:#333;}#mermaid-figure-4 .sequenceNumber{fill:white;}#mermaid-figure-4 #mermaid-figure-4-sequencenumber{fill:#333;}#mermaid-figure-4 #mermaid-figure-4-crosshead path{fill:#333;stroke:#333;}#mermaid-figure-4 .messageText{fill:#333;stroke:none;}#mermaid-figure-4 .labelBox{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-4 .labelText,#mermaid-figure-4 .labelText>tspan{fill:black;stroke:none;}#mermaid-figure-4 .loopText,#mermaid-figure-4 .loopText>tspan{fill:black;stroke:none;}#mermaid-figure-4 .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-4 .note{stroke:#aaaa33;fill:#fff5ad;}#mermaid-figure-4 .noteText,#mermaid-figure-4 .noteText>tspan{fill:black;stroke:none;}#mermaid-figure-4 .activation0{fill:#f4f4f4;stroke:#666;}#mermaid-figure-4 .activation1{fill:#f4f4f4;stroke:#666;}#mermaid-figure-4 .activation2{fill:#f4f4f4;stroke:#666;}#mermaid-figure-4 .actorPopupMenu{position:absolute;}#mermaid-figure-4 .actorPopupMenuPanel{position:absolute;fill:#ECECFF;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);filter:drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4));}#mermaid-figure-4 .actor-man line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-4 .actor-man circle,#mermaid-figure-4 line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;stroke-width:2px;}#mermaid-figure-4 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style>
<g></g><defs><symbol height="24" width="24" id="mermaid-figure-4-computer"><path d="M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z" transform="scale(.5)"></path></symbol></defs><defs><symbol clip-rule="evenodd" fill-rule="evenodd" id="mermaid-figure-4-database"><path d="M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z" transform="scale(.5)"></path></symbol></defs><defs><symbol height="24" width="24" id="mermaid-figure-4-clock"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z" transform="scale(.5)"></path></symbol></defs><defs><marker orient="auto-start-reverse" markerheight="12" markerwidth="12" markerunits="userSpaceOnUse" refy="5" refx="7.9" id="mermaid-figure-4-arrowhead"><path d="M -1 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker refy="4.5" refx="4" orient="auto" markerheight="8" markerwidth="15" id="mermaid-figure-4-crosshead"><path style="stroke-dasharray: 0, 0;" d="M 1,2 L 6,7 M 6,2 L 1,7" stroke-width="1pt" stroke="#000000" fill="none"></path></marker></defs><defs><marker orient="auto" markerheight="28" markerwidth="20" refy="7" refx="15.5" id="mermaid-figure-4-filled-head"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerheight="40" markerwidth="60" refy="15" refx="15" id="mermaid-figure-4-sequencenumber"><circle r="6" cy="15" cx="15"></circle></marker></defs><g><rect class="note" height="39" width="210" stroke="#666" fill="#EDF2AE" y="335" x="224"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="340" x="329"><tspan x="329">获得多数复制 (L 自身 + F1)</tspan></text></g><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="80" x="201">propose transfer(A→B,100)</text><line style="fill: none;" marker-start="url(#mermaid-figure-4-sequencenumber)" marker-end="url(#mermaid-figure-4-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="111" x2="325" y1="111" x1="76"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="115" x="76">1</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="126" x="330">log.append(term=12, idx=42, cmd)</text><path style="fill: none;" marker-start="url(#mermaid-figure-4-sequencenumber)" marker-end="url(#mermaid-figure-4-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 330,157 C 390,147 390,187 330,177"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="161" x="330">2</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="202" x="491">AppendEntries(prev=41, term=12, [42])</text><line style="fill: none;" marker-start="url(#mermaid-figure-4-sequencenumber)" marker-end="url(#mermaid-figure-4-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="233" x2="652" y1="233" x1="330"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="237" x="330">3</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="248" x="591">AppendEntries(prev=41, term=12, [42])</text><line style="fill: none;" marker-start="url(#mermaid-figure-4-sequencenumber)" marker-end="url(#mermaid-figure-4-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="279" x2="852" y1="279" x1="330"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="283" x="330">4</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="294" x="494">AppendOK(match=42)</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-4-sequencenumber)" marker-end="url(#mermaid-figure-4-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="325" x2="333" y1="325" x1="655"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="329" x="655">5</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="389" x="330">commitIndex=42 apply(A -= 100 &amp; B += 100)</text><path style="fill: none;" marker-start="url(#mermaid-figure-4-sequencenumber)" marker-end="url(#mermaid-figure-4-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 330,420 C 390,410 390,450 330,440"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="424" x="330">6</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="465" x="204">OK(txid=T2025-0917-0001)</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-4-sequencenumber)" marker-end="url(#mermaid-figure-4-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="496" x2="79" y1="496" x1="328"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="500" x="328">7</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="511" x="594">AppendOK(match=42) (网络延迟后到达)</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-4-sequencenumber)" marker-end="url(#mermaid-figure-4-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="542" x2="333" y1="542" x1="855"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="546" x="855">8</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="557" x="591">Heartbeat/CommitNotice(leaderCommit=42)</text><line style="fill: none;" marker-start="url(#mermaid-figure-4-sequencenumber)" marker-end="url(#mermaid-figure-4-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="588" x2="852" y1="588" x1="330"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="592" x="330">9</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="603" x="857">apply idx=42</text><path style="fill: none;" marker-start="url(#mermaid-figure-4-sequencenumber)" marker-end="url(#mermaid-figure-4-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 857,634 C 917,624 917,664 857,654"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="638" x="857">10</text>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="全同步版本" class="slide level2">
<h2>全同步版本</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<svg aria-roledescription="sequence" role="graphics-document document" viewbox="-50 -10 1031 846" style="; display: block; margin: auto auto auto auto" xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="960" id="mermaid-figure-3" height="480">
<g><rect class="actor actor-bottom" ry="3" rx="3" name="F2" height="65" width="150" stroke="#666" fill="#eaeaea" y="760" x="781"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="792.5" x="856"><tspan dy="0" x="856">F2</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="F1" height="65" width="150" stroke="#666" fill="#eaeaea" y="760" x="581"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="792.5" x="656"><tspan dy="0" x="656">F1</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="L" height="65" width="150" stroke="#666" fill="#eaeaea" y="760" x="254"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="792.5" x="329"><tspan dy="0" x="329">L (Term 12)</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="C" height="65" width="150" stroke="#666" fill="#eaeaea" y="760" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="792.5" x="75"><tspan dy="0" x="75">Client</tspan></text></g><g><line name="F2" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="760" x2="856" y1="5" x1="856" id="actor3"></line><g id="root-3"><rect class="actor actor-top" ry="3" rx="3" name="F2" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="781"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="856"><tspan dy="0" x="856">F2</tspan></text></g></g><g><line name="F1" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="760" x2="656" y1="5" x1="656" id="actor2"></line><g id="root-2"><rect class="actor actor-top" ry="3" rx="3" name="F1" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="581"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="656"><tspan dy="0" x="656">F1</tspan></text></g></g><g><line name="L" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="760" x2="329" y1="5" x1="329" id="actor1"></line><g id="root-1"><rect class="actor actor-top" ry="3" rx="3" name="L" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="254"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="329"><tspan dy="0" x="329">L (Term 12)</tspan></text></g></g><g><line name="C" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="760" x2="75" y1="5" x1="75" id="actor0"></line><g id="root-0"><rect class="actor actor-top" ry="3" rx="3" name="C" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="75"><tspan dy="0" x="75">Client</tspan></text></g></g>
<style>#mermaid-figure-3{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-figure-3 .error-icon{fill:#552222;}#mermaid-figure-3 .error-text{fill:#552222;stroke:#552222;}#mermaid-figure-3 .edge-thickness-normal{stroke-width:1px;}#mermaid-figure-3 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-figure-3 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-figure-3 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-figure-3 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-figure-3 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-figure-3 .marker{fill:#333333;stroke:#333333;}#mermaid-figure-3 .marker.cross{stroke:#333333;}#mermaid-figure-3 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-figure-3 p{margin:0;}#mermaid-figure-3 .actor{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-3 text.actor>tspan{fill:black;stroke:none;}#mermaid-figure-3 .actor-line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-3 .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaid-figure-3 .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaid-figure-3 #mermaid-figure-3-arrowhead path{fill:#333;stroke:#333;}#mermaid-figure-3 .sequenceNumber{fill:white;}#mermaid-figure-3 #mermaid-figure-3-sequencenumber{fill:#333;}#mermaid-figure-3 #mermaid-figure-3-crosshead path{fill:#333;stroke:#333;}#mermaid-figure-3 .messageText{fill:#333;stroke:none;}#mermaid-figure-3 .labelBox{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-3 .labelText,#mermaid-figure-3 .labelText>tspan{fill:black;stroke:none;}#mermaid-figure-3 .loopText,#mermaid-figure-3 .loopText>tspan{fill:black;stroke:none;}#mermaid-figure-3 .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-3 .note{stroke:#aaaa33;fill:#fff5ad;}#mermaid-figure-3 .noteText,#mermaid-figure-3 .noteText>tspan{fill:black;stroke:none;}#mermaid-figure-3 .activation0{fill:#f4f4f4;stroke:#666;}#mermaid-figure-3 .activation1{fill:#f4f4f4;stroke:#666;}#mermaid-figure-3 .activation2{fill:#f4f4f4;stroke:#666;}#mermaid-figure-3 .actorPopupMenu{position:absolute;}#mermaid-figure-3 .actorPopupMenuPanel{position:absolute;fill:#ECECFF;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);filter:drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4));}#mermaid-figure-3 .actor-man line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-3 .actor-man circle,#mermaid-figure-3 line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;stroke-width:2px;}#mermaid-figure-3 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style>
<g></g><defs><symbol height="24" width="24" id="mermaid-figure-3-computer"><path d="M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z" transform="scale(.5)"></path></symbol></defs><defs><symbol clip-rule="evenodd" fill-rule="evenodd" id="mermaid-figure-3-database"><path d="M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z" transform="scale(.5)"></path></symbol></defs><defs><symbol height="24" width="24" id="mermaid-figure-3-clock"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z" transform="scale(.5)"></path></symbol></defs><defs><marker orient="auto-start-reverse" markerheight="12" markerwidth="12" markerunits="userSpaceOnUse" refy="5" refx="7.9" id="mermaid-figure-3-arrowhead"><path d="M -1 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker refy="4.5" refx="4" orient="auto" markerheight="8" markerwidth="15" id="mermaid-figure-3-crosshead"><path style="stroke-dasharray: 0, 0;" d="M 1,2 L 6,7 M 6,2 L 1,7" stroke-width="1pt" stroke="#000000" fill="none"></path></marker></defs><defs><marker orient="auto" markerheight="28" markerwidth="20" refy="7" refx="15.5" id="mermaid-figure-3-filled-head"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerheight="40" markerwidth="60" refy="15" refx="15" id="mermaid-figure-3-sequencenumber"><circle r="6" cy="15" cx="15"></circle></marker></defs><g><rect class="note" height="39" width="206" stroke="#666" fill="#EDF2AE" y="335" x="226"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="340" x="329"><tspan x="329">F1 已就绪，但仍需等待 F2</tspan></text></g><g><rect class="note" height="39" width="280" stroke="#666" fill="#EDF2AE" y="642" x="189"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="647" x="329"><tspan x="329">由于 ALL 策略，L 不得向客户端确认</tspan></text></g><g><rect class="note" height="39" width="304" stroke="#666" fill="#EDF2AE" y="691" x="50"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="696" x="202"><tspan x="202">用户请求阻塞/超时（强一致性的代价）</tspan></text></g><g><line class="loopLine" y2="384" x2="867" y1="384" x1="40"></line><line class="loopLine" y2="740" x2="867" y1="384" x1="867"></line><line class="loopLine" y2="740" x2="867" y1="740" x1="40"></line><line class="loopLine" y2="740" x2="40" y1="384" x1="40"></line><line style="stroke-dasharray: 3, 3;" class="loopLine" y2="602" x2="867" y1="602" x1="40"></line><polygon class="labelBox" points="40,384 90,384 90,397 81.6,404 40,404"></polygon><text style="font-size: 16px; font-weight: 400;" class="labelText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="397" x="65">alt</text><text style="font-size: 16px; font-weight: 400;" class="loopText" text-anchor="middle" y="402" x="478.5"><tspan x="478.5">[F2 正常]</tspan></text><text style="font-size: 16px; font-weight: 400;" class="loopText" text-anchor="middle" y="620" x="453.5">[F2 慢/暂时不可用]</text></g><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="80" x="201">propose transfer(A→B,100)</text><line style="fill: none;" marker-start="url(#mermaid-figure-3-sequencenumber)" marker-end="url(#mermaid-figure-3-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="111" x2="325" y1="111" x1="76"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="115" x="76">1</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="126" x="330">log.append(term=12, idx=42, cmd)</text><path style="fill: none;" marker-start="url(#mermaid-figure-3-sequencenumber)" marker-end="url(#mermaid-figure-3-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 330,157 C 390,147 390,187 330,177"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="161" x="330">2</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="202" x="491">AppendEntries(prev=41, term=12, [42])</text><line style="fill: none;" marker-start="url(#mermaid-figure-3-sequencenumber)" marker-end="url(#mermaid-figure-3-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="233" x2="652" y1="233" x1="330"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="237" x="330">3</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="248" x="591">AppendEntries(prev=41, term=12, [42])</text><line style="fill: none;" marker-start="url(#mermaid-figure-3-sequencenumber)" marker-end="url(#mermaid-figure-3-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="279" x2="852" y1="279" x1="330"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="283" x="330">4</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="294" x="494">AppendOK(match=42)</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-3-sequencenumber)" marker-end="url(#mermaid-figure-3-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="325" x2="333" y1="325" x1="655"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="329" x="655">5</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="434" x="594">AppendOK(match=42)</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-3-sequencenumber)" marker-end="url(#mermaid-figure-3-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="465" x2="333" y1="465" x1="855"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="469" x="855">6</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="480" x="330">commitIndex=42 apply(A -= 100 &amp; B += 100)</text><path style="fill: none;" marker-start="url(#mermaid-figure-3-sequencenumber)" marker-end="url(#mermaid-figure-3-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 330,511 C 390,501 390,541 330,531"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="515" x="330">7</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="556" x="204">OK(txid=T2025-0917-0001)</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-3-sequencenumber)" marker-end="url(#mermaid-figure-3-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="587" x2="79" y1="587" x1="328"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="591" x="328">8</text>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="主从异步版本" class="slide level2">
<h2>主从异步版本</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<svg aria-roledescription="sequence" role="graphics-document document" viewbox="-50 -10 1169.5 780" style="; display: block; margin: auto auto auto auto" xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="960" id="mermaid-figure-2" height="480">
<g><rect class="actor actor-bottom" ry="3" rx="3" name="R2" height="65" width="150" stroke="#666" fill="#eaeaea" y="694" x="919.5"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="726.5" x="994.5"><tspan dy="0" x="994.5">R2</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="R1" height="65" width="150" stroke="#666" fill="#eaeaea" y="694" x="696"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="726.5" x="771"><tspan dy="0" x="771">R1</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="P" height="65" width="150" stroke="#666" fill="#eaeaea" y="694" x="391"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="726.5" x="466"><tspan dy="0" x="466">P</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="C" height="65" width="150" stroke="#666" fill="#eaeaea" y="694" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="726.5" x="75"><tspan dy="0" x="75">Client</tspan></text></g><g><line name="R2" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="694" x2="994.5" y1="5" x1="994.5" id="actor3"></line><g id="root-3"><rect class="actor actor-top" ry="3" rx="3" name="R2" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="919.5"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="994.5"><tspan dy="0" x="994.5">R2</tspan></text></g></g><g><line name="R1" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="694" x2="771" y1="5" x1="771" id="actor2"></line><g id="root-2"><rect class="actor actor-top" ry="3" rx="3" name="R1" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="696"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="771"><tspan dy="0" x="771">R1</tspan></text></g></g><g><line name="P" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="694" x2="466" y1="5" x1="466" id="actor1"></line><g id="root-1"><rect class="actor actor-top" ry="3" rx="3" name="P" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="391"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="466"><tspan dy="0" x="466">P</tspan></text></g></g><g><line name="C" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="694" x2="75" y1="5" x1="75" id="actor0"></line><g id="root-0"><rect class="actor actor-top" ry="3" rx="3" name="C" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="75"><tspan dy="0" x="75">Client</tspan></text></g></g>
<style>#mermaid-figure-2{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-figure-2 .error-icon{fill:#552222;}#mermaid-figure-2 .error-text{fill:#552222;stroke:#552222;}#mermaid-figure-2 .edge-thickness-normal{stroke-width:1px;}#mermaid-figure-2 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-figure-2 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-figure-2 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-figure-2 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-figure-2 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-figure-2 .marker{fill:#333333;stroke:#333333;}#mermaid-figure-2 .marker.cross{stroke:#333333;}#mermaid-figure-2 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-figure-2 p{margin:0;}#mermaid-figure-2 .actor{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-2 text.actor>tspan{fill:black;stroke:none;}#mermaid-figure-2 .actor-line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-2 .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaid-figure-2 .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaid-figure-2 #mermaid-figure-2-arrowhead path{fill:#333;stroke:#333;}#mermaid-figure-2 .sequenceNumber{fill:white;}#mermaid-figure-2 #mermaid-figure-2-sequencenumber{fill:#333;}#mermaid-figure-2 #mermaid-figure-2-crosshead path{fill:#333;stroke:#333;}#mermaid-figure-2 .messageText{fill:#333;stroke:none;}#mermaid-figure-2 .labelBox{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-2 .labelText,#mermaid-figure-2 .labelText>tspan{fill:black;stroke:none;}#mermaid-figure-2 .loopText,#mermaid-figure-2 .loopText>tspan{fill:black;stroke:none;}#mermaid-figure-2 .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-2 .note{stroke:#aaaa33;fill:#fff5ad;}#mermaid-figure-2 .noteText,#mermaid-figure-2 .noteText>tspan{fill:black;stroke:none;}#mermaid-figure-2 .activation0{fill:#f4f4f4;stroke:#666;}#mermaid-figure-2 .activation1{fill:#f4f4f4;stroke:#666;}#mermaid-figure-2 .activation2{fill:#f4f4f4;stroke:#666;}#mermaid-figure-2 .actorPopupMenu{position:absolute;}#mermaid-figure-2 .actorPopupMenuPanel{position:absolute;fill:#ECECFF;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);filter:drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4));}#mermaid-figure-2 .actor-man line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-2 .actor-man circle,#mermaid-figure-2 line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;stroke-width:2px;}#mermaid-figure-2 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style>
<g></g><defs><symbol height="24" width="24" id="mermaid-figure-2-computer"><path d="M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z" transform="scale(.5)"></path></symbol></defs><defs><symbol clip-rule="evenodd" fill-rule="evenodd" id="mermaid-figure-2-database"><path d="M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z" transform="scale(.5)"></path></symbol></defs><defs><symbol height="24" width="24" id="mermaid-figure-2-clock"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z" transform="scale(.5)"></path></symbol></defs><defs><marker orient="auto-start-reverse" markerheight="12" markerwidth="12" markerunits="userSpaceOnUse" refy="5" refx="7.9" id="mermaid-figure-2-arrowhead"><path d="M -1 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker refy="4.5" refx="4" orient="auto" markerheight="8" markerwidth="15" id="mermaid-figure-2-crosshead"><path style="stroke-dasharray: 0, 0;" d="M 1,2 L 6,7 M 6,2 L 1,7" stroke-width="1pt" stroke="#000000" fill="none"></path></marker></defs><defs><marker orient="auto" markerheight="28" markerwidth="20" refy="7" refx="15.5" id="mermaid-figure-2-filled-head"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerheight="40" markerwidth="60" refy="15" refx="15" id="mermaid-figure-2-sequencenumber"><circle r="6" cy="15" cx="15"></circle></marker></defs><g><line class="loopLine" y2="243" x2="1005.5" y1="243" x1="455"></line><line class="loopLine" y2="472" x2="1005.5" y1="243" x1="1005.5"></line><line class="loopLine" y2="472" x2="1005.5" y1="472" x1="455"></line><line class="loopLine" y2="472" x2="455" y1="243" x1="455"></line><polygon class="labelBox" points="455,243 505,243 505,256 496.6,263 455,263"></polygon><text style="font-size: 16px; font-weight: 400;" class="labelText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="256" x="480">par</text><text style="font-size: 16px; font-weight: 400;" class="loopText" text-anchor="middle" y="261" x="755.25"><tspan x="755.25">[异步复制]</tspan></text></g><g><rect class="note" height="39" width="341" stroke="#666" fill="#EDF2AE" y="527" x="100"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="532" x="271"><tspan x="271">客户端已拿到 OK，但 R1/R2 可能尚未收到 42</tspan></text></g><g><rect class="note" height="39" width="273.5" stroke="#666" fill="#EDF2AE" y="576" x="746"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="581" x="883"><tspan x="883">发生主从切换：R1 当选新主，但只到 index=41</tspan></text></g><g><rect class="note" height="39" width="746" stroke="#666" fill="#EDF2AE" y="625" x="50"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="630" x="423"><tspan x="423">事务 T2025-0917-0002 丢失（RPO&gt;0）</tspan></text></g><g><line class="loopLine" y2="482" x2="1029.5" y1="482" x1="40"></line><line class="loopLine" y2="674" x2="1029.5" y1="482" x1="1029.5"></line><line class="loopLine" y2="674" x2="1029.5" y1="674" x1="40"></line><line class="loopLine" y2="674" x2="40" y1="482" x1="40"></line><line style="stroke-dasharray: 3, 3;" class="loopLine" y2="679" x2="1029.5" y1="679" x1="40"></line><polygon class="labelBox" points="40,482 90,482 90,495 81.6,502 40,502"></polygon><text style="font-size: 16px; font-weight: 400;" class="labelText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="495" x="65">alt</text><text style="font-size: 16px; font-weight: 400;" class="loopText" text-anchor="middle" y="500" x="559.75"><tspan x="559.75">[故障：P 在复制前或复制中宕机]</tspan></text><text style="font-size: 16px; font-weight: 400;" class="loopText" text-anchor="middle" y="697" x="534.75">[无故障]</text></g><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="80" x="269">propose transfer(A→B,100)</text><line style="fill: none;" marker-start="url(#mermaid-figure-2-sequencenumber)" marker-end="url(#mermaid-figure-2-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="111" x2="462" y1="111" x1="76"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="115" x="76">1</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="126" x="467">append idx=42 apply(A -= 100 &amp; B += 100)</text><path style="fill: none;" marker-start="url(#mermaid-figure-2-sequencenumber)" marker-end="url(#mermaid-figure-2-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 467,157 C 527,147 527,187 467,177"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="161" x="467">2</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="202" x="272">OK(txid=T2025-0917-0002)</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-2-sequencenumber)" marker-end="url(#mermaid-figure-2-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="233" x2="79" y1="233" x1="465"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="237" x="465">3</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="293" x="617">ShipLog([42]) (async)</text><line style="fill: none;" marker-start="url(#mermaid-figure-2-sequencenumber)" marker-end="url(#mermaid-figure-2-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="324" x2="767" y1="324" x1="467"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="328" x="467">4</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="339" x="620">Ack(42) (延迟不影响已返回的OK)</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-2-sequencenumber)" marker-end="url(#mermaid-figure-2-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="370" x2="470" y1="370" x1="770"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="374" x="770">5</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="385" x="729">ShipLog([42]) (async)</text><line style="fill: none;" marker-start="url(#mermaid-figure-2-sequencenumber)" marker-end="url(#mermaid-figure-2-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="416" x2="990.5" y1="416" x1="467"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="420" x="467">6</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="431" x="732">Ack(42)</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-2-sequencenumber)" marker-end="url(#mermaid-figure-2-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="462" x2="470" y1="462" x1="993.5"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="466" x="993.5">7</text>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="最小-raft-演示" class="slide level2 smaller">
<h2>最小 Raft 演示</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href=""></a><span class="co">"""</span></span>
<span id="cb1-2"><a href=""></a><span class="co">Raft 青春版</span></span>
<span id="cb1-3"><a href=""></a><span class="co">重点：选举、心跳、日志复制（逐条）、多数派提交、简单状态机</span></span>
<span id="cb1-4"><a href=""></a><span class="co">"""</span></span>
<span id="cb1-5"><a href=""></a></span>
<span id="cb1-6"><a href=""></a><span class="im">from</span> __future__ <span class="im">import</span> annotations</span>
<span id="cb1-7"><a href=""></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb1-8"><a href=""></a><span class="im">import</span> random</span>
<span id="cb1-9"><a href=""></a><span class="im">from</span> typing <span class="im">import</span> List, Dict, Optional, Tuple</span>
<span id="cb1-10"><a href=""></a></span>
<span id="cb1-11"><a href=""></a><span class="co"># ========= 演示日志开关 =========</span></span>
<span id="cb1-12"><a href=""></a><span class="co"># 总闸</span></span>
<span id="cb1-13"><a href=""></a>DEBUG <span class="op">=</span> <span class="va">True</span></span>
<span id="cb1-14"><a href=""></a></span>
<span id="cb1-15"><a href=""></a><span class="co"># 分闸</span></span>
<span id="cb1-16"><a href=""></a>DBG <span class="op">=</span> {</span>
<span id="cb1-17"><a href=""></a>    <span class="st">"election"</span>: <span class="va">True</span>,  <span class="co"># 选举/角色切换</span></span>
<span id="cb1-18"><a href=""></a>    <span class="st">"send_append"</span>: <span class="va">False</span>,  <span class="co"># Leader 侧发送 AppendEntries</span></span>
<span id="cb1-19"><a href=""></a>    <span class="st">"follower_append"</span>: <span class="va">False</span>,  <span class="co"># Follower 侧收到并应答 AppendEntries</span></span>
<span id="cb1-20"><a href=""></a>    <span class="st">"append_resp"</span>: <span class="va">False</span>,  <span class="co"># Leader 侧收到 APPEND_RESP</span></span>
<span id="cb1-21"><a href=""></a>    <span class="st">"apply"</span>: <span class="va">True</span>,  <span class="co"># 状态机应用</span></span>
<span id="cb1-22"><a href=""></a>}</span>
<span id="cb1-23"><a href=""></a></span>
<span id="cb1-24"><a href=""></a></span>
<span id="cb1-25"><a href=""></a><span class="kw">def</span> dlog(cat: <span class="bu">str</span>, s: <span class="bu">str</span>):</span>
<span id="cb1-26"><a href=""></a>    <span class="co">"""按类目和总开关控制"""</span></span>
<span id="cb1-27"><a href=""></a>    <span class="cf">if</span> DEBUG <span class="kw">and</span> DBG.get(cat, <span class="va">False</span>):</span>
<span id="cb1-28"><a href=""></a>        <span class="bu">print</span>(s, flush<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-29"><a href=""></a></span>
<span id="cb1-30"><a href=""></a></span>
<span id="cb1-31"><a href=""></a><span class="co"># ========= 演示参数 =========</span></span>
<span id="cb1-32"><a href=""></a>SEED <span class="op">=</span> <span class="dv">2025</span></span>
<span id="cb1-33"><a href=""></a>N <span class="op">=</span> <span class="dv">5</span>  <span class="co"># 节点数（奇数便于产生多数派）</span></span>
<span id="cb1-34"><a href=""></a>HEARTBEAT_EVERY <span class="op">=</span> <span class="dv">4</span>  <span class="co"># Leader 心跳间隔（tick）</span></span>
<span id="cb1-35"><a href=""></a>ELECTION_RANGE <span class="op">=</span> (<span class="dv">12</span>, <span class="dv">20</span>)  <span class="co"># 选举超时范围（tick）</span></span>
<span id="cb1-36"><a href=""></a>NET_DELAY_RANGE <span class="op">=</span> (<span class="dv">2</span>, <span class="dv">4</span>)  <span class="co"># 消息网络延迟（tick）</span></span>
<span id="cb1-37"><a href=""></a>DROP_RATE <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># 丢包率（例如0.1）</span></span>
<span id="cb1-38"><a href=""></a>T_MAX <span class="op">=</span> <span class="dv">220</span>  <span class="co"># 总仿真步数</span></span>
<span id="cb1-39"><a href=""></a></span>
<span id="cb1-40"><a href=""></a><span class="co"># 在选出 Leader 后，注入 1 笔转账命令；随后故意整死 Leader 再看重选</span></span>
<span id="cb1-41"><a href=""></a>CRASH_LEADER_AT <span class="op">=</span> <span class="dv">120</span></span>
<span id="cb1-42"><a href=""></a>RECOVER_LEADER_AT <span class="op">=</span> <span class="dv">170</span></span>
<span id="cb1-43"><a href=""></a></span>
<span id="cb1-44"><a href=""></a>random.seed(SEED)</span>
<span id="cb1-45"><a href=""></a></span>
<span id="cb1-46"><a href=""></a></span>
<span id="cb1-47"><a href=""></a><span class="co"># ========= Raft 日志条目与消息 =========</span></span>
<span id="cb1-48"><a href=""></a><span class="at">@dataclass</span></span>
<span id="cb1-49"><a href=""></a><span class="kw">class</span> Entry:</span>
<span id="cb1-50"><a href=""></a>    term: <span class="bu">int</span></span>
<span id="cb1-51"><a href=""></a>    cmd: <span class="bu">str</span>  <span class="co"># 例如 "transfer A B 100"</span></span>
<span id="cb1-52"><a href=""></a></span>
<span id="cb1-53"><a href=""></a></span>
<span id="cb1-54"><a href=""></a><span class="co"># 消息用字典结构</span></span>
<span id="cb1-55"><a href=""></a><span class="kw">def</span> msg_request_vote(term, cand_id, last_term, last_idx):</span>
<span id="cb1-56"><a href=""></a>    <span class="cf">return</span> {</span>
<span id="cb1-57"><a href=""></a>        <span class="st">"type"</span>: <span class="st">"RV"</span>,</span>
<span id="cb1-58"><a href=""></a>        <span class="st">"term"</span>: term,</span>
<span id="cb1-59"><a href=""></a>        <span class="st">"cand"</span>: cand_id,</span>
<span id="cb1-60"><a href=""></a>        <span class="st">"last_term"</span>: last_term,</span>
<span id="cb1-61"><a href=""></a>        <span class="st">"last_idx"</span>: last_idx,</span>
<span id="cb1-62"><a href=""></a>    }</span>
<span id="cb1-63"><a href=""></a></span>
<span id="cb1-64"><a href=""></a></span>
<span id="cb1-65"><a href=""></a><span class="kw">def</span> msg_request_vote_resp(term, voter_id, granted):</span>
<span id="cb1-66"><a href=""></a>    <span class="cf">return</span> {<span class="st">"type"</span>: <span class="st">"RV_RESP"</span>, <span class="st">"term"</span>: term, <span class="st">"voter"</span>: voter_id, <span class="st">"granted"</span>: granted}</span>
<span id="cb1-67"><a href=""></a></span>
<span id="cb1-68"><a href=""></a></span>
<span id="cb1-69"><a href=""></a><span class="kw">def</span> msg_append(</span>
<span id="cb1-70"><a href=""></a>    term, leader_id, prev_idx, prev_term, entries: List[Entry], leader_commit</span>
<span id="cb1-71"><a href=""></a>):</span>
<span id="cb1-72"><a href=""></a>    <span class="co"># 只发 0/1 条，entries 可序列化</span></span>
<span id="cb1-73"><a href=""></a>    <span class="cf">return</span> {</span>
<span id="cb1-74"><a href=""></a>        <span class="st">"type"</span>: <span class="st">"APPEND"</span>,</span>
<span id="cb1-75"><a href=""></a>        <span class="st">"term"</span>: term,</span>
<span id="cb1-76"><a href=""></a>        <span class="st">"leader"</span>: leader_id,</span>
<span id="cb1-77"><a href=""></a>        <span class="st">"prev_idx"</span>: prev_idx,</span>
<span id="cb1-78"><a href=""></a>        <span class="st">"prev_term"</span>: prev_term,</span>
<span id="cb1-79"><a href=""></a>        <span class="st">"entries"</span>: entries,</span>
<span id="cb1-80"><a href=""></a>        <span class="st">"leader_commit"</span>: leader_commit,</span>
<span id="cb1-81"><a href=""></a>    }</span>
<span id="cb1-82"><a href=""></a></span>
<span id="cb1-83"><a href=""></a></span>
<span id="cb1-84"><a href=""></a><span class="kw">def</span> msg_append_resp(term, from_id, success, match_index):</span>
<span id="cb1-85"><a href=""></a>    <span class="cf">return</span> {</span>
<span id="cb1-86"><a href=""></a>        <span class="st">"type"</span>: <span class="st">"APPEND_RESP"</span>,</span>
<span id="cb1-87"><a href=""></a>        <span class="st">"term"</span>: term,</span>
<span id="cb1-88"><a href=""></a>        <span class="st">"from"</span>: from_id,</span>
<span id="cb1-89"><a href=""></a>        <span class="st">"success"</span>: success,</span>
<span id="cb1-90"><a href=""></a>        <span class="st">"match_index"</span>: match_index,</span>
<span id="cb1-91"><a href=""></a>    }</span>
<span id="cb1-92"><a href=""></a></span>
<span id="cb1-93"><a href=""></a></span>
<span id="cb1-94"><a href=""></a><span class="co"># ========= 网络 =========</span></span>
<span id="cb1-95"><a href=""></a><span class="kw">class</span> Network:</span>
<span id="cb1-96"><a href=""></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb1-97"><a href=""></a>        <span class="va">self</span>.q: List[Tuple[<span class="bu">int</span>, <span class="bu">int</span>, <span class="bu">dict</span>]] <span class="op">=</span> []  <span class="co"># (deliver_tick, to_id, msg)</span></span>
<span id="cb1-98"><a href=""></a></span>
<span id="cb1-99"><a href=""></a>    <span class="kw">def</span> send(<span class="va">self</span>, now_tick: <span class="bu">int</span>, to_id: <span class="bu">int</span>, msg: <span class="bu">dict</span>):</span>
<span id="cb1-100"><a href=""></a>        <span class="cf">if</span> random.random() <span class="op">&lt;</span> DROP_RATE:</span>
<span id="cb1-101"><a href=""></a>            <span class="cf">return</span>  <span class="co"># 丢包</span></span>
<span id="cb1-102"><a href=""></a>        delay <span class="op">=</span> random.randint(<span class="op">*</span>NET_DELAY_RANGE)</span>
<span id="cb1-103"><a href=""></a>        <span class="va">self</span>.q.append((now_tick <span class="op">+</span> delay, to_id, msg))</span>
<span id="cb1-104"><a href=""></a></span>
<span id="cb1-105"><a href=""></a>    <span class="kw">def</span> deliver(<span class="va">self</span>, now_tick: <span class="bu">int</span>) <span class="op">-&gt;</span> List[Tuple[<span class="bu">int</span>, <span class="bu">dict</span>]]:</span>
<span id="cb1-106"><a href=""></a>        <span class="co">"""返回应在 now_tick 投递的消息: [(to_id, msg), ...]"""</span></span>
<span id="cb1-107"><a href=""></a>        ready, rest <span class="op">=</span> [], []</span>
<span id="cb1-108"><a href=""></a>        <span class="cf">for</span> t, to_id, msg <span class="kw">in</span> <span class="va">self</span>.q:</span>
<span id="cb1-109"><a href=""></a>            <span class="cf">if</span> t <span class="op">&lt;=</span> now_tick:</span>
<span id="cb1-110"><a href=""></a>                ready.append((to_id, msg))</span>
<span id="cb1-111"><a href=""></a>            <span class="cf">else</span>:</span>
<span id="cb1-112"><a href=""></a>                rest.append((t, to_id, msg))</span>
<span id="cb1-113"><a href=""></a>        <span class="va">self</span>.q <span class="op">=</span> rest</span>
<span id="cb1-114"><a href=""></a>        <span class="cf">return</span> ready</span>
<span id="cb1-115"><a href=""></a></span>
<span id="cb1-116"><a href=""></a></span>
<span id="cb1-117"><a href=""></a><span class="co"># ========= Raft 节点 =========</span></span>
<span id="cb1-118"><a href=""></a><span class="kw">class</span> Node:</span>
<span id="cb1-119"><a href=""></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, i: <span class="bu">int</span>, peers: List[<span class="bu">int</span>], net: Network):</span>
<span id="cb1-120"><a href=""></a>        <span class="va">self</span>.<span class="bu">id</span> <span class="op">=</span> i</span>
<span id="cb1-121"><a href=""></a>        <span class="va">self</span>.peers <span class="op">=</span> peers</span>
<span id="cb1-122"><a href=""></a>        <span class="va">self</span>.net <span class="op">=</span> net</span>
<span id="cb1-123"><a href=""></a></span>
<span id="cb1-124"><a href=""></a>        <span class="co"># 角色</span></span>
<span id="cb1-125"><a href=""></a>        <span class="va">self</span>.state <span class="op">=</span> <span class="st">"Follower"</span>  <span class="co"># Follower / Candidate / Leader</span></span>
<span id="cb1-126"><a href=""></a>        <span class="va">self</span>.alive <span class="op">=</span> <span class="va">True</span></span>
<span id="cb1-127"><a href=""></a></span>
<span id="cb1-128"><a href=""></a>        <span class="co"># 任期与投票</span></span>
<span id="cb1-129"><a href=""></a>        <span class="va">self</span>.current_term <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb1-130"><a href=""></a>        <span class="va">self</span>.voted_for: Optional[<span class="bu">int</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-131"><a href=""></a></span>
<span id="cb1-132"><a href=""></a>        <span class="co"># 日志与提交</span></span>
<span id="cb1-133"><a href=""></a>        <span class="va">self</span>.log: List[Entry] <span class="op">=</span> []  <span class="co"># [(term, cmd)]</span></span>
<span id="cb1-134"><a href=""></a>        <span class="va">self</span>.commit_index <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb1-135"><a href=""></a>        <span class="va">self</span>.last_applied <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb1-136"><a href=""></a></span>
<span id="cb1-137"><a href=""></a>        <span class="co"># Leader 专用复制状态</span></span>
<span id="cb1-138"><a href=""></a>        <span class="va">self</span>.next_index: Dict[<span class="bu">int</span>, <span class="bu">int</span>] <span class="op">=</span> {}</span>
<span id="cb1-139"><a href=""></a>        <span class="va">self</span>.match_index: Dict[<span class="bu">int</span>, <span class="bu">int</span>] <span class="op">=</span> {}</span>
<span id="cb1-140"><a href=""></a></span>
<span id="cb1-141"><a href=""></a>        <span class="co"># 计时</span></span>
<span id="cb1-142"><a href=""></a>        <span class="va">self</span>.rand_election_reset(<span class="dv">0</span>)</span>
<span id="cb1-143"><a href=""></a>        <span class="va">self</span>.last_heartbeat_seen <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb1-144"><a href=""></a>        <span class="va">self</span>.heartbeat_tick <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb1-145"><a href=""></a></span>
<span id="cb1-146"><a href=""></a>        <span class="co"># 状态机（银行账户）</span></span>
<span id="cb1-147"><a href=""></a>        <span class="va">self</span>.state_machine <span class="op">=</span> {<span class="st">"A"</span>: <span class="dv">1000</span>, <span class="st">"B"</span>: <span class="dv">1000</span>}</span>
<span id="cb1-148"><a href=""></a></span>
<span id="cb1-149"><a href=""></a>        <span class="co"># 统计</span></span>
<span id="cb1-150"><a href=""></a>        <span class="va">self</span>.votes_granted <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb1-151"><a href=""></a></span>
<span id="cb1-152"><a href=""></a>    <span class="co"># ---- 工具 ----</span></span>
<span id="cb1-153"><a href=""></a>    <span class="kw">def</span> majority(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb1-154"><a href=""></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.peers) <span class="op">//</span> <span class="dv">2</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb1-155"><a href=""></a></span>
<span id="cb1-156"><a href=""></a>    <span class="kw">def</span> last_log_index(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb1-157"><a href=""></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.log) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb1-158"><a href=""></a></span>
<span id="cb1-159"><a href=""></a>    <span class="kw">def</span> last_log_term(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb1-160"><a href=""></a>        <span class="cf">return</span> <span class="va">self</span>.log[<span class="op">-</span><span class="dv">1</span>].term <span class="cf">if</span> <span class="va">self</span>.log <span class="cf">else</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb1-161"><a href=""></a></span>
<span id="cb1-162"><a href=""></a>    <span class="kw">def</span> rand_election_reset(<span class="va">self</span>, now_tick: <span class="bu">int</span>):</span>
<span id="cb1-163"><a href=""></a>        <span class="va">self</span>.election_deadline <span class="op">=</span> now_tick <span class="op">+</span> random.randint(<span class="op">*</span>ELECTION_RANGE)</span>
<span id="cb1-164"><a href=""></a></span>
<span id="cb1-165"><a href=""></a>    <span class="co"># ---- 角色切换 ----</span></span>
<span id="cb1-166"><a href=""></a>    <span class="kw">def</span> become_follower(<span class="va">self</span>, term: <span class="bu">int</span>):</span>
<span id="cb1-167"><a href=""></a>        <span class="cf">if</span> <span class="va">self</span>.state <span class="op">!=</span> <span class="st">"Follower"</span>:</span>
<span id="cb1-168"><a href=""></a>            <span class="bu">print</span>(<span class="ss">f"[Tick?] Node</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">: -&gt; Follower (term=</span><span class="sc">{</span>term<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb1-169"><a href=""></a>        <span class="va">self</span>.state <span class="op">=</span> <span class="st">"Follower"</span></span>
<span id="cb1-170"><a href=""></a>        <span class="va">self</span>.current_term <span class="op">=</span> term</span>
<span id="cb1-171"><a href=""></a>        <span class="va">self</span>.voted_for <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-172"><a href=""></a></span>
<span id="cb1-173"><a href=""></a>    <span class="kw">def</span> become_candidate(<span class="va">self</span>, now_tick: <span class="bu">int</span>):</span>
<span id="cb1-174"><a href=""></a>        <span class="va">self</span>.state <span class="op">=</span> <span class="st">"Candidate"</span></span>
<span id="cb1-175"><a href=""></a>        <span class="va">self</span>.current_term <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb1-176"><a href=""></a>        <span class="va">self</span>.voted_for <span class="op">=</span> <span class="va">self</span>.<span class="bu">id</span></span>
<span id="cb1-177"><a href=""></a>        <span class="va">self</span>.votes_granted <span class="op">=</span> <span class="dv">1</span>  <span class="co"># 自投一票</span></span>
<span id="cb1-178"><a href=""></a>        <span class="va">self</span>.rand_election_reset(now_tick)</span>
<span id="cb1-179"><a href=""></a>        <span class="bu">print</span>(<span class="ss">f"[</span><span class="sc">{</span>now_tick<span class="sc">}</span><span class="ss">] Node</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">: -&gt; Candidate term=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>current_term<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-180"><a href=""></a>        <span class="co"># 广播 RequestVote</span></span>
<span id="cb1-181"><a href=""></a>        <span class="cf">for</span> peer <span class="kw">in</span> <span class="va">self</span>.peers:</span>
<span id="cb1-182"><a href=""></a>            <span class="cf">if</span> peer <span class="op">==</span> <span class="va">self</span>.<span class="bu">id</span>:</span>
<span id="cb1-183"><a href=""></a>                <span class="cf">continue</span></span>
<span id="cb1-184"><a href=""></a>            <span class="va">self</span>.net.send(</span>
<span id="cb1-185"><a href=""></a>                now_tick,</span>
<span id="cb1-186"><a href=""></a>                peer,</span>
<span id="cb1-187"><a href=""></a>                msg_request_vote(</span>
<span id="cb1-188"><a href=""></a>                    <span class="va">self</span>.current_term,</span>
<span id="cb1-189"><a href=""></a>                    <span class="va">self</span>.<span class="bu">id</span>,</span>
<span id="cb1-190"><a href=""></a>                    <span class="va">self</span>.last_log_term(),</span>
<span id="cb1-191"><a href=""></a>                    <span class="va">self</span>.last_log_index(),</span>
<span id="cb1-192"><a href=""></a>                ),</span>
<span id="cb1-193"><a href=""></a>            )</span>
<span id="cb1-194"><a href=""></a></span>
<span id="cb1-195"><a href=""></a>    <span class="kw">def</span> become_leader(<span class="va">self</span>, now_tick: <span class="bu">int</span>):</span>
<span id="cb1-196"><a href=""></a>        <span class="va">self</span>.state <span class="op">=</span> <span class="st">"Leader"</span></span>
<span id="cb1-197"><a href=""></a>        <span class="co"># 初始化复制指针</span></span>
<span id="cb1-198"><a href=""></a>        last <span class="op">=</span> <span class="va">self</span>.last_log_index() <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb1-199"><a href=""></a>        <span class="va">self</span>.next_index <span class="op">=</span> {p: last <span class="cf">for</span> p <span class="kw">in</span> <span class="va">self</span>.peers}</span>
<span id="cb1-200"><a href=""></a>        <span class="va">self</span>.match_index <span class="op">=</span> {p: <span class="op">-</span><span class="dv">1</span> <span class="cf">for</span> p <span class="kw">in</span> <span class="va">self</span>.peers}</span>
<span id="cb1-201"><a href=""></a>        <span class="va">self</span>.heartbeat_tick <span class="op">=</span> now_tick</span>
<span id="cb1-202"><a href=""></a>        dlog(</span>
<span id="cb1-203"><a href=""></a>            <span class="st">"election"</span>,</span>
<span id="cb1-204"><a href=""></a>            <span class="ss">f"[</span><span class="sc">{</span>now_tick<span class="sc">}</span><span class="ss">] Node</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">: ⭐ LEADER elected (term=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>current_term<span class="sc">}</span><span class="ss">)"</span>,</span>
<span id="cb1-205"><a href=""></a>        )</span>
<span id="cb1-206"><a href=""></a>        <span class="co"># 立刻发一轮心跳（空 Append）</span></span>
<span id="cb1-207"><a href=""></a>        <span class="va">self</span>.send_heartbeats(now_tick)</span>
<span id="cb1-208"><a href=""></a></span>
<span id="cb1-209"><a href=""></a>    <span class="co"># ---- Tick 驱动 ----</span></span>
<span id="cb1-210"><a href=""></a>    <span class="kw">def</span> tick(<span class="va">self</span>, now_tick: <span class="bu">int</span>):</span>
<span id="cb1-211"><a href=""></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.alive:</span>
<span id="cb1-212"><a href=""></a>            <span class="cf">return</span></span>
<span id="cb1-213"><a href=""></a></span>
<span id="cb1-214"><a href=""></a>        <span class="co"># 选举超时</span></span>
<span id="cb1-215"><a href=""></a>        <span class="cf">if</span> <span class="va">self</span>.state <span class="op">!=</span> <span class="st">"Leader"</span> <span class="kw">and</span> now_tick <span class="op">&gt;=</span> <span class="va">self</span>.election_deadline:</span>
<span id="cb1-216"><a href=""></a>            <span class="va">self</span>.become_candidate(now_tick)</span>
<span id="cb1-217"><a href=""></a></span>
<span id="cb1-218"><a href=""></a>        <span class="co"># Leader 发心跳 / 推进复制</span></span>
<span id="cb1-219"><a href=""></a>        <span class="cf">if</span> <span class="va">self</span>.state <span class="op">==</span> <span class="st">"Leader"</span> <span class="kw">and</span> now_tick <span class="op">-</span> <span class="va">self</span>.heartbeat_tick <span class="op">&gt;=</span> HEARTBEAT_EVERY:</span>
<span id="cb1-220"><a href=""></a>            <span class="va">self</span>.send_heartbeats(now_tick)</span>
<span id="cb1-221"><a href=""></a>            <span class="va">self</span>.heartbeat_tick <span class="op">=</span> now_tick</span>
<span id="cb1-222"><a href=""></a></span>
<span id="cb1-223"><a href=""></a>        <span class="co"># 应用提交到状态机</span></span>
<span id="cb1-224"><a href=""></a>        <span class="va">self</span>.apply_commits(now_tick)</span>
<span id="cb1-225"><a href=""></a></span>
<span id="cb1-226"><a href=""></a>    <span class="co"># ---- 消息处理 ----</span></span>
<span id="cb1-227"><a href=""></a>    <span class="kw">def</span> on_msg(<span class="va">self</span>, now_tick: <span class="bu">int</span>, msg: <span class="bu">dict</span>):</span>
<span id="cb1-228"><a href=""></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.alive:</span>
<span id="cb1-229"><a href=""></a>            <span class="cf">return</span></span>
<span id="cb1-230"><a href=""></a></span>
<span id="cb1-231"><a href=""></a>        t <span class="op">=</span> msg[<span class="st">"term"</span>]</span>
<span id="cb1-232"><a href=""></a>        <span class="co"># 任期落后要追</span></span>
<span id="cb1-233"><a href=""></a>        <span class="cf">if</span> t <span class="op">&gt;</span> <span class="va">self</span>.current_term:</span>
<span id="cb1-234"><a href=""></a>            <span class="va">self</span>.become_follower(t)</span>
<span id="cb1-235"><a href=""></a></span>
<span id="cb1-236"><a href=""></a>        <span class="cf">if</span> msg[<span class="st">"type"</span>] <span class="op">==</span> <span class="st">"RV"</span>:</span>
<span id="cb1-237"><a href=""></a>            <span class="va">self</span>.handle_request_vote(now_tick, msg)</span>
<span id="cb1-238"><a href=""></a>        <span class="cf">elif</span> msg[<span class="st">"type"</span>] <span class="op">==</span> <span class="st">"RV_RESP"</span>:</span>
<span id="cb1-239"><a href=""></a>            <span class="cf">if</span> <span class="va">self</span>.state <span class="op">==</span> <span class="st">"Candidate"</span> <span class="kw">and</span> t <span class="op">==</span> <span class="va">self</span>.current_term <span class="kw">and</span> msg[<span class="st">"granted"</span>]:</span>
<span id="cb1-240"><a href=""></a>                <span class="va">self</span>.votes_granted <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb1-241"><a href=""></a>                <span class="cf">if</span> <span class="va">self</span>.votes_granted <span class="op">&gt;=</span> <span class="va">self</span>.majority():</span>
<span id="cb1-242"><a href=""></a>                    <span class="va">self</span>.become_leader(now_tick)</span>
<span id="cb1-243"><a href=""></a>        <span class="cf">elif</span> msg[<span class="st">"type"</span>] <span class="op">==</span> <span class="st">"APPEND"</span>:</span>
<span id="cb1-244"><a href=""></a>            <span class="va">self</span>.handle_append(now_tick, msg)</span>
<span id="cb1-245"><a href=""></a>        <span class="cf">elif</span> msg[<span class="st">"type"</span>] <span class="op">==</span> <span class="st">"APPEND_RESP"</span>:</span>
<span id="cb1-246"><a href=""></a>            <span class="cf">if</span> <span class="va">self</span>.state <span class="op">==</span> <span class="st">"Leader"</span> <span class="kw">and</span> t <span class="op">==</span> <span class="va">self</span>.current_term:</span>
<span id="cb1-247"><a href=""></a>                <span class="va">self</span>.handle_append_resp(now_tick, msg)</span>
<span id="cb1-248"><a href=""></a></span>
<span id="cb1-249"><a href=""></a>    <span class="co"># ---- RequestVote ----</span></span>
<span id="cb1-250"><a href=""></a>    <span class="kw">def</span> handle_request_vote(<span class="va">self</span>, now_tick: <span class="bu">int</span>, m: <span class="bu">dict</span>):</span>
<span id="cb1-251"><a href=""></a>        cand_term <span class="op">=</span> m[<span class="st">"term"</span>]</span>
<span id="cb1-252"><a href=""></a>        cand <span class="op">=</span> m[<span class="st">"cand"</span>]</span>
<span id="cb1-253"><a href=""></a>        cand_last_term, cand_last_idx <span class="op">=</span> m[<span class="st">"last_term"</span>], m[<span class="st">"last_idx"</span>]</span>
<span id="cb1-254"><a href=""></a></span>
<span id="cb1-255"><a href=""></a>        grant <span class="op">=</span> <span class="va">False</span></span>
<span id="cb1-256"><a href=""></a>        <span class="cf">if</span> cand_term <span class="op">&lt;</span> <span class="va">self</span>.current_term:</span>
<span id="cb1-257"><a href=""></a>            grant <span class="op">=</span> <span class="va">False</span></span>
<span id="cb1-258"><a href=""></a>        <span class="cf">else</span>:</span>
<span id="cb1-259"><a href=""></a>            <span class="co"># 日志新鲜度：先比 term，再比 idx</span></span>
<span id="cb1-260"><a href=""></a>            my_last_term, my_last_idx <span class="op">=</span> <span class="va">self</span>.last_log_term(), <span class="va">self</span>.last_log_index()</span>
<span id="cb1-261"><a href=""></a>            up_to_date <span class="op">=</span> (cand_last_term <span class="op">&gt;</span> my_last_term) <span class="kw">or</span> (</span>
<span id="cb1-262"><a href=""></a>                cand_last_term <span class="op">==</span> my_last_term <span class="kw">and</span> cand_last_idx <span class="op">&gt;=</span> my_last_idx</span>
<span id="cb1-263"><a href=""></a>            )</span>
<span id="cb1-264"><a href=""></a>            free_or_same <span class="op">=</span> <span class="va">self</span>.voted_for <span class="kw">in</span> (<span class="va">None</span>, cand)</span>
<span id="cb1-265"><a href=""></a>            <span class="cf">if</span> up_to_date <span class="kw">and</span> free_or_same:</span>
<span id="cb1-266"><a href=""></a>                <span class="va">self</span>.voted_for <span class="op">=</span> cand</span>
<span id="cb1-267"><a href=""></a>                <span class="va">self</span>.rand_election_reset(now_tick)</span>
<span id="cb1-268"><a href=""></a>                grant <span class="op">=</span> <span class="va">True</span></span>
<span id="cb1-269"><a href=""></a>                <span class="co"># 若原本是 Candidate，成为 Follower</span></span>
<span id="cb1-270"><a href=""></a>                <span class="cf">if</span> <span class="va">self</span>.state <span class="op">!=</span> <span class="st">"Follower"</span>:</span>
<span id="cb1-271"><a href=""></a>                    <span class="va">self</span>.become_follower(cand_term)</span>
<span id="cb1-272"><a href=""></a>        <span class="va">self</span>.net.send(</span>
<span id="cb1-273"><a href=""></a>            now_tick, cand, msg_request_vote_resp(<span class="va">self</span>.current_term, <span class="va">self</span>.<span class="bu">id</span>, grant)</span>
<span id="cb1-274"><a href=""></a>        )</span>
<span id="cb1-275"><a href=""></a></span>
<span id="cb1-276"><a href=""></a>    <span class="co"># ---- AppendEntries ----</span></span>
<span id="cb1-277"><a href=""></a>    <span class="kw">def</span> handle_append(<span class="va">self</span>, now_tick: <span class="bu">int</span>, m: <span class="bu">dict</span>):</span>
<span id="cb1-278"><a href=""></a>        leader_term <span class="op">=</span> m[<span class="st">"term"</span>]</span>
<span id="cb1-279"><a href=""></a>        leader_id <span class="op">=</span> m[<span class="st">"leader"</span>]</span>
<span id="cb1-280"><a href=""></a>        prev_idx, prev_term <span class="op">=</span> m[<span class="st">"prev_idx"</span>], m[<span class="st">"prev_term"</span>]</span>
<span id="cb1-281"><a href=""></a>        entries: List[Entry] <span class="op">=</span> m[<span class="st">"entries"</span>]</span>
<span id="cb1-282"><a href=""></a>        leader_commit <span class="op">=</span> m[<span class="st">"leader_commit"</span>]</span>
<span id="cb1-283"><a href=""></a></span>
<span id="cb1-284"><a href=""></a>        <span class="co"># 心跳：看到 Leader 活着</span></span>
<span id="cb1-285"><a href=""></a>        <span class="va">self</span>.rand_election_reset(now_tick)</span>
<span id="cb1-286"><a href=""></a>        <span class="cf">if</span> leader_term <span class="op">&lt;</span> <span class="va">self</span>.current_term:</span>
<span id="cb1-287"><a href=""></a>            dlog(</span>
<span id="cb1-288"><a href=""></a>                <span class="st">"follower_append"</span>,</span>
<span id="cb1-289"><a href=""></a>                <span class="ss">f"[</span><span class="sc">{</span>now_tick<span class="sc">}</span><span class="ss">] Node</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">: REJECT APPEND from Leader</span><span class="sc">{</span>leader_id<span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb1-290"><a href=""></a>                <span class="ss">f"(term back </span><span class="sc">{</span>leader_term<span class="sc">}</span><span class="ss"> &lt; </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>current_term<span class="sc">}</span><span class="ss">)"</span>,</span>
<span id="cb1-291"><a href=""></a>            )</span>
<span id="cb1-292"><a href=""></a>            <span class="va">self</span>.net.send(</span>
<span id="cb1-293"><a href=""></a>                now_tick,</span>
<span id="cb1-294"><a href=""></a>                leader_id,</span>
<span id="cb1-295"><a href=""></a>                msg_append_resp(</span>
<span id="cb1-296"><a href=""></a>                    <span class="va">self</span>.current_term, <span class="va">self</span>.<span class="bu">id</span>, <span class="va">False</span>, <span class="va">self</span>.last_log_index()</span>
<span id="cb1-297"><a href=""></a>                ),</span>
<span id="cb1-298"><a href=""></a>            )</span>
<span id="cb1-299"><a href=""></a>            <span class="cf">return</span></span>
<span id="cb1-300"><a href=""></a></span>
<span id="cb1-301"><a href=""></a>        <span class="co"># Log Matching 检查</span></span>
<span id="cb1-302"><a href=""></a>        <span class="cf">if</span> prev_idx <span class="op">&gt;=</span> <span class="dv">0</span>:</span>
<span id="cb1-303"><a href=""></a>            <span class="cf">if</span> prev_idx <span class="op">&gt;</span> <span class="va">self</span>.last_log_index() <span class="kw">or</span> <span class="va">self</span>.log[prev_idx].term <span class="op">!=</span> prev_term:</span>
<span id="cb1-304"><a href=""></a>                <span class="co"># 不匹配：让 Leader 回退</span></span>
<span id="cb1-305"><a href=""></a>                dlog(</span>
<span id="cb1-306"><a href=""></a>                    <span class="st">"follower_append"</span>,</span>
<span id="cb1-307"><a href=""></a>                    <span class="ss">f"[</span><span class="sc">{</span>now_tick<span class="sc">}</span><span class="ss">] Node</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">: APPEND NACK (too short: have_last=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>last_log_index()<span class="sc">}</span><span class="ss">, "</span></span>
<span id="cb1-308"><a href=""></a>                    <span class="ss">f"need_prev=</span><span class="sc">{</span>prev_idx<span class="sc">}</span><span class="ss">)"</span>,</span>
<span id="cb1-309"><a href=""></a>                )</span>
<span id="cb1-310"><a href=""></a>                <span class="va">self</span>.net.send(</span>
<span id="cb1-311"><a href=""></a>                    now_tick,</span>
<span id="cb1-312"><a href=""></a>                    leader_id,</span>
<span id="cb1-313"><a href=""></a>                    msg_append_resp(</span>
<span id="cb1-314"><a href=""></a>                        <span class="va">self</span>.current_term, <span class="va">self</span>.<span class="bu">id</span>, <span class="va">False</span>, <span class="va">self</span>.last_log_index()</span>
<span id="cb1-315"><a href=""></a>                    ),</span>
<span id="cb1-316"><a href=""></a>                )</span>
<span id="cb1-317"><a href=""></a>                <span class="cf">return</span></span>
<span id="cb1-318"><a href=""></a>            <span class="cf">if</span> <span class="va">self</span>.log[prev_idx].term <span class="op">!=</span> prev_term:</span>
<span id="cb1-319"><a href=""></a>                <span class="co"># term 不匹配：要求回退</span></span>
<span id="cb1-320"><a href=""></a>                dlog(</span>
<span id="cb1-321"><a href=""></a>                    <span class="st">"follower_append"</span>,</span>
<span id="cb1-322"><a href=""></a>                    <span class="ss">f"[</span><span class="sc">{</span>now_tick<span class="sc">}</span><span class="ss">] Node</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">: APPEND NACK (term-mismatch at </span><span class="sc">{</span>prev_idx<span class="sc">}</span><span class="ss">: "</span></span>
<span id="cb1-323"><a href=""></a>                    <span class="ss">f"local=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>log[prev_idx]<span class="sc">.</span>term<span class="sc">}</span><span class="ss"> != prev_term=</span><span class="sc">{</span>prev_term<span class="sc">}</span><span class="ss">)"</span>,</span>
<span id="cb1-324"><a href=""></a>                )</span>
<span id="cb1-325"><a href=""></a>                <span class="va">self</span>.net.send(</span>
<span id="cb1-326"><a href=""></a>                    now_tick,</span>
<span id="cb1-327"><a href=""></a>                    leader_id,</span>
<span id="cb1-328"><a href=""></a>                    msg_append_resp(</span>
<span id="cb1-329"><a href=""></a>                        <span class="va">self</span>.current_term, <span class="va">self</span>.<span class="bu">id</span>, <span class="va">False</span>, <span class="va">self</span>.last_log_index()</span>
<span id="cb1-330"><a href=""></a>                    ),</span>
<span id="cb1-331"><a href=""></a>                )</span>
<span id="cb1-332"><a href=""></a>                <span class="cf">return</span></span>
<span id="cb1-333"><a href=""></a></span>
<span id="cb1-334"><a href=""></a>        <span class="co"># 追加/覆盖冲突</span></span>
<span id="cb1-335"><a href=""></a>        added <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb1-336"><a href=""></a>        <span class="cf">if</span> entries:</span>
<span id="cb1-337"><a href=""></a>            <span class="co"># 按顺序逐个处理（本演示每次最多 1 条）</span></span>
<span id="cb1-338"><a href=""></a>            idx <span class="op">=</span> prev_idx <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb1-339"><a href=""></a>            ent <span class="op">=</span> entries[<span class="dv">0</span>]</span>
<span id="cb1-340"><a href=""></a>            <span class="co"># 覆盖冲突</span></span>
<span id="cb1-341"><a href=""></a>            <span class="cf">if</span> <span class="va">self</span>.last_log_index() <span class="op">&gt;=</span> idx <span class="kw">and</span> <span class="va">self</span>.log[idx].term <span class="op">!=</span> ent.term:</span>
<span id="cb1-342"><a href=""></a>                <span class="va">self</span>.log <span class="op">=</span> <span class="va">self</span>.log[:idx]</span>
<span id="cb1-343"><a href=""></a>            <span class="cf">if</span> <span class="va">self</span>.last_log_index() <span class="op">&lt;</span> idx:</span>
<span id="cb1-344"><a href=""></a>                <span class="va">self</span>.log.append(ent)</span>
<span id="cb1-345"><a href=""></a>                added <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb1-346"><a href=""></a>            <span class="cf">else</span>:</span>
<span id="cb1-347"><a href=""></a>                <span class="co"># 相同 term 则认为相同（幂等）</span></span>
<span id="cb1-348"><a href=""></a>                <span class="cf">pass</span></span>
<span id="cb1-349"><a href=""></a></span>
<span id="cb1-350"><a href=""></a>        <span class="co"># 推进提交</span></span>
<span id="cb1-351"><a href=""></a>        <span class="cf">if</span> leader_commit <span class="op">&gt;</span> <span class="va">self</span>.commit_index:</span>
<span id="cb1-352"><a href=""></a>            <span class="va">self</span>.commit_index <span class="op">=</span> <span class="bu">min</span>(leader_commit, <span class="va">self</span>.last_log_index())</span>
<span id="cb1-353"><a href=""></a>        dlog(</span>
<span id="cb1-354"><a href=""></a>            <span class="st">"follower_append"</span>,</span>
<span id="cb1-355"><a href=""></a>            <span class="ss">f"[</span><span class="sc">{</span>now_tick<span class="sc">}</span><span class="ss">] Node</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss"> -&gt; Leader</span><span class="sc">{</span>leader_id<span class="sc">}</span><span class="ss">: "</span></span>
<span id="cb1-356"><a href=""></a>            <span class="ss">f"APPEND_RESP OK match=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>last_log_index()<span class="sc">}</span><span class="ss"> (added=</span><span class="sc">{</span>added<span class="sc">}</span><span class="ss">) commit=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>commit_index<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb1-357"><a href=""></a>        )</span>
<span id="cb1-358"><a href=""></a>        <span class="va">self</span>.net.send(</span>
<span id="cb1-359"><a href=""></a>            now_tick,</span>
<span id="cb1-360"><a href=""></a>            leader_id,</span>
<span id="cb1-361"><a href=""></a>            msg_append_resp(<span class="va">self</span>.current_term, <span class="va">self</span>.<span class="bu">id</span>, <span class="va">True</span>, <span class="va">self</span>.last_log_index()),</span>
<span id="cb1-362"><a href=""></a>        )</span>
<span id="cb1-363"><a href=""></a></span>
<span id="cb1-364"><a href=""></a>    <span class="kw">def</span> handle_append_resp(<span class="va">self</span>, now_tick: <span class="bu">int</span>, m: <span class="bu">dict</span>):</span>
<span id="cb1-365"><a href=""></a>        frm <span class="op">=</span> m[<span class="st">"from"</span>]</span>
<span id="cb1-366"><a href=""></a>        success <span class="op">=</span> m[<span class="st">"success"</span>]</span>
<span id="cb1-367"><a href=""></a>        match <span class="op">=</span> m[<span class="st">"match_index"</span>]</span>
<span id="cb1-368"><a href=""></a>        <span class="cf">if</span> success:</span>
<span id="cb1-369"><a href=""></a>            old_next <span class="op">=</span> <span class="va">self</span>.next_index[frm]</span>
<span id="cb1-370"><a href=""></a>            <span class="va">self</span>.match_index[frm] <span class="op">=</span> match</span>
<span id="cb1-371"><a href=""></a>            <span class="va">self</span>.next_index[frm] <span class="op">=</span> match <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb1-372"><a href=""></a>            dlog(</span>
<span id="cb1-373"><a href=""></a>                <span class="st">"append_resp"</span>,</span>
<span id="cb1-374"><a href=""></a>                <span class="ss">f"[</span><span class="sc">{</span>now_tick<span class="sc">}</span><span class="ss">] Leader</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss"> &lt;= Node</span><span class="sc">{</span>frm<span class="sc">}</span><span class="ss">: "</span></span>
<span id="cb1-375"><a href=""></a>                <span class="ss">f"APPEND_RESP success match=</span><span class="sc">{</span>match<span class="sc">}</span><span class="ss"> next_index: </span><span class="sc">{</span>old_next<span class="sc">}</span><span class="ss"> -&gt; </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>next_index[frm]<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb1-376"><a href=""></a>            )</span>
<span id="cb1-377"><a href=""></a>            <span class="va">self</span>.try_advance_commit(now_tick)</span>
<span id="cb1-378"><a href=""></a>        <span class="cf">else</span>:</span>
<span id="cb1-379"><a href=""></a>            old_next <span class="op">=</span> <span class="va">self</span>.next_index[frm]</span>
<span id="cb1-380"><a href=""></a>            <span class="co"># 回退并重试（最小化实现：-1）</span></span>
<span id="cb1-381"><a href=""></a>            <span class="va">self</span>.next_index[frm] <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, <span class="va">self</span>.next_index[frm] <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb1-382"><a href=""></a>            dlog(</span>
<span id="cb1-383"><a href=""></a>                <span class="st">"append_resp"</span>,</span>
<span id="cb1-384"><a href=""></a>                <span class="ss">f"[</span><span class="sc">{</span>now_tick<span class="sc">}</span><span class="ss">] Leader</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss"> &lt;= Node</span><span class="sc">{</span>frm<span class="sc">}</span><span class="ss">: "</span></span>
<span id="cb1-385"><a href=""></a>                <span class="ss">f"APPEND_RESP FAIL (follower_match=</span><span class="sc">{</span>match<span class="sc">}</span><span class="ss">) next_index: </span><span class="sc">{</span>old_next<span class="sc">}</span><span class="ss"> -&gt; </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>next_index[frm]<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb1-386"><a href=""></a>            )</span>
<span id="cb1-387"><a href=""></a>            <span class="co"># 立刻重发一次</span></span>
<span id="cb1-388"><a href=""></a>            <span class="va">self</span>.send_append_one(now_tick, frm)</span>
<span id="cb1-389"><a href=""></a></span>
<span id="cb1-390"><a href=""></a>    <span class="co"># ---- Leader：心跳与发送复制 ----</span></span>
<span id="cb1-391"><a href=""></a>    <span class="kw">def</span> send_heartbeats(<span class="va">self</span>, now_tick: <span class="bu">int</span>):</span>
<span id="cb1-392"><a href=""></a>        <span class="cf">if</span> <span class="va">self</span>.state <span class="op">!=</span> <span class="st">"Leader"</span>:</span>
<span id="cb1-393"><a href=""></a>            <span class="cf">return</span></span>
<span id="cb1-394"><a href=""></a>        <span class="cf">for</span> p <span class="kw">in</span> <span class="va">self</span>.peers:</span>
<span id="cb1-395"><a href=""></a>            <span class="cf">if</span> p <span class="op">==</span> <span class="va">self</span>.<span class="bu">id</span>:</span>
<span id="cb1-396"><a href=""></a>                <span class="cf">continue</span></span>
<span id="cb1-397"><a href=""></a>            <span class="va">self</span>.send_append_one(now_tick, p)</span>
<span id="cb1-398"><a href=""></a></span>
<span id="cb1-399"><a href=""></a>    <span class="kw">def</span> send_append_one(<span class="va">self</span>, now_tick: <span class="bu">int</span>, follower: <span class="bu">int</span>):</span>
<span id="cb1-400"><a href=""></a>        prev_idx <span class="op">=</span> <span class="va">self</span>.next_index[follower] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb1-401"><a href=""></a>        prev_term <span class="op">=</span> <span class="va">self</span>.log[prev_idx].term <span class="cf">if</span> prev_idx <span class="op">&gt;=</span> <span class="dv">0</span> <span class="cf">else</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb1-402"><a href=""></a>        <span class="co"># 逐条发：从 next_index 开始拿 1 条</span></span>
<span id="cb1-403"><a href=""></a>        entries <span class="op">=</span> []</span>
<span id="cb1-404"><a href=""></a>        <span class="cf">if</span> <span class="va">self</span>.next_index[follower] <span class="op">&lt;=</span> <span class="va">self</span>.last_log_index():</span>
<span id="cb1-405"><a href=""></a>            entries <span class="op">=</span> [<span class="va">self</span>.log[<span class="va">self</span>.next_index[follower]]]</span>
<span id="cb1-406"><a href=""></a>        dlog(</span>
<span id="cb1-407"><a href=""></a>            <span class="st">"send_append"</span>,</span>
<span id="cb1-408"><a href=""></a>            <span class="ss">f"[</span><span class="sc">{</span>now_tick<span class="sc">}</span><span class="ss">] Leader</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss"> -&gt; Node</span><span class="sc">{</span>follower<span class="sc">}</span><span class="ss">: "</span></span>
<span id="cb1-409"><a href=""></a>            <span class="ss">f"APPEND(prev=</span><span class="sc">{</span>prev_idx<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>prev_term<span class="sc">}</span><span class="ss">, send=</span><span class="sc">{</span><span class="bu">len</span>(entries)<span class="sc">}</span><span class="ss">, leaderCommit=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>commit_index<span class="sc">}</span><span class="ss">)"</span>,</span>
<span id="cb1-410"><a href=""></a>        )</span>
<span id="cb1-411"><a href=""></a>        <span class="va">self</span>.net.send(</span>
<span id="cb1-412"><a href=""></a>            now_tick,</span>
<span id="cb1-413"><a href=""></a>            follower,</span>
<span id="cb1-414"><a href=""></a>            msg_append(</span>
<span id="cb1-415"><a href=""></a>                <span class="va">self</span>.current_term,</span>
<span id="cb1-416"><a href=""></a>                <span class="va">self</span>.<span class="bu">id</span>,</span>
<span id="cb1-417"><a href=""></a>                prev_idx,</span>
<span id="cb1-418"><a href=""></a>                prev_term,</span>
<span id="cb1-419"><a href=""></a>                entries,</span>
<span id="cb1-420"><a href=""></a>                <span class="va">self</span>.commit_index,</span>
<span id="cb1-421"><a href=""></a>            ),</span>
<span id="cb1-422"><a href=""></a>        )</span>
<span id="cb1-423"><a href=""></a></span>
<span id="cb1-424"><a href=""></a>    <span class="co"># ---- 多数派提交（仅当前任期） ----</span></span>
<span id="cb1-425"><a href=""></a>    <span class="kw">def</span> try_advance_commit(<span class="va">self</span>, now_tick: <span class="bu">int</span>):</span>
<span id="cb1-426"><a href=""></a>        <span class="co"># 只推进当前任期的日志</span></span>
<span id="cb1-427"><a href=""></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.last_log_index(), <span class="va">self</span>.commit_index, <span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb1-428"><a href=""></a>            <span class="cf">if</span> <span class="va">self</span>.log[i].term <span class="op">!=</span> <span class="va">self</span>.current_term:</span>
<span id="cb1-429"><a href=""></a>                <span class="cf">continue</span></span>
<span id="cb1-430"><a href=""></a>            <span class="co"># 统计有多少副本（含 Leader 自己）已匹配到 &gt;= i</span></span>
<span id="cb1-431"><a href=""></a>            cnt <span class="op">=</span> <span class="dv">1</span>  <span class="co"># self</span></span>
<span id="cb1-432"><a href=""></a>            <span class="cf">for</span> p, m_idx <span class="kw">in</span> <span class="va">self</span>.match_index.items():</span>
<span id="cb1-433"><a href=""></a>                <span class="cf">if</span> p <span class="op">==</span> <span class="va">self</span>.<span class="bu">id</span>:  <span class="co"># 不会出现，但以防万一</span></span>
<span id="cb1-434"><a href=""></a>                    <span class="cf">continue</span></span>
<span id="cb1-435"><a href=""></a>                <span class="cf">if</span> m_idx <span class="op">&gt;=</span> i:</span>
<span id="cb1-436"><a href=""></a>                    cnt <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb1-437"><a href=""></a>            <span class="cf">if</span> cnt <span class="op">&gt;=</span> <span class="va">self</span>.majority():</span>
<span id="cb1-438"><a href=""></a>                <span class="va">self</span>.commit_index <span class="op">=</span> i</span>
<span id="cb1-439"><a href=""></a>                <span class="bu">print</span>(<span class="ss">f"[</span><span class="sc">{</span>now_tick<span class="sc">}</span><span class="ss">] Leader</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">: commit -&gt; </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>commit_index<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-440"><a href=""></a>                <span class="cf">break</span></span>
<span id="cb1-441"><a href=""></a></span>
<span id="cb1-442"><a href=""></a>    <span class="co"># ---- 应用到状态机（银行转账） ----</span></span>
<span id="cb1-443"><a href=""></a>    <span class="kw">def</span> apply_commits(<span class="va">self</span>, now_tick: <span class="bu">int</span>):</span>
<span id="cb1-444"><a href=""></a>        <span class="cf">while</span> <span class="va">self</span>.last_applied <span class="op">&lt;</span> <span class="va">self</span>.commit_index:</span>
<span id="cb1-445"><a href=""></a>            <span class="va">self</span>.last_applied <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb1-446"><a href=""></a>            ent <span class="op">=</span> <span class="va">self</span>.log[<span class="va">self</span>.last_applied]</span>
<span id="cb1-447"><a href=""></a>            <span class="va">self</span>.apply_cmd(ent.cmd, now_tick)</span>
<span id="cb1-448"><a href=""></a></span>
<span id="cb1-449"><a href=""></a>    <span class="kw">def</span> apply_cmd(<span class="va">self</span>, cmd: <span class="bu">str</span>, now_tick: <span class="bu">int</span>):</span>
<span id="cb1-450"><a href=""></a>        <span class="co"># 仅支持：transfer A B 100</span></span>
<span id="cb1-451"><a href=""></a>        <span class="cf">try</span>:</span>
<span id="cb1-452"><a href=""></a>            op, a, b, amt <span class="op">=</span> cmd.split()</span>
<span id="cb1-453"><a href=""></a>            amt <span class="op">=</span> <span class="bu">int</span>(amt)</span>
<span id="cb1-454"><a href=""></a>            <span class="cf">if</span> op <span class="op">!=</span> <span class="st">"transfer"</span>:</span>
<span id="cb1-455"><a href=""></a>                <span class="cf">return</span></span>
<span id="cb1-456"><a href=""></a>            <span class="va">self</span>.state_machine[a] <span class="op">-=</span> amt</span>
<span id="cb1-457"><a href=""></a>            <span class="va">self</span>.state_machine[b] <span class="op">+=</span> amt</span>
<span id="cb1-458"><a href=""></a>            <span class="cf">if</span> <span class="va">self</span>.<span class="bu">id</span> <span class="op">==</span> <span class="dv">0</span>:  <span class="co"># 只让一个节点打印，避免刷屏</span></span>
<span id="cb1-459"><a href=""></a>                dlog(</span>
<span id="cb1-460"><a href=""></a>                    <span class="st">"apply"</span>,</span>
<span id="cb1-461"><a href=""></a>                    <span class="ss">f"[</span><span class="sc">{</span>now_tick<span class="sc">}</span><span class="ss">] Node</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss"> APPLY: </span><span class="sc">{</span>cmd<span class="sc">}</span><span class="ss"> ; State=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>state_machine<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb1-462"><a href=""></a>                )</span>
<span id="cb1-463"><a href=""></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb1-464"><a href=""></a>            <span class="cf">pass</span></span>
<span id="cb1-465"><a href=""></a></span>
<span id="cb1-466"><a href=""></a>    <span class="co"># ---- 客户端请求入口（仅 Leader 调用） ----</span></span>
<span id="cb1-467"><a href=""></a>    <span class="kw">def</span> propose(<span class="va">self</span>, now_tick: <span class="bu">int</span>, cmd: <span class="bu">str</span>):</span>
<span id="cb1-468"><a href=""></a>        <span class="cf">if</span> <span class="va">self</span>.state <span class="op">!=</span> <span class="st">"Leader"</span> <span class="kw">or</span> <span class="kw">not</span> <span class="va">self</span>.alive:</span>
<span id="cb1-469"><a href=""></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb1-470"><a href=""></a>        <span class="va">self</span>.log.append(Entry(<span class="va">self</span>.current_term, cmd))</span>
<span id="cb1-471"><a href=""></a>        <span class="co"># 自己等价于已匹配</span></span>
<span id="cb1-472"><a href=""></a>        <span class="va">self</span>.match_index[<span class="va">self</span>.<span class="bu">id</span>] <span class="op">=</span> <span class="va">self</span>.last_log_index()</span>
<span id="cb1-473"><a href=""></a>        <span class="co"># 立刻对各 Follower 发送一次</span></span>
<span id="cb1-474"><a href=""></a>        <span class="cf">for</span> p <span class="kw">in</span> <span class="va">self</span>.peers:</span>
<span id="cb1-475"><a href=""></a>            <span class="cf">if</span> p <span class="op">==</span> <span class="va">self</span>.<span class="bu">id</span>:</span>
<span id="cb1-476"><a href=""></a>                <span class="cf">continue</span></span>
<span id="cb1-477"><a href=""></a>            <span class="va">self</span>.send_append_one(now_tick, p)</span>
<span id="cb1-478"><a href=""></a>        <span class="bu">print</span>(</span>
<span id="cb1-479"><a href=""></a>            <span class="ss">f"[</span><span class="sc">{</span>now_tick<span class="sc">}</span><span class="ss">] Leader</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">: propose -&gt; </span><span class="sc">{</span>cmd<span class="sc">}</span><span class="ss"> (idx=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>last_log_index()<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb1-480"><a href=""></a>        )</span>
<span id="cb1-481"><a href=""></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb1-482"><a href=""></a></span>
<span id="cb1-483"><a href=""></a></span>
<span id="cb1-484"><a href=""></a><span class="co"># ========= 仿真驱动 =========</span></span>
<span id="cb1-485"><a href=""></a><span class="kw">def</span> run_demo():</span>
<span id="cb1-486"><a href=""></a>    net <span class="op">=</span> Network()</span>
<span id="cb1-487"><a href=""></a>    nodes <span class="op">=</span> [Node(i, <span class="bu">list</span>(<span class="bu">range</span>(N)), net) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N)]</span>
<span id="cb1-488"><a href=""></a></span>
<span id="cb1-489"><a href=""></a>    <span class="co"># 演示脚本控制</span></span>
<span id="cb1-490"><a href=""></a>    injected <span class="op">=</span> <span class="va">False</span></span>
<span id="cb1-491"><a href=""></a>    crashed_leader_id: Optional[<span class="bu">int</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-492"><a href=""></a></span>
<span id="cb1-493"><a href=""></a>    <span class="cf">for</span> now <span class="kw">in</span> <span class="bu">range</span>(T_MAX <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb1-494"><a href=""></a>        <span class="co"># 1) tick</span></span>
<span id="cb1-495"><a href=""></a>        <span class="cf">for</span> nd <span class="kw">in</span> nodes:</span>
<span id="cb1-496"><a href=""></a>            nd.tick(now)</span>
<span id="cb1-497"><a href=""></a></span>
<span id="cb1-498"><a href=""></a>        <span class="co"># 2) 网络投递</span></span>
<span id="cb1-499"><a href=""></a>        <span class="cf">for</span> to_id, msg <span class="kw">in</span> net.deliver(now):</span>
<span id="cb1-500"><a href=""></a>            nodes[to_id].on_msg(now, msg)</span>
<span id="cb1-501"><a href=""></a></span>
<span id="cb1-502"><a href=""></a>        <span class="co"># 3) 若产生 Leader，注入一笔交易（仅限一次）</span></span>
<span id="cb1-503"><a href=""></a>        leader <span class="op">=</span> first_leader(nodes)</span>
<span id="cb1-504"><a href=""></a>        <span class="cf">if</span> leader <span class="kw">and</span> <span class="kw">not</span> injected <span class="kw">and</span> now <span class="op">&gt;</span> <span class="dv">30</span>:</span>
<span id="cb1-505"><a href=""></a>            ok <span class="op">=</span> leader.propose(now, <span class="st">"transfer A B 100"</span>)</span>
<span id="cb1-506"><a href=""></a>            <span class="cf">if</span> ok:</span>
<span id="cb1-507"><a href=""></a>                injected <span class="op">=</span> <span class="va">True</span></span>
<span id="cb1-508"><a href=""></a></span>
<span id="cb1-509"><a href=""></a>        <span class="co"># 4) 整死 Leader，观察重选；再恢复</span></span>
<span id="cb1-510"><a href=""></a>        <span class="cf">if</span> leader <span class="kw">and</span> now <span class="op">==</span> CRASH_LEADER_AT:</span>
<span id="cb1-511"><a href=""></a>            leader.alive <span class="op">=</span> <span class="va">False</span></span>
<span id="cb1-512"><a href=""></a>            crashed_leader_id <span class="op">=</span> leader.<span class="bu">id</span></span>
<span id="cb1-513"><a href=""></a>            <span class="bu">print</span>(<span class="ss">f"[</span><span class="sc">{</span>now<span class="sc">}</span><span class="ss">] !!! Crash Leader</span><span class="sc">{</span>leader<span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-514"><a href=""></a></span>
<span id="cb1-515"><a href=""></a>        <span class="cf">if</span> crashed_leader_id <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> now <span class="op">==</span> RECOVER_LEADER_AT:</span>
<span id="cb1-516"><a href=""></a>            nodes[crashed_leader_id].alive <span class="op">=</span> <span class="va">True</span></span>
<span id="cb1-517"><a href=""></a>            nodes[crashed_leader_id].rand_election_reset(now)</span>
<span id="cb1-518"><a href=""></a>            <span class="bu">print</span>(<span class="ss">f"[</span><span class="sc">{</span>now<span class="sc">}</span><span class="ss">] &gt;&gt;&gt; Recover Node</span><span class="sc">{</span>crashed_leader_id<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-519"><a href=""></a>            crashed_leader_id <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-520"><a href=""></a></span>
<span id="cb1-521"><a href=""></a>    <span class="co"># 打印各节点终态</span></span>
<span id="cb1-522"><a href=""></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== FINAL STATES ==="</span>)</span>
<span id="cb1-523"><a href=""></a>    <span class="cf">for</span> nd <span class="kw">in</span> nodes:</span>
<span id="cb1-524"><a href=""></a>        <span class="bu">print</span>(</span>
<span id="cb1-525"><a href=""></a>            <span class="ss">f"Node</span><span class="sc">{</span>nd<span class="sc">.</span><span class="bu">id</span><span class="sc">}</span><span class="ss"> term=</span><span class="sc">{</span>nd<span class="sc">.</span>current_term<span class="sc">}</span><span class="ss"> role=</span><span class="sc">{</span>nd<span class="sc">.</span>state<span class="sc">:9}</span><span class="ss"> "</span></span>
<span id="cb1-526"><a href=""></a>            <span class="ss">f"commit=</span><span class="sc">{</span>nd<span class="sc">.</span>commit_index<span class="sc">}</span><span class="ss"> applied=</span><span class="sc">{</span>nd<span class="sc">.</span>last_applied<span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb1-527"><a href=""></a>            <span class="ss">f"SM=</span><span class="sc">{</span>nd<span class="sc">.</span>state_machine<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb1-528"><a href=""></a>        )</span>
<span id="cb1-529"><a href=""></a></span>
<span id="cb1-530"><a href=""></a></span>
<span id="cb1-531"><a href=""></a><span class="kw">def</span> first_leader(nodes: List[Node]) <span class="op">-&gt;</span> Optional[Node]:</span>
<span id="cb1-532"><a href=""></a>    <span class="cf">for</span> nd <span class="kw">in</span> nodes:</span>
<span id="cb1-533"><a href=""></a>        <span class="cf">if</span> nd.state <span class="op">==</span> <span class="st">"Leader"</span> <span class="kw">and</span> nd.alive:</span>
<span id="cb1-534"><a href=""></a>            <span class="cf">return</span> nd</span>
<span id="cb1-535"><a href=""></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb1-536"><a href=""></a></span>
<span id="cb1-537"><a href=""></a></span>
<span id="cb1-538"><a href=""></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb1-539"><a href=""></a>    run_demo()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="常见错误" class="slide level2">
<h2>常见错误</h2>
<ol type="1">
<li><strong>误把心跳当提交</strong>：AppendEntries 成功 ≠ 已提交，必须满足<strong>提交规则</strong></li>
<li><strong>日志新旧写反了</strong>：应先比 term，后比 index</li>
<li><strong>Follower 不删冲突</strong>：收到冲突检查后必须<strong>截断</strong></li>
<li><strong>非确定性状态机</strong>：时间戳或随机数参与结果导致同序不同果</li>
<li><strong>读一致性疏忽</strong>：Leader 过期仍在提供线性读</li>
<li><strong>成员变更一步切换</strong>：应经过<strong>联合共识</strong></li>
</ol>
</section></section>
<section>
<section id="总结-预告" class="title-slide slide level1 center">
<h1>总结 &amp; 预告</h1>

</section>
<section id="本讲小结" class="slide level2">
<h2>本讲小结</h2>
<ul>
<li><strong>复制操作</strong>优于<strong>复制状态</strong>的关键在于：<strong>确定性状态机 + 一致顺序</strong></li>
<li><strong>Raft</strong>把共识拆解为“选举、复制、安全”三个子问题，以<strong>任期</strong>与<strong>多数派</strong>贯穿，记住：随机超时选主、日志匹配校验、当前任期提交等具体规则</li>
<li>理念同宗，路径不同：<strong>Paxos</strong>提供理论基石，<strong>Raft</strong>提供工程落地</li>
</ul>
</section>
<section id="思考题" class="slide level2">
<h2>思考题</h2>
<ol type="1">
<li>为什么选举超时必须<strong>随机化</strong>？</li>
<li>若 4 节点分区成 2|2，会发生什么？如何恢复？</li>
<li>设计一个<strong>非确定性操作</strong>（如使用 <code>random()</code>），说明为什么会破坏 SMR</li>
<li>如果把“复制状态”与“复制操作”结合使用，会带来哪些工程优势？</li>
</ol>
</section>
<section id="下节预告" class="slide level2">
<h2>下节预告</h2>
<p>分区与分片</p>
<ul>
<li>如何切分数据？</li>
<li>如果有节点数量变动了怎么办？</li>
</ul>
</section>
<section id="作业-2raft-青春版" class="slide level2 smaller">
<h2>作业 #2：Raft 青春版</h2>
<p>编程实现“选举+心跳+日志追加”的 <strong>Raft 青春版</strong>。并应用于你感兴趣的业务场景的特定状态机，故意制造 Leader 宕机故障。打印状态转移与提交点。<strong>业务场景</strong>例如：</p>
<table class="caption-top">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>场景</th>
<th>状态</th>
<th>命令</th>
<th>观察点</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>计数器</td>
<td><code>value</code>, <code>seen_ids</code></td>
<td><code>inc delta uuid</code></td>
<td>重复递交不会二次累加</td>
</tr>
<tr class="even">
<td>井字棋</td>
<td><code>board[3,3]</code>, <code>turn</code>, <code>winner</code></td>
<td><code>place x y player</code></td>
<td>非法操作被拒绝；一致胜负</td>
</tr>
<tr class="odd">
<td>工作流审批</td>
<td><code>{doc → state}</code></td>
<td><code>submit doc</code>, <code>approve doc role</code>, <code>reject doc role</code></td>
<td>顺序化审批链；只读查询一致性</td>
</tr>
<tr class="even">
<td>待办看板</td>
<td><code>{task_id → {text, column, assignment}</code></td>
<td><code>new id "text"</code>, <code>move id column</code>, <code>assign id user</code>, <code>done id</code></td>
<td>合法迁移约束 ToDo→Doing→Done</td>
</tr>
</tbody>
</table>
</section>
<section id="参考资料与延伸阅读" class="slide level2">
<h2>参考资料与延伸阅读</h2>
<ul>
<li><em>In Search of an Understandable Consensus Algorithm (Raft)</em></li>
<li><em>Paxos Made Simple</em></li>
<li>状态机复制、线性一致读等</li>
</ul>

</section></section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">

</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="slide03_files/libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="slide03_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="slide03_files/libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="slide03_files/libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="slide03_files/libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="slide03_files/libs/revealjs/plugin/reveal-chalkboard/plugin.js"></script>
  <script src="slide03_files/libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="slide03_files/libs/revealjs/plugin/notes/notes.js"></script>
  <script src="slide03_files/libs/revealjs/plugin/search/search.js"></script>
  <script src="slide03_files/libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="slide03_files/libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': true,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleChalkboard(event)\"><kbd>b</kbd> Toggle Chalkboard</a></li>\n<li class=\"slide-tool-item\" data-item=\"6\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleNotesCanvas(event)\"><kbd>c</kbd> Toggle Notes Canvas</a></li>\n<li class=\"slide-tool-item\" data-item=\"7\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.downloadDrawings(event)\"><kbd>d</kbd> Download Drawings</a></li>\n<li class=\"slide-tool-item\" data-item=\"8\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'chalkboard': {"buttons":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'slide',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, RevealChalkboard, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script id="quarto-html-after-body" type="application/javascript">
      window.document.addEventListener("DOMContentLoaded", function (event) {
        const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
        tabsets.forEach(function(tabset) {
          const tabby = new Tabby('#' + tabset.id);
        });
        const isCodeAnnotation = (el) => {
          for (const clz of el.classList) {
            if (clz.startsWith('code-annotation-')) {                     
              return true;
            }
          }
          return false;
        }
        const onCopySuccess = function(e) {
          // button target
          const button = e.trigger;
          // don't keep focus
          button.blur();
          // flash "checked"
          button.classList.add('code-copy-button-checked');
          var currentTitle = button.getAttribute("title");
          button.setAttribute("title", "已复制");
          let tooltip;
          if (window.bootstrap) {
            button.setAttribute("data-bs-toggle", "tooltip");
            button.setAttribute("data-bs-placement", "left");
            button.setAttribute("data-bs-title", "已复制");
            tooltip = new bootstrap.Tooltip(button, 
              { trigger: "manual", 
                customClass: "code-copy-button-tooltip",
                offset: [0, -8]});
            tooltip.show();    
          }
          setTimeout(function() {
            if (tooltip) {
              tooltip.hide();
              button.removeAttribute("data-bs-title");
              button.removeAttribute("data-bs-toggle");
              button.removeAttribute("data-bs-placement");
            }
            button.setAttribute("title", currentTitle);
            button.classList.remove('code-copy-button-checked');
          }, 1000);
          // clear code selection
          e.clearSelection();
        }
        const getTextToCopy = function(trigger) {
            const codeEl = trigger.previousElementSibling.cloneNode(true);
            for (const childEl of codeEl.children) {
              if (isCodeAnnotation(childEl)) {
                childEl.remove();
              }
            }
            return codeEl.innerText;
        }
        const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
          text: getTextToCopy
        });
        clipboard.on('success', onCopySuccess);
        if (window.document.getElementById('quarto-embedded-source-code-modal')) {
          const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
            text: getTextToCopy,
            container: window.document.getElementById('quarto-embedded-source-code-modal')
          });
          clipboardModal.on('success', onCopySuccess);
        }
          var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
          var mailtoRegex = new RegExp(/^mailto:/);
            var filterRegex = new RegExp('/' + window.location.host + '/');
          var isInternal = (href) => {
              return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
          }
          // Inspect non-navigation links and adorn them if external
         var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
          for (var i=0; i<links.length; i++) {
            const link = links[i];
            if (!isInternal(link.href)) {
              // undo the damage that might have been done by quarto-nav.js in the case of
              // links that we want to consider external
              if (link.dataset.originalHref !== undefined) {
                link.href = link.dataset.originalHref;
              }
            }
          }
        function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
          const config = {
            allowHTML: true,
            maxWidth: 500,
            delay: 100,
            arrow: false,
            appendTo: function(el) {
                return el.closest('section.slide') || el.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'light-border',
            placement: 'bottom-start',
          };
          if (contentFn) {
            config.content = contentFn;
          }
          if (onTriggerFn) {
            config.onTrigger = onTriggerFn;
          }
          if (onUntriggerFn) {
            config.onUntrigger = onUntriggerFn;
          }
            config['offset'] = [0,0];
            config['maxWidth'] = 700;
          window.tippy(el, config); 
        }
        const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
        for (var i=0; i<noterefs.length; i++) {
          const ref = noterefs[i];
          tippyHover(ref, function() {
            // use id or data attribute instead here
            let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
            try { href = new URL(href).hash; } catch {}
            const id = href.replace(/^#\/?/, "");
            const note = window.document.getElementById(id);
            if (note) {
              return note.innerHTML;
            } else {
              return "";
            }
          });
        }
        const findCites = (el) => {
          const parentEl = el.parentElement;
          if (parentEl) {
            const cites = parentEl.dataset.cites;
            if (cites) {
              return {
                el,
                cites: cites.split(' ')
              };
            } else {
              return findCites(el.parentElement)
            }
          } else {
            return undefined;
          }
        };
        var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
        for (var i=0; i<bibliorefs.length; i++) {
          const ref = bibliorefs[i];
          const citeInfo = findCites(ref);
          if (citeInfo) {
            tippyHover(citeInfo.el, function() {
              var popup = window.document.createElement('div');
              citeInfo.cites.forEach(function(cite) {
                var citeDiv = window.document.createElement('div');
                citeDiv.classList.add('hanging-indent');
                citeDiv.classList.add('csl-entry');
                var biblioDiv = window.document.getElementById('ref-' + cite);
                if (biblioDiv) {
                  citeDiv.innerHTML = biblioDiv.innerHTML;
                }
                popup.appendChild(citeDiv);
              });
              return popup.innerHTML;
            });
          }
        }
      });
      </script>
    

</body></html>