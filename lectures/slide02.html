<!DOCTYPE html>
<html lang="zh-CN"><head>
<script src="slide02_files/libs/clipboard/clipboard.min.js"></script>
<script src="slide02_files/libs/quarto-html/tabby.min.js"></script>
<script src="slide02_files/libs/quarto-html/popper.min.js"></script>
<script src="slide02_files/libs/quarto-html/tippy.umd.min.js"></script>
<link href="slide02_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="slide02_files/libs/quarto-html/light-border.css" rel="stylesheet">
<link href="slide02_files/libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.7.33">

  <meta name="author" content="叶鸿">
  <meta name="dcterms.date" content="2025-09-10">
  <title>分布式数据库开发</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="slide02_files/libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="slide02_files/libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="slide02_files/libs/revealjs/dist/theme/quarto-f563837468303362081e247dddd440d0.css">
  <link href="slide02_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="slide02_files/libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="slide02_files/libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="slide02_files/libs/revealjs/plugin/reveal-chalkboard/font-awesome/css/all.css" rel="stylesheet">
  <link href="slide02_files/libs/revealjs/plugin/reveal-chalkboard/style.css" rel="stylesheet">
  <link href="slide02_files/libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
  <script src="slide02_files/libs/quarto-diagram/mermaid-postprocess-shim.js"></script>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">分布式数据库开发</h1>
  <p class="subtitle">第1讲：分布式时间观</p>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
叶鸿 
</div>
</div>
</div>

  <p class="date">2025-09-10</p>
</section>
<section id="为什么先谈时间" class="slide level2">
<h2>为什么先谈“时间”？</h2>
<ul>
<li>在分布式系统里，没有任何节点能掌握<strong>全局唯一正确时刻</strong><br>
</li>
<li>一致性、故障恢复、性能优化等问题的“根”往往指向<strong>时间与顺序</strong></li>
<li>问题：<strong>没有全局时钟</strong>的世界里，怎样定义“先后”？怎样复现“正确的顺序”？</li>
</ul>
<div class="callout callout-warning callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>警告</strong></p>
</div>
<div class="callout-content">
<p>同一瞬间在不同机器上的“时间”并非一致；网络延迟、时钟漂移与回拨都会打乱我们以为天然存在的顺序。</p>
</div>
</div>
</div>
</section>
<section id="学习目标" class="slide level2">
<h2>学习目标</h2>
<ul>
<li>解释物理时钟的局限（NTP精度、漂移、回拨/闰秒）</li>
<li>掌握 <strong>Lamport 时钟</strong> 与 <strong>向量时钟</strong> 的思想与规则</li>
<li>理解 <strong>Google Spanner TrueTime</strong> 与 <strong>混合逻辑时钟（HLC）</strong></li>
<li>将“时间”映射为<strong>日志（WAL / 事件溯源）</strong>以获得确定性重放</li>
</ul>
</section>
<section>
<section id="物理时间" class="title-slide slide level1 center">
<h1>物理时间</h1>

</section>
<section id="思考银行转账的-1ms" class="slide level2">
<h2>思考：银行转账的 1ms</h2>
<ul>
<li class="fragment">北京 ATM：15:00:00.000 取款 ¥1000<br>
</li>
<li class="fragment">上海手机：15:00:00.001 查询余额<br>
</li>
<li class="fragment">看到的是<strong>扣款前</strong>还是<strong>扣款后</strong>的余额？</li>
<li class="fragment">复杂性来源：
<ul>
<li class="fragment">网络延迟</li>
<li class="fragment">服务器时钟偏差</li>
<li class="fragment">不可判定的“先后”</li>
</ul></li>
</ul>
</section>
<section id="单机数据库的情况" class="slide level2 smaller">
<h2>单机数据库的情况</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<svg aria-roledescription="sequence" role="graphics-document document" viewbox="-50 -10 965 581" style="; display: block; margin: auto auto auto auto" xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="960" id="mermaid-figure-1" height="480">
<rect class="rect" height="69" width="283" fill="rgba(220,255,220,0.45)" y="360" x="526.5"></rect><g><rect class="actor actor-bottom" ry="3" rx="3" name="DB" height="65" width="150" stroke="#666" fill="#eaeaea" y="495" x="593"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="527.5" x="668"><tspan dy="0" x="668">单机数据库</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="Phone_SH" height="65" width="150" stroke="#666" fill="#eaeaea" y="495" x="200"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="527.5" x="275"><tspan dy="0" x="275">上海手机</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="ATM_BJ" height="65" width="150" stroke="#666" fill="#eaeaea" y="495" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="527.5" x="75"><tspan dy="0" x="75">北京ATM</tspan></text></g><g><line name="DB" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="495" x2="668" y1="5" x1="668" id="actor2"></line><g id="root-2"><rect class="actor actor-top" ry="3" rx="3" name="DB" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="593"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="668"><tspan dy="0" x="668">单机数据库</tspan></text></g></g><g><line name="Phone_SH" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="495" x2="275" y1="5" x1="275" id="actor1"></line><g id="root-1"><rect class="actor actor-top" ry="3" rx="3" name="Phone_SH" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="200"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="275"><tspan dy="0" x="275">上海手机</tspan></text></g></g><g><line name="ATM_BJ" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="495" x2="75" y1="5" x1="75" id="actor0"></line><g id="root-0"><rect class="actor actor-top" ry="3" rx="3" name="ATM_BJ" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="75"><tspan dy="0" x="75">北京ATM</tspan></text></g></g>
<style>#mermaid-figure-1{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-figure-1 .error-icon{fill:#552222;}#mermaid-figure-1 .error-text{fill:#552222;stroke:#552222;}#mermaid-figure-1 .edge-thickness-normal{stroke-width:1px;}#mermaid-figure-1 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-figure-1 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-figure-1 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-figure-1 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-figure-1 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-figure-1 .marker{fill:#333333;stroke:#333333;}#mermaid-figure-1 .marker.cross{stroke:#333333;}#mermaid-figure-1 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-figure-1 p{margin:0;}#mermaid-figure-1 .actor{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-1 text.actor>tspan{fill:black;stroke:none;}#mermaid-figure-1 .actor-line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-1 .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaid-figure-1 .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaid-figure-1 #mermaid-figure-1-arrowhead path{fill:#333;stroke:#333;}#mermaid-figure-1 .sequenceNumber{fill:white;}#mermaid-figure-1 #mermaid-figure-1-sequencenumber{fill:#333;}#mermaid-figure-1 #mermaid-figure-1-crosshead path{fill:#333;stroke:#333;}#mermaid-figure-1 .messageText{fill:#333;stroke:none;}#mermaid-figure-1 .labelBox{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-1 .labelText,#mermaid-figure-1 .labelText>tspan{fill:black;stroke:none;}#mermaid-figure-1 .loopText,#mermaid-figure-1 .loopText>tspan{fill:black;stroke:none;}#mermaid-figure-1 .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-1 .note{stroke:#aaaa33;fill:#fff5ad;}#mermaid-figure-1 .noteText,#mermaid-figure-1 .noteText>tspan{fill:black;stroke:none;}#mermaid-figure-1 .activation0{fill:#f4f4f4;stroke:#666;}#mermaid-figure-1 .activation1{fill:#f4f4f4;stroke:#666;}#mermaid-figure-1 .activation2{fill:#f4f4f4;stroke:#666;}#mermaid-figure-1 .actorPopupMenu{position:absolute;}#mermaid-figure-1 .actorPopupMenuPanel{position:absolute;fill:#ECECFF;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);filter:drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4));}#mermaid-figure-1 .actor-man line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-1 .actor-man circle,#mermaid-figure-1 line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;stroke-width:2px;}#mermaid-figure-1 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style>
<g></g><defs><symbol height="24" width="24" id="mermaid-figure-1-computer"><path d="M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z" transform="scale(.5)"></path></symbol></defs><defs><symbol clip-rule="evenodd" fill-rule="evenodd" id="mermaid-figure-1-database"><path d="M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z" transform="scale(.5)"></path></symbol></defs><defs><symbol height="24" width="24" id="mermaid-figure-1-clock"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z" transform="scale(.5)"></path></symbol></defs><defs><marker orient="auto-start-reverse" markerheight="12" markerwidth="12" markerunits="userSpaceOnUse" refy="5" refx="7.9" id="mermaid-figure-1-arrowhead"><path d="M -1 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker refy="4.5" refx="4" orient="auto" markerheight="8" markerwidth="15" id="mermaid-figure-1-crosshead"><path style="stroke-dasharray: 0, 0;" d="M 1,2 L 6,7 M 6,2 L 1,7" stroke-width="1pt" stroke="#000000" fill="none"></path></marker></defs><defs><marker orient="auto" markerheight="28" markerwidth="20" refy="7" refx="15.5" id="mermaid-figure-1-filled-head"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerheight="40" markerwidth="60" refy="15" refx="15" id="mermaid-figure-1-sequencenumber"><circle r="6" cy="15" cx="15"></circle></marker></defs><g><rect class="note" height="39" width="387" stroke="#666" fill="#EDF2AE" y="75" x="474.5"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="80" x="668"><tspan x="668">单机DB作为唯一的顺序点，提交日志/锁/序列化顺序</tspan></text></g><g><rect class="note" height="58" width="250" stroke="#666" fill="#EDF2AE" y="124" x="50"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="129" x="175"><tspan x="175">终端时钟可不同步；</tspan></text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="148" x="175"><tspan x="175">以DB“接收顺序”为准定义先后</tspan></text></g><g><rect class="note" height="39" width="263" stroke="#666" fill="#EDF2AE" y="380" x="536.5"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="385" x="668"><tspan x="668">串行化顺序：T1(取款) → Q1(查询)</tspan></text></g><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="197" x="370">取款 ¥1000 〔ATM 本地 15:00:00.000〕</text><line style="fill: none;" marker-start="url(#mermaid-figure-1-sequencenumber)" marker-end="url(#mermaid-figure-1-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="228" x2="664" y1="228" x1="76"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="232" x="76">1</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="243" x="669">开启Txn T1；余额-1000；提交〔DB 本地 15:00:00.004〕</text><path style="fill: none;" marker-start="url(#mermaid-figure-1-sequencenumber)" marker-end="url(#mermaid-figure-1-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 669,274 C 729,264 729,304 669,294"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="278" x="669">2</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="319" x="470">查询余额 〔手机 本地 15:00:00.001〕</text><line style="fill: none;" marker-start="url(#mermaid-figure-1-sequencenumber)" marker-end="url(#mermaid-figure-1-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="350" x2="664" y1="350" x1="276"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="354" x="276">3</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="444" x="473">返回余额（已扣款）〔DB 本地 15:00:00.006〕</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-1-sequencenumber)" marker-end="url(#mermaid-figure-1-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="475" x2="279" y1="475" x1="667"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="479" x="667">4</text>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="单机数据库的情况续" class="slide level2 smaller">
<h2>单机数据库的情况（续）</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<svg aria-roledescription="sequence" role="graphics-document document" viewbox="-50 -10 965 581" style="; display: block; margin: auto auto auto auto" xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="960" id="mermaid-figure-9" height="480">
<rect class="rect" height="69" width="282" fill="rgba(220,240,255,0.45)" y="238" x="527"></rect><g><rect class="actor actor-bottom" ry="3" rx="3" name="DB" height="65" width="150" stroke="#666" fill="#eaeaea" y="495" x="593"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="527.5" x="668"><tspan dy="0" x="668">单机数据库</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="Phone_SH" height="65" width="150" stroke="#666" fill="#eaeaea" y="495" x="200"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="527.5" x="275"><tspan dy="0" x="275">上海手机</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="ATM_BJ" height="65" width="150" stroke="#666" fill="#eaeaea" y="495" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="527.5" x="75"><tspan dy="0" x="75">北京ATM</tspan></text></g><g><line name="DB" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="495" x2="668" y1="5" x1="668" id="actor2"></line><g id="root-2"><rect class="actor actor-top" ry="3" rx="3" name="DB" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="593"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="668"><tspan dy="0" x="668">单机数据库</tspan></text></g></g><g><line name="Phone_SH" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="495" x2="275" y1="5" x1="275" id="actor1"></line><g id="root-1"><rect class="actor actor-top" ry="3" rx="3" name="Phone_SH" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="200"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="275"><tspan dy="0" x="275">上海手机</tspan></text></g></g><g><line name="ATM_BJ" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="495" x2="75" y1="5" x1="75" id="actor0"></line><g id="root-0"><rect class="actor actor-top" ry="3" rx="3" name="ATM_BJ" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="75"><tspan dy="0" x="75">北京ATM</tspan></text></g></g>
<style>#mermaid-figure-9{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-figure-9 .error-icon{fill:#552222;}#mermaid-figure-9 .error-text{fill:#552222;stroke:#552222;}#mermaid-figure-9 .edge-thickness-normal{stroke-width:1px;}#mermaid-figure-9 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-figure-9 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-figure-9 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-figure-9 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-figure-9 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-figure-9 .marker{fill:#333333;stroke:#333333;}#mermaid-figure-9 .marker.cross{stroke:#333333;}#mermaid-figure-9 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-figure-9 p{margin:0;}#mermaid-figure-9 .actor{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-9 text.actor>tspan{fill:black;stroke:none;}#mermaid-figure-9 .actor-line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-9 .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaid-figure-9 .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaid-figure-9 #mermaid-figure-9-arrowhead path{fill:#333;stroke:#333;}#mermaid-figure-9 .sequenceNumber{fill:white;}#mermaid-figure-9 #mermaid-figure-9-sequencenumber{fill:#333;}#mermaid-figure-9 #mermaid-figure-9-crosshead path{fill:#333;stroke:#333;}#mermaid-figure-9 .messageText{fill:#333;stroke:none;}#mermaid-figure-9 .labelBox{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-9 .labelText,#mermaid-figure-9 .labelText>tspan{fill:black;stroke:none;}#mermaid-figure-9 .loopText,#mermaid-figure-9 .loopText>tspan{fill:black;stroke:none;}#mermaid-figure-9 .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-9 .note{stroke:#aaaa33;fill:#fff5ad;}#mermaid-figure-9 .noteText,#mermaid-figure-9 .noteText>tspan{fill:black;stroke:none;}#mermaid-figure-9 .activation0{fill:#f4f4f4;stroke:#666;}#mermaid-figure-9 .activation1{fill:#f4f4f4;stroke:#666;}#mermaid-figure-9 .activation2{fill:#f4f4f4;stroke:#666;}#mermaid-figure-9 .actorPopupMenu{position:absolute;}#mermaid-figure-9 .actorPopupMenuPanel{position:absolute;fill:#ECECFF;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);filter:drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4));}#mermaid-figure-9 .actor-man line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-9 .actor-man circle,#mermaid-figure-9 line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;stroke-width:2px;}#mermaid-figure-9 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style>
<g></g><defs><symbol height="24" width="24" id="mermaid-figure-9-computer"><path d="M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z" transform="scale(.5)"></path></symbol></defs><defs><symbol clip-rule="evenodd" fill-rule="evenodd" id="mermaid-figure-9-database"><path d="M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z" transform="scale(.5)"></path></symbol></defs><defs><symbol height="24" width="24" id="mermaid-figure-9-clock"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z" transform="scale(.5)"></path></symbol></defs><defs><marker orient="auto-start-reverse" markerheight="12" markerwidth="12" markerunits="userSpaceOnUse" refy="5" refx="7.9" id="mermaid-figure-9-arrowhead"><path d="M -1 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker refy="4.5" refx="4" orient="auto" markerheight="8" markerwidth="15" id="mermaid-figure-9-crosshead"><path style="stroke-dasharray: 0, 0;" d="M 1,2 L 6,7 M 6,2 L 1,7" stroke-width="1pt" stroke="#000000" fill="none"></path></marker></defs><defs><marker orient="auto" markerheight="28" markerwidth="20" refy="7" refx="15.5" id="mermaid-figure-9-filled-head"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerheight="40" markerwidth="60" refy="15" refx="15" id="mermaid-figure-9-sequencenumber"><circle r="6" cy="15" cx="15"></circle></marker></defs><g><rect class="note" height="39" width="387" stroke="#666" fill="#EDF2AE" y="75" x="474.5"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="80" x="668"><tspan x="668">单机DB作为唯一的顺序点，提交日志/锁/序列化顺序</tspan></text></g><g><rect class="note" height="58" width="250" stroke="#666" fill="#EDF2AE" y="124" x="50"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="129" x="175"><tspan x="175">终端时钟可不同步；</tspan></text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="148" x="175"><tspan x="175">以DB“接收顺序”为准定义先后</tspan></text></g><g><rect class="note" height="39" width="262" stroke="#666" fill="#EDF2AE" y="258" x="537"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="263" x="668"><tspan x="668">串行化顺序：Q1(查询) → T1(取款)</tspan></text></g><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="197" x="470">查询余额 〔手机 本地 15:00:00.001〕</text><line style="fill: none;" marker-start="url(#mermaid-figure-9-sequencenumber)" marker-end="url(#mermaid-figure-9-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="228" x2="664" y1="228" x1="276"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="232" x="276">1</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="322" x="473">返回余额（未扣款）〔DB 本地 15:00:00.003〕</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-9-sequencenumber)" marker-end="url(#mermaid-figure-9-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="353" x2="279" y1="353" x1="667"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="357" x="667">2</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="368" x="370">取款 ¥1000 〔ATM 本地 15:00:00.000〕</text><line style="fill: none;" marker-start="url(#mermaid-figure-9-sequencenumber)" marker-end="url(#mermaid-figure-9-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="399" x2="664" y1="399" x1="76"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="403" x="76">3</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="414" x="669">开启Txn T1；余额-1000；提交〔DB 本地 15:00:00.007〕</text><path style="fill: none;" marker-start="url(#mermaid-figure-9-sequencenumber)" marker-end="url(#mermaid-figure-9-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 669,445 C 729,435 729,475 669,465"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="449" x="669">4</text>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="分布式数据库的情况" class="slide level2">
<h2>分布式数据库的情况</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<svg aria-roledescription="sequence" role="graphics-document document" viewbox="-50 -10 1497 849" style="; display: block; margin: auto auto auto auto" xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="960" id="mermaid-figure-8" height="480">
<rect class="rect" height="115" width="538" fill="rgba(255,245,204,0.55)" y="493" x="819"></rect><g><rect class="actor actor-bottom" ry="3" rx="3" name="Phone_SH" height="65" width="150" stroke="#666" fill="#eaeaea" y="763" x="1247"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="795.5" x="1322"><tspan dy="0" x="1322">上海手机</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="Svr_SH" height="65" width="150" stroke="#666" fill="#eaeaea" y="763" x="779"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="795.5" x="854"><tspan dy="0" x="854">上海服</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="Svr_BJ" height="65" width="150" stroke="#666" fill="#eaeaea" y="763" x="341"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="795.5" x="416"><tspan dy="0" x="416">北京服</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="ATM_BJ" height="65" width="150" stroke="#666" fill="#eaeaea" y="763" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="795.5" x="75"><tspan dy="0" x="75">北京ATM</tspan></text></g><g><line name="Phone_SH" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="763" x2="1322" y1="5" x1="1322" id="actor3"></line><g id="root-3"><rect class="actor actor-top" ry="3" rx="3" name="Phone_SH" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="1247"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="1322"><tspan dy="0" x="1322">上海手机</tspan></text></g></g><g><line name="Svr_SH" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="763" x2="854" y1="5" x1="854" id="actor2"></line><g id="root-2"><rect class="actor actor-top" ry="3" rx="3" name="Svr_SH" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="779"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="854"><tspan dy="0" x="854">上海服</tspan></text></g></g><g><line name="Svr_BJ" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="763" x2="416" y1="5" x1="416" id="actor1"></line><g id="root-1"><rect class="actor actor-top" ry="3" rx="3" name="Svr_BJ" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="341"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="416"><tspan dy="0" x="416">北京服</tspan></text></g></g><g><line name="ATM_BJ" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="763" x2="75" y1="5" x1="75" id="actor0"></line><g id="root-0"><rect class="actor actor-top" ry="3" rx="3" name="ATM_BJ" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="75"><tspan dy="0" x="75">北京ATM</tspan></text></g></g>
<style>#mermaid-figure-8{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-figure-8 .error-icon{fill:#552222;}#mermaid-figure-8 .error-text{fill:#552222;stroke:#552222;}#mermaid-figure-8 .edge-thickness-normal{stroke-width:1px;}#mermaid-figure-8 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-figure-8 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-figure-8 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-figure-8 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-figure-8 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-figure-8 .marker{fill:#333333;stroke:#333333;}#mermaid-figure-8 .marker.cross{stroke:#333333;}#mermaid-figure-8 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-figure-8 p{margin:0;}#mermaid-figure-8 .actor{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-8 text.actor>tspan{fill:black;stroke:none;}#mermaid-figure-8 .actor-line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-8 .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaid-figure-8 .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaid-figure-8 #mermaid-figure-8-arrowhead path{fill:#333;stroke:#333;}#mermaid-figure-8 .sequenceNumber{fill:white;}#mermaid-figure-8 #mermaid-figure-8-sequencenumber{fill:#333;}#mermaid-figure-8 #mermaid-figure-8-crosshead path{fill:#333;stroke:#333;}#mermaid-figure-8 .messageText{fill:#333;stroke:none;}#mermaid-figure-8 .labelBox{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-8 .labelText,#mermaid-figure-8 .labelText>tspan{fill:black;stroke:none;}#mermaid-figure-8 .loopText,#mermaid-figure-8 .loopText>tspan{fill:black;stroke:none;}#mermaid-figure-8 .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-8 .note{stroke:#aaaa33;fill:#fff5ad;}#mermaid-figure-8 .noteText,#mermaid-figure-8 .noteText>tspan{fill:black;stroke:none;}#mermaid-figure-8 .activation0{fill:#f4f4f4;stroke:#666;}#mermaid-figure-8 .activation1{fill:#f4f4f4;stroke:#666;}#mermaid-figure-8 .activation2{fill:#f4f4f4;stroke:#666;}#mermaid-figure-8 .actorPopupMenu{position:absolute;}#mermaid-figure-8 .actorPopupMenuPanel{position:absolute;fill:#ECECFF;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);filter:drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4));}#mermaid-figure-8 .actor-man line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-8 .actor-man circle,#mermaid-figure-8 line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;stroke-width:2px;}#mermaid-figure-8 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style>
<g></g><defs><symbol height="24" width="24" id="mermaid-figure-8-computer"><path d="M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z" transform="scale(.5)"></path></symbol></defs><defs><symbol clip-rule="evenodd" fill-rule="evenodd" id="mermaid-figure-8-database"><path d="M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z" transform="scale(.5)"></path></symbol></defs><defs><symbol height="24" width="24" id="mermaid-figure-8-clock"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z" transform="scale(.5)"></path></symbol></defs><defs><marker orient="auto-start-reverse" markerheight="12" markerwidth="12" markerunits="userSpaceOnUse" refy="5" refx="7.9" id="mermaid-figure-8-arrowhead"><path d="M -1 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker refy="4.5" refx="4" orient="auto" markerheight="8" markerwidth="15" id="mermaid-figure-8-crosshead"><path style="stroke-dasharray: 0, 0;" d="M 1,2 L 6,7 M 6,2 L 1,7" stroke-width="1pt" stroke="#000000" fill="none"></path></marker></defs><defs><marker orient="auto" markerheight="28" markerwidth="20" refy="7" refx="15.5" id="mermaid-figure-8-filled-head"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerheight="40" markerwidth="60" refy="15" refx="15" id="mermaid-figure-8-sequencenumber"><circle r="6" cy="15" cx="15"></circle></marker></defs><g><rect class="note" height="58" width="488" stroke="#666" fill="#EDF2AE" y="75" x="391"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="80" x="635"><tspan x="635">时钟偏差：北京服务器+5ms；上海服务器-8ms</tspan></text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="99" x="635"><tspan x="635">跨城网络单程≈20–30ms；本地网络≈2–5ms</tspan></text></g><g><rect class="note" height="39" width="518" stroke="#666" fill="#EDF2AE" y="513" x="829"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="518" x="1088"><tspan x="1088">可能出现“旧值”的读取窗口（复制尚未抵达/应用）</tspan></text></g><g><line class="loopLine" y2="311" x2="1367" y1="311" x1="405"></line><line class="loopLine" y2="618" x2="1367" y1="311" x1="1367"></line><line class="loopLine" y2="618" x2="1367" y1="618" x1="405"></line><line class="loopLine" y2="618" x2="405" y1="311" x1="405"></line><line style="stroke-dasharray: 3, 3;" class="loopLine" y2="407" x2="1367" y1="407" x1="405"></line><polygon class="labelBox" points="405,311 455,311 455,324 446.6,331 405,331"></polygon><text style="font-size: 16px; font-weight: 400;" class="labelText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="324" x="430">par</text><text style="font-size: 16px; font-weight: 400;" class="loopText" text-anchor="middle" y="329" x="911"><tspan x="911">[跨城复制在路上]</tspan></text><text style="font-size: 16px; font-weight: 400;" class="loopText" text-anchor="middle" y="425" x="886">[用户在上海查询]</text></g><g><rect class="note" height="39" width="518" stroke="#666" fill="#EDF2AE" y="704" x="829"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="709" x="1088"><tspan x="1088">现已完成扣款，但用户刚才读到的是扣款前的余额（不一致视图）</tspan></text></g><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="148" x="244">取款 ¥1000 〔ATM 本地 15:00:00.000〕</text><line style="fill: none;" marker-start="url(#mermaid-figure-8-sequencenumber)" marker-end="url(#mermaid-figure-8-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="179" x2="412" y1="179" x1="76"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="183" x="76">1</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="194" x="417">提交交易 “Tx123”（余额-1000）〔北京服 本地 15:00:00.007〕</text><path style="fill: none;" marker-start="url(#mermaid-figure-8-sequencenumber)" marker-end="url(#mermaid-figure-8-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 417,225 C 477,215 477,255 417,245"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="229" x="417">2</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="270" x="634">复制事务 “Tx123” 〔北京服 本地 15:00:00.009 发出〕</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-8-sequencenumber)" marker-end="url(#mermaid-figure-8-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="301" x2="850" y1="301" x1="417"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="305" x="417">3</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="361" x="634">（复制数据在链路中…）</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-8-sequencenumber)" marker-end="url(#mermaid-figure-8-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="392" x2="850" y1="392" x1="417"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="396" x="417">4</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="452" x="1090">查询余额 〔手机 本地 15:00:00.001〕</text><line style="fill: none;" marker-start="url(#mermaid-figure-8-sequencenumber)" marker-end="url(#mermaid-figure-8-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="483" x2="858" y1="483" x1="1321"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="487" x="1321">5</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="567" x="1087">返回余额 = 原值（未扣款）〔上海服 本地 14:59:59.999〕</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-8-sequencenumber)" marker-end="url(#mermaid-figure-8-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="598" x2="1318" y1="598" x1="855"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="602" x="855">6</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="633" x="855">接收并应用 “Tx123” 〔上海服 本地 15:00:00.017〕</text><path style="fill: none;" marker-start="url(#mermaid-figure-8-sequencenumber)" marker-end="url(#mermaid-figure-8-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 855,664 C 915,654 915,694 855,684"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="668" x="855">7</text>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="物理时钟的困境" class="slide level2">
<h2>物理时钟的困境</h2>
<p><strong>Network Time Protocol（NTP）的问题：</strong></p>
<ul>
<li>互联网环境常为<strong>10ms 级</strong>甚至更差；局域网也多为<strong>ms 级</strong></li>
<li>不同机器<strong>时钟漂移</strong>（温度/电压/硬件差异）</li>
<li><strong>闰秒</strong>与<strong>NTP 回拨</strong>导致时间跳变或倒流</li>
</ul>
<p><strong>过度依赖本地物理时间：</strong></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href=""></a><span class="im">import</span> time</span>
<span id="cb1-2"><a href=""></a></span>
<span id="cb1-3"><a href=""></a><span class="kw">def</span> process_request(request):</span>
<span id="cb1-4"><a href=""></a>    ts <span class="op">=</span> time.time()          <span class="co"># 本地物理时间</span></span>
<span id="cb1-5"><a href=""></a>    save_to_db(request, ts)   <span class="co"># 另一台机器时钟慢1s会造成顺序误判</span></span>
<span id="cb1-6"><a href=""></a>    <span class="cf">return</span> {<span class="st">"processed_at"</span>: ts}</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="依赖本地物理时间" class="slide level2">
<h2>依赖本地物理时间</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<svg aria-roledescription="sequence" role="graphics-document document" viewbox="-50 -10 1473.5 832" style="; display: block; margin: auto auto auto auto" xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="960" id="mermaid-figure-7" height="480">
<g><rect class="actor actor-bottom" ry="3" rx="3" name="Sorter" height="65" width="150" stroke="#666" fill="#eaeaea" y="746" x="1223.5"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="778.5" x="1298.5"><tspan dy="0" x="1298.5">排序/报表</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="DB" height="65" width="150" stroke="#666" fill="#eaeaea" y="746" x="788.5"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="778.5" x="863.5"><tspan dy="0" x="863.5">数据库</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="SvrB" height="65" width="150" stroke="#666" fill="#eaeaea" y="746" x="521.5"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="778.5" x="596.5"><tspan dy="0" x="596.5">服务器B（慢钟）</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="SvrA" height="65" width="150" stroke="#666" fill="#eaeaea" y="746" x="295"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="778.5" x="370"><tspan dy="0" x="370">服务器A（快钟）</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="Client" height="65" width="150" stroke="#666" fill="#eaeaea" y="746" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="778.5" x="75"><tspan dy="0" x="75">客户端</tspan></text></g><g><line name="Sorter" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="746" x2="1298.5" y1="5" x1="1298.5" id="actor4"></line><g id="root-4"><rect class="actor actor-top" ry="3" rx="3" name="Sorter" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="1223.5"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="1298.5"><tspan dy="0" x="1298.5">排序/报表</tspan></text></g></g><g><line name="DB" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="746" x2="863.5" y1="5" x1="863.5" id="actor3"></line><g id="root-3"><rect class="actor actor-top" ry="3" rx="3" name="DB" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="788.5"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="863.5"><tspan dy="0" x="863.5">数据库</tspan></text></g></g><g><line name="SvrB" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="746" x2="596.5" y1="5" x1="596.5" id="actor2"></line><g id="root-2"><rect class="actor actor-top" ry="3" rx="3" name="SvrB" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="521.5"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="596.5"><tspan dy="0" x="596.5">服务器B（慢钟）</tspan></text></g></g><g><line name="SvrA" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="746" x2="370" y1="5" x1="370" id="actor1"></line><g id="root-1"><rect class="actor actor-top" ry="3" rx="3" name="SvrA" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="295"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="370"><tspan dy="0" x="370">服务器A（快钟）</tspan></text></g></g><g><line name="Client" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="746" x2="75" y1="5" x1="75" id="actor0"></line><g id="root-0"><rect class="actor actor-top" ry="3" rx="3" name="Client" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="75"><tspan dy="0" x="75">客户端</tspan></text></g></g>
<style>#mermaid-figure-7{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-figure-7 .error-icon{fill:#552222;}#mermaid-figure-7 .error-text{fill:#552222;stroke:#552222;}#mermaid-figure-7 .edge-thickness-normal{stroke-width:1px;}#mermaid-figure-7 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-figure-7 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-figure-7 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-figure-7 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-figure-7 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-figure-7 .marker{fill:#333333;stroke:#333333;}#mermaid-figure-7 .marker.cross{stroke:#333333;}#mermaid-figure-7 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-figure-7 p{margin:0;}#mermaid-figure-7 .actor{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-7 text.actor>tspan{fill:black;stroke:none;}#mermaid-figure-7 .actor-line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-7 .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaid-figure-7 .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaid-figure-7 #mermaid-figure-7-arrowhead path{fill:#333;stroke:#333;}#mermaid-figure-7 .sequenceNumber{fill:white;}#mermaid-figure-7 #mermaid-figure-7-sequencenumber{fill:#333;}#mermaid-figure-7 #mermaid-figure-7-crosshead path{fill:#333;stroke:#333;}#mermaid-figure-7 .messageText{fill:#333;stroke:none;}#mermaid-figure-7 .labelBox{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-7 .labelText,#mermaid-figure-7 .labelText>tspan{fill:black;stroke:none;}#mermaid-figure-7 .loopText,#mermaid-figure-7 .loopText>tspan{fill:black;stroke:none;}#mermaid-figure-7 .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-7 .note{stroke:#aaaa33;fill:#fff5ad;}#mermaid-figure-7 .noteText,#mermaid-figure-7 .noteText>tspan{fill:black;stroke:none;}#mermaid-figure-7 .activation0{fill:#f4f4f4;stroke:#666;}#mermaid-figure-7 .activation1{fill:#f4f4f4;stroke:#666;}#mermaid-figure-7 .activation2{fill:#f4f4f4;stroke:#666;}#mermaid-figure-7 .actorPopupMenu{position:absolute;}#mermaid-figure-7 .actorPopupMenuPanel{position:absolute;fill:#ECECFF;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);filter:drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4));}#mermaid-figure-7 .actor-man line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-7 .actor-man circle,#mermaid-figure-7 line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;stroke-width:2px;}#mermaid-figure-7 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style>
<g></g><defs><symbol height="24" width="24" id="mermaid-figure-7-computer"><path d="M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z" transform="scale(.5)"></path></symbol></defs><defs><symbol clip-rule="evenodd" fill-rule="evenodd" id="mermaid-figure-7-database"><path d="M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z" transform="scale(.5)"></path></symbol></defs><defs><symbol height="24" width="24" id="mermaid-figure-7-clock"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z" transform="scale(.5)"></path></symbol></defs><defs><marker orient="auto-start-reverse" markerheight="12" markerwidth="12" markerunits="userSpaceOnUse" refy="5" refx="7.9" id="mermaid-figure-7-arrowhead"><path d="M -1 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker refy="4.5" refx="4" orient="auto" markerheight="8" markerwidth="15" id="mermaid-figure-7-crosshead"><path style="stroke-dasharray: 0, 0;" d="M 1,2 L 6,7 M 6,2 L 1,7" stroke-width="1pt" stroke="#000000" fill="none"></path></marker></defs><defs><marker orient="auto" markerheight="28" markerwidth="20" refy="7" refx="15.5" id="mermaid-figure-7-filled-head"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerheight="40" markerwidth="60" refy="15" refx="15" id="mermaid-figure-7-sequencenumber"><circle r="6" cy="15" cx="15"></circle></marker></defs><g><rect class="note" height="39" width="258" stroke="#666" fill="#EDF2AE" y="381" x="467.5"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="386" x="597"><tspan x="597">B 的时钟慢 2s（记录到 09:59:59）</tspan></text></g><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="80" x="221">请求1（用户观测 10:00:00）</text><line style="fill: none;" marker-start="url(#mermaid-figure-7-sequencenumber)" marker-end="url(#mermaid-figure-7-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="111" x2="366" y1="111" x1="76"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="115" x="76">1</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="126" x="371">process_request(): timestamp=10:00:00 （A本地）</text><path style="fill: none;" marker-start="url(#mermaid-figure-7-sequencenumber)" marker-end="url(#mermaid-figure-7-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 371,157 C 431,147 431,187 371,177"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="161" x="371">2</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="202" x="615">save_to_db(req1, ts=10:00:00)</text><line style="fill: none;" marker-start="url(#mermaid-figure-7-sequencenumber)" marker-end="url(#mermaid-figure-7-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="233" x2="859.5" y1="233" x1="371"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="237" x="371">3</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="248" x="618">OK</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-7-sequencenumber)" marker-end="url(#mermaid-figure-7-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="279" x2="374" y1="279" x1="862.5"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="283" x="862.5">4</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="294" x="224">返回 {“processed_at”: “10:00:00”}</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-7-sequencenumber)" marker-end="url(#mermaid-figure-7-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="325" x2="79" y1="325" x1="369"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="329" x="369">5</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="340" x="334">请求2（用户观测 10:00:01）</text><line style="fill: none;" marker-start="url(#mermaid-figure-7-sequencenumber)" marker-end="url(#mermaid-figure-7-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="371" x2="592.5" y1="371" x1="76"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="375" x="76">6</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="435" x="598">process_request(): timestamp=09:59:59 （B本地）</text><path style="fill: none;" marker-start="url(#mermaid-figure-7-sequencenumber)" marker-end="url(#mermaid-figure-7-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 597.5,466 C 657.5,456 657.5,496 597.5,486"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="470" x="597.5">7</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="511" x="729">save_to_db(req2, ts=09:59:59)</text><line style="fill: none;" marker-start="url(#mermaid-figure-7-sequencenumber)" marker-end="url(#mermaid-figure-7-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="542" x2="859.5" y1="542" x1="597.5"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="546" x="597.5">8</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="557" x="732">OK</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-7-sequencenumber)" marker-end="url(#mermaid-figure-7-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="588" x2="600.5" y1="588" x1="862.5"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="592" x="862.5">9</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="603" x="337">返回 {“processed_at”: “09:59:59”}</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-7-sequencenumber)" marker-end="url(#mermaid-figure-7-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="634" x2="79" y1="634" x1="595.5"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="638" x="595.5">10</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="649" x="1083">SELECT * FROM requests ORDER BY timestamp ASC</text><line style="fill: none;" marker-start="url(#mermaid-figure-7-sequencenumber)" marker-end="url(#mermaid-figure-7-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="680" x2="867.5" y1="680" x1="1297.5"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="684" x="1297.5">11</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="695" x="1080">[ (req2, 09:59:59), (req1, 10:00:00) ]</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-7-sequencenumber)" marker-end="url(#mermaid-figure-7-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="726" x2="1294.5" y1="726" x1="864.5"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="730" x="864.5">12</text>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="物理时钟再进化google-truetime" class="slide level2">
<h2>物理时钟再进化：Google TrueTime</h2>
<ul>
<li>Spanner 提供<strong>区间时间</strong> <code>TT.now() -&gt; [earliest, latest]</code>，显式暴露不确定性</li>
<li><strong>提交等待</strong>：直到 <code>TT.after(commit_ts)</code> 为真才认定提交线性化生效</li>
<li>依赖原子钟、GPS 与专用同步网络（昂贵但有效）</li>
</ul>
<p><strong>论文</strong>：Corbett et al.&nbsp;2012（OSDI）<a href="https://www.usenix.org/conference/osdi12/technical-sessions/presentation/corbett">Spanner: Google’s Globally-Distributed Database</a></p>
</section>
<section id="时间服务器" class="slide level2">
<h2>时间服务器</h2>

<img data-src="./assets/time_server.png" class="r-stretch"></section></section>
<section>
<section id="逻辑时间" class="title-slide slide level1 center">
<h1>逻辑时间</h1>

</section>
<section id="lamport-时钟思想" class="slide level2">
<h2>Lamport 时钟：思想</h2>
<blockquote>
<p><a href="https://lamport.azurewebsites.net/pubs/time-clocks.pdf">Lamport（1978）</a>提出：<strong>我们不必知道“几时发生”，只要能给出“谁先于谁”</strong>。</p>
</blockquote>
<p><strong>Happened-Before（→）定义：</strong></p>
<ol type="1">
<li>同进程内顺序：a 在 b 之前，则 a → b</li>
<li>发送/接收消息：send(m) → recv(m)</li>
<li>传递性：a → b 且 b → c，则 a → c</li>
</ol>
</section>
<section id="lamport-时钟规则与实现" class="slide level2">
<h2>Lamport 时钟：规则与实现</h2>
<p><strong>规则：</strong></p>
<ul>
<li>本地事件：<code>Ci := Ci + 1</code></li>
<li>发送消息：先 <code>Ci := Ci + 1</code>，把 <code>Ci</code> 附在消息中</li>
<li>接收消息：<code>Cj := max(Cj, tm) + 1</code></li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href=""></a><span class="kw">class</span> LamportClock:</span>
<span id="cb2-2"><a href=""></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>): <span class="va">self</span>.c <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb2-3"><a href=""></a>    <span class="kw">def</span> tick(<span class="va">self</span>): <span class="va">self</span>.c <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span> <span class="cf">return</span> <span class="va">self</span>.c</span>
<span id="cb2-4"><a href=""></a>    <span class="kw">def</span> send(<span class="va">self</span>, msg): <span class="va">self</span>.c <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span> msg[<span class="st">"lamport"</span>]<span class="op">=</span><span class="va">self</span>.c<span class="op">;</span> <span class="cf">return</span> msg</span>
<span id="cb2-5"><a href=""></a>    <span class="kw">def</span> recv(<span class="va">self</span>, msg): <span class="va">self</span>.c <span class="op">=</span> <span class="bu">max</span>(<span class="va">self</span>.c, msg[<span class="st">"lamport"</span>]) <span class="op">+</span> <span class="dv">1</span><span class="op">;</span> <span class="cf">return</span> <span class="va">self</span>.c</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>注记</strong></p>
</div>
<div class="callout-content">
<p>若 A → B，则 <code>C(A) &lt; C(B)</code>；反之不成立，小于不代表必然存在因果</p>
</div>
</div>
</div>
</section>
<section id="lamport-时钟示例" class="slide level2">
<h2>Lamport 时钟：示例</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<svg aria-roledescription="sequence" role="graphics-document document" viewbox="-105 -10 842 917" style="; display: block; margin: auto auto auto auto" xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="672" id="mermaid-figure-6" height="480">
<g><rect class="actor actor-bottom" ry="3" rx="3" name="P3" height="65" width="150" stroke="#666" fill="#eaeaea" y="831" x="523"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="863.5" x="598"><tspan dy="0" x="598">支付服务</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="P2" height="65" width="150" stroke="#666" fill="#eaeaea" y="831" x="323"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="863.5" x="398"><tspan dy="0" x="398">库存服务</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="P1" height="65" width="150" stroke="#666" fill="#eaeaea" y="831" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="863.5" x="75"><tspan dy="0" x="75">订单服务</tspan></text></g><g><line name="P3" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="831" x2="598" y1="5" x1="598" id="actor2"></line><g id="root-2"><rect class="actor actor-top" ry="3" rx="3" name="P3" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="523"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="598"><tspan dy="0" x="598">支付服务</tspan></text></g></g><g><line name="P2" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="831" x2="398" y1="5" x1="398" id="actor1"></line><g id="root-1"><rect class="actor actor-top" ry="3" rx="3" name="P2" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="323"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="398"><tspan dy="0" x="398">库存服务</tspan></text></g></g><g><line name="P1" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="831" x2="75" y1="5" x1="75" id="actor0"></line><g id="root-0"><rect class="actor actor-top" ry="3" rx="3" name="P1" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="75"><tspan dy="0" x="75">订单服务</tspan></text></g></g>
<style>#mermaid-figure-6{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-figure-6 .error-icon{fill:#552222;}#mermaid-figure-6 .error-text{fill:#552222;stroke:#552222;}#mermaid-figure-6 .edge-thickness-normal{stroke-width:1px;}#mermaid-figure-6 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-figure-6 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-figure-6 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-figure-6 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-figure-6 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-figure-6 .marker{fill:#333333;stroke:#333333;}#mermaid-figure-6 .marker.cross{stroke:#333333;}#mermaid-figure-6 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-figure-6 p{margin:0;}#mermaid-figure-6 .actor{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-6 text.actor>tspan{fill:black;stroke:none;}#mermaid-figure-6 .actor-line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-6 .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaid-figure-6 .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaid-figure-6 #mermaid-figure-6-arrowhead path{fill:#333;stroke:#333;}#mermaid-figure-6 .sequenceNumber{fill:white;}#mermaid-figure-6 #mermaid-figure-6-sequencenumber{fill:#333;}#mermaid-figure-6 #mermaid-figure-6-crosshead path{fill:#333;stroke:#333;}#mermaid-figure-6 .messageText{fill:#333;stroke:none;}#mermaid-figure-6 .labelBox{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-6 .labelText,#mermaid-figure-6 .labelText>tspan{fill:black;stroke:none;}#mermaid-figure-6 .loopText,#mermaid-figure-6 .loopText>tspan{fill:black;stroke:none;}#mermaid-figure-6 .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-6 .note{stroke:#aaaa33;fill:#fff5ad;}#mermaid-figure-6 .noteText,#mermaid-figure-6 .noteText>tspan{fill:black;stroke:none;}#mermaid-figure-6 .activation0{fill:#f4f4f4;stroke:#666;}#mermaid-figure-6 .activation1{fill:#f4f4f4;stroke:#666;}#mermaid-figure-6 .activation2{fill:#f4f4f4;stroke:#666;}#mermaid-figure-6 .actorPopupMenu{position:absolute;}#mermaid-figure-6 .actorPopupMenuPanel{position:absolute;fill:#ECECFF;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);filter:drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4));}#mermaid-figure-6 .actor-man line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-6 .actor-man circle,#mermaid-figure-6 line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;stroke-width:2px;}#mermaid-figure-6 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style>
<g></g><defs><symbol height="24" width="24" id="mermaid-figure-6-computer"><path d="M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z" transform="scale(.5)"></path></symbol></defs><defs><symbol clip-rule="evenodd" fill-rule="evenodd" id="mermaid-figure-6-database"><path d="M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z" transform="scale(.5)"></path></symbol></defs><defs><symbol height="24" width="24" id="mermaid-figure-6-clock"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z" transform="scale(.5)"></path></symbol></defs><defs><marker orient="auto-start-reverse" markerheight="12" markerwidth="12" markerunits="userSpaceOnUse" refy="5" refx="7.9" id="mermaid-figure-6-arrowhead"><path d="M -1 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker refy="4.5" refx="4" orient="auto" markerheight="8" markerwidth="15" id="mermaid-figure-6-crosshead"><path style="stroke-dasharray: 0, 0;" d="M 1,2 L 6,7 M 6,2 L 1,7" stroke-width="1pt" stroke="#000000" fill="none"></path></marker></defs><defs><marker orient="auto" markerheight="28" markerwidth="20" refy="7" refx="15.5" id="mermaid-figure-6-filled-head"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerheight="40" markerwidth="60" refy="15" refx="15" id="mermaid-figure-6-sequencenumber"><circle r="6" cy="15" cx="15"></circle></marker></defs><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="80" x="76">t=0 [1] 接收客户订单</text><path style="fill: none;" marker-start="url(#mermaid-figure-6-sequencenumber)" marker-end="url(#mermaid-figure-6-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 76,111 C 136,101 136,141 76,131"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="115" x="76">1</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="156" x="399">t=0 [1] 系统启动</text><path style="fill: none;" marker-start="url(#mermaid-figure-6-sequencenumber)" marker-end="url(#mermaid-figure-6-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 399,187 C 459,177 459,217 399,207"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="191" x="399">2</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="232" x="599">t=0 [1] 系统启动</text><path style="fill: none;" marker-start="url(#mermaid-figure-6-sequencenumber)" marker-end="url(#mermaid-figure-6-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 599,263 C 659,253 659,293 599,283"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="267" x="599">3</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="308" x="235">t=1 [2] 发送“检查库存” （msg.ts=2）</text><line style="fill: none;" marker-start="url(#mermaid-figure-6-sequencenumber)" marker-end="url(#mermaid-figure-6-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="339" x2="394" y1="339" x1="76"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="343" x="76">4</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="354" x="399">t=1 [3] 接收“检查库存”（应用 C2=3）</text><path style="fill: none;" marker-start="url(#mermaid-figure-6-sequencenumber)" marker-end="url(#mermaid-figure-6-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 399,385 C 459,375 459,415 399,405"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="389" x="399">5</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="430" x="599">t=1 [2] 本地检查支付配置</text><path style="fill: none;" marker-start="url(#mermaid-figure-6-sequencenumber)" marker-end="url(#mermaid-figure-6-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 599,461 C 659,451 659,491 599,481"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="465" x="599">6</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="506" x="238">t=2 [4] 发送“库存充足” （msg.ts=3）</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-6-sequencenumber)" marker-end="url(#mermaid-figure-6-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="537" x2="79" y1="537" x1="397"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="541" x="397">7</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="552" x="76">t=2 [4] 接收“库存充足”（应用 C1=4）</text><path style="fill: none;" marker-start="url(#mermaid-figure-6-sequencenumber)" marker-end="url(#mermaid-figure-6-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 76,583 C 136,573 136,613 76,603"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="587" x="76">8</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="628" x="599">t=2 [3] 等待支付请求</text><path style="fill: none;" marker-start="url(#mermaid-figure-6-sequencenumber)" marker-end="url(#mermaid-figure-6-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 599,659 C 659,649 659,689 599,679"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="663" x="599">9</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="704" x="235">t=3 [5] 发送“预扣库存” （msg.ts=5）</text><line style="fill: none;" marker-start="url(#mermaid-figure-6-sequencenumber)" marker-end="url(#mermaid-figure-6-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="735" x2="394" y1="735" x1="76"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="739" x="76">10</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="750" x="399">t=3 [6] 接收“预扣库存”（应用 C2=6）</text><path style="fill: none;" marker-start="url(#mermaid-figure-6-sequencenumber)" marker-end="url(#mermaid-figure-6-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 399,781 C 459,771 459,811 399,801"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="785" x="399">11</text>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="lamport-时钟局限" class="slide level2">
<h2>Lamport 时钟：局限</h2>
<ul>
<li class="fragment">订单、库存、支付三个服务协作，可正确给出偏序</li>
<li class="fragment">但是，无法判定“并发”与“因果无关”的细粒度关系</li>
</ul>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>提示</strong></p>
</div>
<div class="callout-content">
<p>例如两个独立本地事件 <code>A</code> 与 <code>B</code> 可能同一时间戳或只给出 <code>&lt;</code>，但无法说明是否存在真正的因果链路。</p>
</div>
</div>
</div>
</section>
<section id="向量时钟精确刻画因果" class="slide level2">
<h2>向量时钟：精确刻画因果</h2>
<ul>
<li class="fragment">为了精确刻画因果关系，我们需要向量时钟（Vector Clock）</li>
<li class="fragment">其核心思想是：<strong>每个进程不仅维护自己的逻辑时钟，还维护对其他所有进程逻辑时钟的认知</strong></li>
<li class="fragment">维护长度为 <em>n</em> 的向量<code>V</code>，第 <em>i</em> 维记录“我对进程 <em>i</em> 逻辑时钟的认知”，其中
<ul>
<li class="fragment"><code>Vi[i]</code> 表示进程<code>Pi</code>自己的逻辑时钟</li>
<li class="fragment"><code>Vi[j]</code> 表示进程<code>Pi</code>对进程<code>Pj</code>逻辑时钟的最新认知</li>
</ul></li>
</ul>
</section>
<section id="向量时钟规则" class="slide level2">
<h2>向量时钟：规则</h2>
<ul>
<li>本地事件：<code>Vi[i] += 1</code></li>
<li>发送消息：先本地加 1，再附整个向量</li>
<li>接收消息：各维取 <code>max()</code> 融合，最后 <code>Vj[j] += 1</code></li>
</ul>
<p><strong>比较：</strong></p>
<ul>
<li><code>Va → Vb</code> 当且仅当 <code>∀i: Va[i] ≤ Vb[i]</code> 且 <code>∃j: Va[j] &lt; Vb[j]</code></li>
<li>否则若互不支配，则并发 <code>Va || Vb</code></li>
</ul>
</section>
<section id="向量时钟代码示例" class="slide level2">
<h2>向量时钟：代码示例</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href=""></a><span class="kw">class</span> VectorClock:</span>
<span id="cb3-2"><a href=""></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, pid, n): <span class="va">self</span>.pid, <span class="va">self</span>.v <span class="op">=</span> pid, [<span class="dv">0</span>]<span class="op">*</span>n</span>
<span id="cb3-3"><a href=""></a>    <span class="kw">def</span> tick(<span class="va">self</span>): <span class="va">self</span>.v[<span class="va">self</span>.pid]<span class="op">+=</span><span class="dv">1</span><span class="op">;</span> <span class="cf">return</span> <span class="va">self</span>.v[:]</span>
<span id="cb3-4"><a href=""></a>    <span class="kw">def</span> send(<span class="va">self</span>, m): <span class="va">self</span>.tick()<span class="op">;</span> m[<span class="st">"vc"</span>]<span class="op">=</span><span class="va">self</span>.v[:]<span class="op">;</span> <span class="cf">return</span> m</span>
<span id="cb3-5"><a href=""></a>    <span class="kw">def</span> recv(<span class="va">self</span>, m):</span>
<span id="cb3-6"><a href=""></a>        w<span class="op">=</span>m[<span class="st">"vc"</span>]</span>
<span id="cb3-7"><a href=""></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(<span class="va">self</span>.v)):</span>
<span id="cb3-8"><a href=""></a>            <span class="cf">if</span> i<span class="op">!=</span><span class="va">self</span>.pid: <span class="va">self</span>.v[i]<span class="op">=</span><span class="bu">max</span>(<span class="va">self</span>.v[i], w[i])</span>
<span id="cb3-9"><a href=""></a>        <span class="va">self</span>.v[<span class="va">self</span>.pid]<span class="op">+=</span><span class="dv">1</span></span>
<span id="cb3-10"><a href=""></a>        <span class="cf">return</span> <span class="va">self</span>.v[:]</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="向量时钟示例" class="slide level2">
<h2>向量时钟：示例</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<svg aria-roledescription="sequence" role="graphics-document document" viewbox="-220 -10 1336 781" style="; display: block; margin: auto auto auto auto" xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="672" id="mermaid-figure-5" height="480">
<g><rect class="actor actor-bottom" ry="3" rx="3" name="P2" height="65" width="150" stroke="#666" fill="#eaeaea" y="695" x="717"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="727.5" x="792"><tspan dy="0" x="792">Charlie</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="P1" height="65" width="150" stroke="#666" fill="#eaeaea" y="695" x="316"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="727.5" x="391"><tspan dy="0" x="391">Bob</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="P0" height="65" width="150" stroke="#666" fill="#eaeaea" y="695" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="727.5" x="75"><tspan dy="0" x="75">Alice</tspan></text></g><g><line name="P2" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="695" x2="792" y1="5" x1="792" id="actor2"></line><g id="root-2"><rect class="actor actor-top" ry="3" rx="3" name="P2" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="717"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="792"><tspan dy="0" x="792">Charlie</tspan></text></g></g><g><line name="P1" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="695" x2="391" y1="5" x1="391" id="actor1"></line><g id="root-1"><rect class="actor actor-top" ry="3" rx="3" name="P1" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="316"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="391"><tspan dy="0" x="391">Bob</tspan></text></g></g><g><line name="P0" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="695" x2="75" y1="5" x1="75" id="actor0"></line><g id="root-0"><rect class="actor actor-top" ry="3" rx="3" name="P0" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="75"><tspan dy="0" x="75">Alice</tspan></text></g></g>
<style>#mermaid-figure-5{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-figure-5 .error-icon{fill:#552222;}#mermaid-figure-5 .error-text{fill:#552222;stroke:#552222;}#mermaid-figure-5 .edge-thickness-normal{stroke-width:1px;}#mermaid-figure-5 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-figure-5 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-figure-5 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-figure-5 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-figure-5 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-figure-5 .marker{fill:#333333;stroke:#333333;}#mermaid-figure-5 .marker.cross{stroke:#333333;}#mermaid-figure-5 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-figure-5 p{margin:0;}#mermaid-figure-5 .actor{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-5 text.actor>tspan{fill:black;stroke:none;}#mermaid-figure-5 .actor-line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-5 .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaid-figure-5 .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaid-figure-5 #mermaid-figure-5-arrowhead path{fill:#333;stroke:#333;}#mermaid-figure-5 .sequenceNumber{fill:white;}#mermaid-figure-5 #mermaid-figure-5-sequencenumber{fill:#333;}#mermaid-figure-5 #mermaid-figure-5-crosshead path{fill:#333;stroke:#333;}#mermaid-figure-5 .messageText{fill:#333;stroke:none;}#mermaid-figure-5 .labelBox{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-5 .labelText,#mermaid-figure-5 .labelText>tspan{fill:black;stroke:none;}#mermaid-figure-5 .loopText,#mermaid-figure-5 .loopText>tspan{fill:black;stroke:none;}#mermaid-figure-5 .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-5 .note{stroke:#aaaa33;fill:#fff5ad;}#mermaid-figure-5 .noteText,#mermaid-figure-5 .noteText>tspan{fill:black;stroke:none;}#mermaid-figure-5 .activation0{fill:#f4f4f4;stroke:#666;}#mermaid-figure-5 .activation1{fill:#f4f4f4;stroke:#666;}#mermaid-figure-5 .activation2{fill:#f4f4f4;stroke:#666;}#mermaid-figure-5 .actorPopupMenu{position:absolute;}#mermaid-figure-5 .actorPopupMenuPanel{position:absolute;fill:#ECECFF;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);filter:drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4));}#mermaid-figure-5 .actor-man line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-5 .actor-man circle,#mermaid-figure-5 line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;stroke-width:2px;}#mermaid-figure-5 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style>
<g></g><defs><symbol height="24" width="24" id="mermaid-figure-5-computer"><path d="M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z" transform="scale(.5)"></path></symbol></defs><defs><symbol clip-rule="evenodd" fill-rule="evenodd" id="mermaid-figure-5-database"><path d="M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z" transform="scale(.5)"></path></symbol></defs><defs><symbol height="24" width="24" id="mermaid-figure-5-clock"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z" transform="scale(.5)"></path></symbol></defs><defs><marker orient="auto-start-reverse" markerheight="12" markerwidth="12" markerunits="userSpaceOnUse" refy="5" refx="7.9" id="mermaid-figure-5-arrowhead"><path d="M -1 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker refy="4.5" refx="4" orient="auto" markerheight="8" markerwidth="15" id="mermaid-figure-5-crosshead"><path style="stroke-dasharray: 0, 0;" d="M 1,2 L 6,7 M 6,2 L 1,7" stroke-width="1pt" stroke="#000000" fill="none"></path></marker></defs><defs><marker orient="auto" markerheight="28" markerwidth="20" refy="7" refx="15.5" id="mermaid-figure-5-filled-head"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerheight="40" markerwidth="60" refy="15" refx="15" id="mermaid-figure-5-sequencenumber"><circle r="6" cy="15" cx="15"></circle></marker></defs><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="80" x="232">“Hi” (msg.vc=[1,0,0]) P0 发送前自增</text><line style="fill: none;" marker-start="url(#mermaid-figure-5-sequencenumber)" marker-end="url(#mermaid-figure-5-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="111" x2="387" y1="111" x1="76"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="115" x="76">1</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="126" x="392">接收 “Hi” (vc=[1,1,0]) max([0,0,0],[1,0,0])→[1,0,0], 再自增 P1→[1,1,0]</text><path style="fill: none;" marker-start="url(#mermaid-figure-5-sequencenumber)" marker-end="url(#mermaid-figure-5-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 392,157 C 452,147 452,187 392,177"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="161" x="392">2</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="202" x="235">“Hello” (msg.vc=[1,2,0]) 发送前自增</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-5-sequencenumber)" marker-end="url(#mermaid-figure-5-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="233" x2="79" y1="233" x1="390"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="237" x="390">3</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="248" x="590">“How are you?” (msg.vc=[1,3,0]) 再次自增后发送</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-5-sequencenumber)" marker-end="url(#mermaid-figure-5-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="279" x2="788" y1="279" x1="392"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="283" x="392">4</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="294" x="76">接收 “Hello” (vc=[2,2,0]) max([1,0,0],[1,2,0])→[1,2,0], 再自增 P0→[2,2,0]</text><path style="fill: none;" marker-start="url(#mermaid-figure-5-sequencenumber)" marker-end="url(#mermaid-figure-5-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 76,325 C 136,315 136,355 76,345"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="329" x="76">5</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="370" x="432">“Fine” (msg.vc=[3,2,0]) 发送前自增</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-5-sequencenumber)" marker-end="url(#mermaid-figure-5-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="401" x2="788" y1="401" x1="76"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="405" x="76">6</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="416" x="793">启动 (vc=[0,0,1]) 本地事件自增 P2</text><path style="fill: none;" marker-start="url(#mermaid-figure-5-sequencenumber)" marker-end="url(#mermaid-figure-5-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 793,447 C 853,437 853,477 793,467"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="451" x="793">7</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="492" x="793">接收 “How are you?” (vc=[1,3,2]) max([0,0,1],[1,3,0])→[1,3,1], 再自增 P2→[1,3,2]</text><path style="fill: none;" marker-start="url(#mermaid-figure-5-sequencenumber)" marker-end="url(#mermaid-figure-5-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 793,523 C 853,513 853,553 793,543"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="527" x="793">8</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="568" x="593">“Good” (msg.vc=[1,3,3]) 发送前自增</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-5-sequencenumber)" marker-end="url(#mermaid-figure-5-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="599" x2="395" y1="599" x1="791"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="603" x="791">9</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="614" x="392">接收 “Good” (vc=[1,4,3]) max([1,3,0],[1,3,3])→[1,3,3], 再自增 P1→[1,4,3]</text><path style="fill: none;" marker-start="url(#mermaid-figure-5-sequencenumber)" marker-end="url(#mermaid-figure-5-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 392,645 C 452,635 452,675 392,665"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="649" x="392">10</text>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="向量时钟示例续" class="slide level2 smaller">
<h2>向量时钟：示例（续）</h2>
<div class="columns">
<div class="column">
<p><strong>Alice</strong> / P1</p>
<ul>
<li>A1：发送 “Hi” → P1，vc = [1,0,0]</li>
<li>A2：接收 “Hello”（来自 P1），vc = [2,2,0]</li>
<li>A3：发送 “Fine” → P2，vc = [3,2,0]</li>
</ul>
<p><strong>Bob</strong> / P2</p>
<ul>
<li>B1：接收 “Hi”（来自 P0），vc = [1,1,0]</li>
<li>B2：发送 “Hello” → P0，vc = [1,2,0]</li>
<li>B3：发送 “How are you?” → P2，vc = [1,3,0]</li>
<li>B4：接收 “Good”（来自 P2），vc = [1,4,3]</li>
</ul>
</div><div class="column">
<p><strong>Charlie</strong> / P3</p>
<ul>
<li>C0：启动，vc = [0,0,1]</li>
<li>C1：接收 “How are you?”（来自 P1），vc = [1,3,2]</li>
<li>C2：发送 “Good” → P1，vc = [1,3,3]</li>
</ul>
<div class="cell" data-fig-height="2" data-fig-width="2" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<svg width="192" height="192" viewbox="0.00 0.00 125.49 64.92" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none; display: block; margin: auto auto auto auto">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 60.92)">
<title>Example</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-60.92 121.49,-60.92 121.49,4 -4,4"></polygon>
<!-- A1 -->
<g id="node1" class="node">
<title>A1</title>
<ellipse fill="none" stroke="black" cx="23.41" cy="-33.51" rx="23.33" ry="23.33"></ellipse>
<text text-anchor="middle" x="23.41" y="-29.31" font-family="Times,serif" font-size="14.00">A1</text>
</g>
<!-- B1 -->
<g id="node2" class="node">
<title>B1</title>
<ellipse fill="none" stroke="black" cx="94.62" cy="-22.87" rx="22.73" ry="22.73"></ellipse>
<text text-anchor="middle" x="94.62" y="-18.67" font-family="Times,serif" font-size="14.00">B1</text>
</g>
<!-- A1&#45;&gt;B1 -->
<g id="edge1" class="edge">
<title>A1-&gt;B1</title>
<path fill="none" stroke="black" d="M46.73,-30.02C51.55,-29.3 56.7,-28.53 61.79,-27.77"></path>
<polygon fill="black" stroke="black" points="62.61,-31.19 71.98,-26.25 61.57,-24.27 62.61,-31.19"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div></div>
</section>
<section id="向量时钟示例续-1" class="slide level2 smaller">
<h2>向量时钟：示例（续）</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<svg width="960" height="480" viewbox="0.00 0.00 564.21 339.20" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none; display: block; margin: auto auto auto auto">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 335.2)">
<title>HB</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-335.2 560.21,-335.2 560.21,4 -4,4"></polygon>
<text text-anchor="middle" x="278.11" y="-316.4" font-family="Helvetica,sans-Serif" font-size="12.00">Happened-Before 关系全图</text>
<g id="clust1" class="cluster">
<title>cluster_P0</title>
<polygon fill="#eaf5ff" stroke="#dddddd" points="401.58,-8 401.58,-228.8 491.58,-228.8 491.58,-8 401.58,-8"></polygon>
<text text-anchor="middle" x="446.58" y="-15.6" font-family="Helvetica,sans-Serif" font-size="12.00">Alice</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_P1</title>
<polygon fill="#eafaf0" stroke="#dddddd" points="213.58,-8 213.58,-300.8 323.58,-300.8 323.58,-8 213.58,-8"></polygon>
<text text-anchor="middle" x="268.58" y="-15.6" font-family="Helvetica,sans-Serif" font-size="12.00">Bob</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_P2</title>
<polygon fill="#fff5e6" stroke="#dddddd" points="45.58,-82.4 45.58,-300.8 135.58,-300.8 135.58,-82.4 45.58,-82.4"></polygon>
<text text-anchor="middle" x="90.58" y="-90" font-family="Helvetica,sans-Serif" font-size="12.00">Charlie</text>
</g>
<!-- A1 -->
<g id="node1" class="node">
<title>A1</title>
<path fill="white" stroke="black" d="M451.58,-74.4C451.58,-74.4 421.58,-74.4 421.58,-74.4 415.58,-74.4 409.58,-68.4 409.58,-62.4 409.58,-62.4 409.58,-50.4 409.58,-50.4 409.58,-44.4 415.58,-38.4 421.58,-38.4 421.58,-38.4 451.58,-38.4 451.58,-38.4 457.58,-38.4 463.58,-44.4 463.58,-50.4 463.58,-50.4 463.58,-62.4 463.58,-62.4 463.58,-68.4 457.58,-74.4 451.58,-74.4"></path>
<text text-anchor="middle" x="436.58" y="-59.7" font-family="Helvetica,sans-Serif" font-size="11.00">A1</text>
<text text-anchor="middle" x="436.58" y="-46.5" font-family="Helvetica,sans-Serif" font-size="11.00">[1,0,0]</text>
</g>
<!-- A2 -->
<g id="node2" class="node">
<title>A2</title>
<path fill="white" stroke="black" d="M451.58,-148.8C451.58,-148.8 421.58,-148.8 421.58,-148.8 415.58,-148.8 409.58,-142.8 409.58,-136.8 409.58,-136.8 409.58,-124.8 409.58,-124.8 409.58,-118.8 415.58,-112.8 421.58,-112.8 421.58,-112.8 451.58,-112.8 451.58,-112.8 457.58,-112.8 463.58,-118.8 463.58,-124.8 463.58,-124.8 463.58,-136.8 463.58,-136.8 463.58,-142.8 457.58,-148.8 451.58,-148.8"></path>
<text text-anchor="middle" x="436.58" y="-134.1" font-family="Helvetica,sans-Serif" font-size="11.00">A2</text>
<text text-anchor="middle" x="436.58" y="-120.9" font-family="Helvetica,sans-Serif" font-size="11.00">[2,2,0]</text>
</g>
<!-- A1&#45;&gt;A2 -->
<!-- A1&#45;&gt;A2 -->
<g id="edge8" class="edge">
<title>A1-&gt;A2</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M442.42,-74.56C443.3,-82.94 443.54,-93.23 443.14,-102.65"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="439.63,-102.54 442.4,-112.77 446.62,-103.04 439.63,-102.54"></polygon>
</g>
<!-- A3 -->
<g id="node3" class="node">
<title>A3</title>
<path fill="white" stroke="black" d="M451.58,-220.8C451.58,-220.8 421.58,-220.8 421.58,-220.8 415.58,-220.8 409.58,-214.8 409.58,-208.8 409.58,-208.8 409.58,-196.8 409.58,-196.8 409.58,-190.8 415.58,-184.8 421.58,-184.8 421.58,-184.8 451.58,-184.8 451.58,-184.8 457.58,-184.8 463.58,-190.8 463.58,-196.8 463.58,-196.8 463.58,-208.8 463.58,-208.8 463.58,-214.8 457.58,-220.8 451.58,-220.8"></path>
<text text-anchor="middle" x="436.58" y="-206.1" font-family="Helvetica,sans-Serif" font-size="11.00">A3</text>
<text text-anchor="middle" x="436.58" y="-192.9" font-family="Helvetica,sans-Serif" font-size="11.00">[3,2,0]</text>
</g>
<!-- A1&#45;&gt;A3 -->
<g id="edge19" class="edge">
<title>A1-&gt;A3</title>
<path fill="none" stroke="#999999" stroke-dasharray="5,2" d="M463.85,-71.81C467.36,-74.83 470.46,-78.35 472.58,-82.4 486.25,-108.55 481.25,-120.59 472.58,-148.8 469.57,-158.58 464.07,-168.18 458.26,-176.47"></path>
<polygon fill="#999999" stroke="#999999" points="455.38,-174.47 452.19,-184.57 460.98,-178.67 455.38,-174.47"></polygon>
</g>
<!-- B1 -->
<g id="node4" class="node">
<title>B1</title>
<path fill="white" stroke="black" d="M283.58,-74.4C283.58,-74.4 253.58,-74.4 253.58,-74.4 247.58,-74.4 241.58,-68.4 241.58,-62.4 241.58,-62.4 241.58,-50.4 241.58,-50.4 241.58,-44.4 247.58,-38.4 253.58,-38.4 253.58,-38.4 283.58,-38.4 283.58,-38.4 289.58,-38.4 295.58,-44.4 295.58,-50.4 295.58,-50.4 295.58,-62.4 295.58,-62.4 295.58,-68.4 289.58,-74.4 283.58,-74.4"></path>
<text text-anchor="middle" x="268.58" y="-59.7" font-family="Helvetica,sans-Serif" font-size="11.00">B1</text>
<text text-anchor="middle" x="268.58" y="-46.5" font-family="Helvetica,sans-Serif" font-size="11.00">[1,1,0]</text>
</g>
<!-- A1&#45;&gt;B1 -->
<g id="edge15" class="edge">
<title>A1-&gt;B1</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M409.36,-56.4C374.91,-56.4 340.46,-56.4 306.01,-56.4"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="305.81,-52.9 295.81,-56.4 305.81,-59.9 305.81,-52.9"></polygon>
</g>
<!-- B2 -->
<g id="node5" class="node">
<title>B2</title>
<path fill="white" stroke="black" d="M283.58,-148.8C283.58,-148.8 253.58,-148.8 253.58,-148.8 247.58,-148.8 241.58,-142.8 241.58,-136.8 241.58,-136.8 241.58,-124.8 241.58,-124.8 241.58,-118.8 247.58,-112.8 253.58,-112.8 253.58,-112.8 283.58,-112.8 283.58,-112.8 289.58,-112.8 295.58,-118.8 295.58,-124.8 295.58,-124.8 295.58,-136.8 295.58,-136.8 295.58,-142.8 289.58,-148.8 283.58,-148.8"></path>
<text text-anchor="middle" x="268.58" y="-134.1" font-family="Helvetica,sans-Serif" font-size="11.00">B2</text>
<text text-anchor="middle" x="268.58" y="-120.9" font-family="Helvetica,sans-Serif" font-size="11.00">[1,2,0]</text>
</g>
<!-- A1&#45;&gt;B2 -->
<g id="edge20" class="edge">
<title>A1-&gt;B2</title>
<path fill="none" stroke="#999999" stroke-dasharray="5,2" d="M409.57,-60.44C387.27,-63.7 355.23,-70.16 329.58,-82.4 316.97,-88.41 304.52,-97.38 294.19,-105.9"></path>
<polygon fill="#999999" stroke="#999999" points="291.72,-103.41 286.4,-112.58 296.27,-108.73 291.72,-103.41"></polygon>
</g>
<!-- B3 -->
<g id="node6" class="node">
<title>B3</title>
<path fill="white" stroke="black" d="M263.58,-220.8C263.58,-220.8 233.58,-220.8 233.58,-220.8 227.58,-220.8 221.58,-214.8 221.58,-208.8 221.58,-208.8 221.58,-196.8 221.58,-196.8 221.58,-190.8 227.58,-184.8 233.58,-184.8 233.58,-184.8 263.58,-184.8 263.58,-184.8 269.58,-184.8 275.58,-190.8 275.58,-196.8 275.58,-196.8 275.58,-208.8 275.58,-208.8 275.58,-214.8 269.58,-220.8 263.58,-220.8"></path>
<text text-anchor="middle" x="248.58" y="-206.1" font-family="Helvetica,sans-Serif" font-size="11.00">B3</text>
<text text-anchor="middle" x="248.58" y="-192.9" font-family="Helvetica,sans-Serif" font-size="11.00">[1,3,0]</text>
</g>
<!-- A1&#45;&gt;B3 -->
<g id="edge21" class="edge">
<title>A1-&gt;B3</title>
<path fill="none" stroke="#999999" stroke-dasharray="5,2" d="M411.65,-74.42C407.91,-77.06 404.13,-79.78 400.58,-82.4 356.91,-114.67 307.73,-153.84 277.44,-178.3"></path>
<polygon fill="#999999" stroke="#999999" points="274.99,-175.78 269.42,-184.79 279.4,-181.22 274.99,-175.78"></polygon>
</g>
<!-- B4 -->
<g id="node7" class="node">
<title>B4</title>
<path fill="white" stroke="black" d="M263.58,-292.8C263.58,-292.8 233.58,-292.8 233.58,-292.8 227.58,-292.8 221.58,-286.8 221.58,-280.8 221.58,-280.8 221.58,-268.8 221.58,-268.8 221.58,-262.8 227.58,-256.8 233.58,-256.8 233.58,-256.8 263.58,-256.8 263.58,-256.8 269.58,-256.8 275.58,-262.8 275.58,-268.8 275.58,-268.8 275.58,-280.8 275.58,-280.8 275.58,-286.8 269.58,-292.8 263.58,-292.8"></path>
<text text-anchor="middle" x="248.58" y="-278.1" font-family="Helvetica,sans-Serif" font-size="11.00">B4</text>
<text text-anchor="middle" x="248.58" y="-264.9" font-family="Helvetica,sans-Serif" font-size="11.00">[1,4,3]</text>
</g>
<!-- A1&#45;&gt;B4 -->
<g id="edge22" class="edge">
<title>A1-&gt;B4</title>
<path fill="none" stroke="#999999" stroke-dasharray="5,2" d="M463.91,-56.94C484.47,-58.22 511.42,-63.72 525.58,-82.4 564.87,-134.26 567.74,-179.24 525.58,-228.8 495.24,-264.47 354.29,-271.94 285.94,-273.45"></path>
<polygon fill="#999999" stroke="#999999" points="285.56,-269.96 275.63,-273.65 285.69,-276.96 285.56,-269.96"></polygon>
</g>
<!-- C1 -->
<g id="node9" class="node">
<title>C1</title>
<path fill="white" stroke="black" d="M115.58,-220.8C115.58,-220.8 85.58,-220.8 85.58,-220.8 79.58,-220.8 73.58,-214.8 73.58,-208.8 73.58,-208.8 73.58,-196.8 73.58,-196.8 73.58,-190.8 79.58,-184.8 85.58,-184.8 85.58,-184.8 115.58,-184.8 115.58,-184.8 121.58,-184.8 127.58,-190.8 127.58,-196.8 127.58,-196.8 127.58,-208.8 127.58,-208.8 127.58,-214.8 121.58,-220.8 115.58,-220.8"></path>
<text text-anchor="middle" x="100.58" y="-206.1" font-family="Helvetica,sans-Serif" font-size="11.00">C1</text>
<text text-anchor="middle" x="100.58" y="-192.9" font-family="Helvetica,sans-Serif" font-size="11.00">[1,3,2]</text>
</g>
<!-- A1&#45;&gt;C1 -->
<g id="edge23" class="edge">
<title>A1-&gt;C1</title>
<path fill="none" stroke="#999999" stroke-dasharray="5,2" d="M409.37,-62.61C387.39,-66.58 355.61,-71.8 327.58,-74.4 313.02,-75.75 74.75,-71.91 64.58,-82.4 39.82,-107.92 61.64,-149.84 80.47,-176.61"></path>
<polygon fill="#999999" stroke="#999999" points="77.68,-178.73 86.41,-184.73 83.33,-174.59 77.68,-178.73"></polygon>
</g>
<!-- C2 -->
<g id="node10" class="node">
<title>C2</title>
<path fill="white" stroke="black" d="M115.58,-292.8C115.58,-292.8 85.58,-292.8 85.58,-292.8 79.58,-292.8 73.58,-286.8 73.58,-280.8 73.58,-280.8 73.58,-268.8 73.58,-268.8 73.58,-262.8 79.58,-256.8 85.58,-256.8 85.58,-256.8 115.58,-256.8 115.58,-256.8 121.58,-256.8 127.58,-262.8 127.58,-268.8 127.58,-268.8 127.58,-280.8 127.58,-280.8 127.58,-286.8 121.58,-292.8 115.58,-292.8"></path>
<text text-anchor="middle" x="100.58" y="-278.1" font-family="Helvetica,sans-Serif" font-size="11.00">C2</text>
<text text-anchor="middle" x="100.58" y="-264.9" font-family="Helvetica,sans-Serif" font-size="11.00">[1,3,3]</text>
</g>
<!-- A1&#45;&gt;C2 -->
<g id="edge24" class="edge">
<title>A1-&gt;C2</title>
<path fill="none" stroke="#999999" stroke-dasharray="5,2" d="M463.66,-66.56C470.72,-70.32 477.5,-75.47 481.58,-82.4 514.64,-138.58 518.81,-182.84 472.58,-228.8 430.89,-270.24 267.85,-249.16 209.58,-256.8 185.7,-259.93 158.97,-264.09 137.97,-267.51"></path>
<polygon fill="#999999" stroke="#999999" points="137.15,-264.1 127.85,-269.17 138.28,-271 137.15,-264.1"></polygon>
</g>
<!-- A2&#45;&gt;A3 -->
<!-- A2&#45;&gt;A3 -->
<g id="edge9" class="edge">
<title>A2-&gt;A3</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M442.49,-149.1C443.29,-156.82 443.51,-166.09 443.17,-174.69"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="439.68,-174.48 442.47,-184.7 446.66,-174.96 439.68,-174.48"></polygon>
</g>
<!-- B1&#45;&gt;A2 -->
<g id="edge25" class="edge">
<title>B1-&gt;A2</title>
<path fill="none" stroke="#999999" stroke-dasharray="5,2" d="M295.64,-57.69C322.65,-59.09 364.48,-64.35 395.58,-82.4 405.03,-87.89 413.38,-96.38 420.04,-104.66"></path>
<polygon fill="#999999" stroke="#999999" points="417.31,-106.85 426.11,-112.75 422.91,-102.65 417.31,-106.85"></polygon>
</g>
<!-- B1&#45;&gt;A3 -->
<g id="edge26" class="edge">
<title>B1-&gt;A3</title>
<path fill="none" stroke="#999999" stroke-dasharray="5,2" d="M295.76,-68.62C303.76,-72.47 312.3,-77.14 319.58,-82.4 357.79,-110.01 394.61,-150.65 416.42,-176.67"></path>
<polygon fill="#999999" stroke="#999999" points="413.89,-179.09 422.96,-184.57 419.28,-174.63 413.89,-179.09"></polygon>
</g>
<!-- B1&#45;&gt;B2 -->
<!-- B1&#45;&gt;B2 -->
<g id="edge10" class="edge">
<title>B1-&gt;B2</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M274.42,-74.56C275.3,-82.94 275.54,-93.23 275.14,-102.65"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="271.63,-102.54 274.4,-112.77 278.62,-103.04 271.63,-102.54"></polygon>
</g>
<!-- B1&#45;&gt;B3 -->
<g id="edge27" class="edge">
<title>B1-&gt;B3</title>
<path fill="none" stroke="#999999" stroke-dasharray="5,2" d="M241.3,-71.81C237.79,-74.83 234.69,-78.35 232.58,-82.4 217.34,-111.52 226.84,-149.88 236.45,-175.16"></path>
<polygon fill="#999999" stroke="#999999" points="233.22,-176.53 240.22,-184.49 239.71,-173.91 233.22,-176.53"></polygon>
</g>
<!-- B1&#45;&gt;B4 -->
<g id="edge28" class="edge">
<title>B1-&gt;B4</title>
<path fill="none" stroke="#999999" stroke-dasharray="5,2" d="M295.85,-71.81C299.36,-74.83 302.46,-78.35 304.58,-82.4 318.25,-108.55 307.13,-119.4 304.58,-148.8 301.45,-184.76 306.67,-196.49 290.58,-228.8 286.96,-236.06 281.79,-242.98 276.31,-249.11"></path>
<polygon fill="#999999" stroke="#999999" points="273.69,-246.79 269.3,-256.43 278.75,-251.63 273.69,-246.79"></polygon>
</g>
<!-- B1&#45;&gt;C1 -->
<g id="edge29" class="edge">
<title>B1-&gt;C1</title>
<path fill="none" stroke="#999999" stroke-dasharray="5,2" d="M241.5,-58.26C182.28,-60.41 45.42,-67.02 31.58,-82.4 11.83,-104.33 18.53,-122.33 31.58,-148.8 38.68,-163.22 51.81,-174.81 64.72,-183.43"></path>
<polygon fill="#999999" stroke="#999999" points="63.21,-186.62 73.55,-188.93 66.9,-180.67 63.21,-186.62"></polygon>
</g>
<!-- B1&#45;&gt;C2 -->
<g id="edge30" class="edge">
<title>B1-&gt;C2</title>
<path fill="none" stroke="#999999" stroke-dasharray="5,2" d="M241.55,-58.06C179.41,-59.87 30.54,-65.88 15.58,-82.4 -29.63,-132.29 35.02,-210.14 74.27,-249.4"></path>
<polygon fill="#999999" stroke="#999999" points="72.14,-252.22 81.74,-256.72 77.04,-247.22 72.14,-252.22"></polygon>
</g>
<!-- B2&#45;&gt;A2 -->
<g id="edge16" class="edge">
<title>B2-&gt;A2</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M295.81,-130.8C330.26,-130.8 364.71,-130.8 399.16,-130.8"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="399.36,-134.3 409.36,-130.8 399.36,-127.3 399.36,-134.3"></polygon>
</g>
<!-- B2&#45;&gt;A3 -->
<g id="edge31" class="edge">
<title>B2-&gt;A3</title>
<path fill="none" stroke="#999999" stroke-dasharray="5,2" d="M295.94,-143.2C324.34,-155.03 368.9,-173.6 400.23,-186.66"></path>
<polygon fill="#999999" stroke="#999999" points="398.92,-189.9 409.5,-190.52 401.62,-183.44 398.92,-189.9"></polygon>
</g>
<!-- B2&#45;&gt;B3 -->
<!-- B2&#45;&gt;B3 -->
<g id="edge11" class="edge">
<title>B2-&gt;B3</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M269.55,-149.1C268.11,-156.99 265.61,-166.5 262.73,-175.25"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="259.43,-174.1 259.36,-184.7 266.02,-176.46 259.43,-174.1"></polygon>
</g>
<!-- B2&#45;&gt;B4 -->
<g id="edge32" class="edge">
<title>B2-&gt;B4</title>
<path fill="none" stroke="#999999" stroke-dasharray="5,2" d="M276.45,-149.07C284.33,-168.82 294.01,-201.9 284.58,-228.8 282.07,-235.94 277.91,-242.79 273.28,-248.89"></path>
<polygon fill="#999999" stroke="#999999" points="270.48,-246.79 266.79,-256.72 275.87,-251.25 270.48,-246.79"></polygon>
</g>
<!-- B2&#45;&gt;C1 -->
<g id="edge33" class="edge">
<title>B2-&gt;C1</title>
<path fill="none" stroke="#999999" stroke-dasharray="5,2" d="M241.21,-143.2C212.81,-155.03 168.26,-173.6 136.92,-186.66"></path>
<polygon fill="#999999" stroke="#999999" points="135.54,-183.44 127.65,-190.52 138.23,-189.9 135.54,-183.44"></polygon>
</g>
<!-- B2&#45;&gt;C2 -->
<g id="edge34" class="edge">
<title>B2-&gt;C2</title>
<path fill="none" stroke="#999999" stroke-dasharray="5,2" d="M248.31,-148.93C218.42,-174.2 162.4,-221.55 128.59,-250.12"></path>
<polygon fill="#999999" stroke="#999999" points="126.29,-247.48 120.91,-256.61 130.81,-252.83 126.29,-247.48"></polygon>
</g>
<!-- B3&#45;&gt;B4 -->
<!-- B3&#45;&gt;B4 -->
<g id="edge12" class="edge">
<title>B3-&gt;B4</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M254.49,-221.1C255.29,-228.82 255.51,-238.09 255.17,-246.69"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="251.68,-246.48 254.47,-256.7 258.66,-246.96 251.68,-246.48"></polygon>
</g>
<!-- B3&#45;&gt;C1 -->
<g id="edge17" class="edge">
<title>B3-&gt;C1</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M221.2,-202.8C193.46,-202.8 165.71,-202.8 137.97,-202.8"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="137.75,-199.3 127.75,-202.8 137.75,-206.3 137.75,-199.3"></polygon>
</g>
<!-- B3&#45;&gt;C2 -->
<g id="edge35" class="edge">
<title>B3-&gt;C2</title>
<path fill="none" stroke="#999999" stroke-dasharray="5,2" d="M221.43,-216.64C197.72,-227.85 163.11,-244.22 137,-256.57"></path>
<polygon fill="#999999" stroke="#999999" points="135.34,-253.48 127.8,-260.92 138.34,-259.81 135.34,-253.48"></polygon>
</g>
<!-- C0 -->
<g id="node8" class="node">
<title>C0</title>
<path fill="white" stroke="black" d="M115.58,-148.8C115.58,-148.8 85.58,-148.8 85.58,-148.8 79.58,-148.8 73.58,-142.8 73.58,-136.8 73.58,-136.8 73.58,-124.8 73.58,-124.8 73.58,-118.8 79.58,-112.8 85.58,-112.8 85.58,-112.8 115.58,-112.8 115.58,-112.8 121.58,-112.8 127.58,-118.8 127.58,-124.8 127.58,-124.8 127.58,-136.8 127.58,-136.8 127.58,-142.8 121.58,-148.8 115.58,-148.8"></path>
<text text-anchor="middle" x="100.58" y="-134.1" font-family="Helvetica,sans-Serif" font-size="11.00">C0</text>
<text text-anchor="middle" x="100.58" y="-120.9" font-family="Helvetica,sans-Serif" font-size="11.00">[0,0,1]</text>
</g>
<!-- C0&#45;&gt;B4 -->
<g id="edge37" class="edge">
<title>C0-&gt;B4</title>
<path fill="none" stroke="#999999" stroke-dasharray="5,2" d="M118.43,-148.93C144.54,-173.98 193.28,-220.75 223.14,-249.39"></path>
<polygon fill="#999999" stroke="#999999" points="221.02,-252.21 230.66,-256.61 225.87,-247.16 221.02,-252.21"></polygon>
</g>
<!-- C0&#45;&gt;C1 -->
<!-- C0&#45;&gt;C1 -->
<g id="edge13" class="edge">
<title>C0-&gt;C1</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M106.49,-149.1C107.29,-156.82 107.51,-166.09 107.17,-174.69"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="103.68,-174.48 106.47,-184.7 110.66,-174.96 103.68,-174.48"></polygon>
</g>
<!-- C0&#45;&gt;C2 -->
<g id="edge36" class="edge">
<title>C0-&gt;C2</title>
<path fill="none" stroke="#999999" stroke-dasharray="5,2" d="M84.97,-149.03C77.2,-158.77 68.63,-171.62 64.58,-184.8 58.83,-203.49 58.1,-210.35 64.58,-228.8 67.08,-235.94 71.25,-242.79 75.88,-248.89"></path>
<polygon fill="#999999" stroke="#999999" points="73.28,-251.25 82.36,-256.72 78.67,-246.79 73.28,-251.25"></polygon>
</g>
<!-- C1&#45;&gt;B4 -->
<g id="edge38" class="edge">
<title>C1-&gt;B4</title>
<path fill="none" stroke="#999999" stroke-dasharray="5,2" d="M127.72,-216.64C151.43,-227.85 186.04,-244.22 212.15,-256.57"></path>
<polygon fill="#999999" stroke="#999999" points="210.82,-259.81 221.35,-260.92 213.81,-253.48 210.82,-259.81"></polygon>
</g>
<!-- C1&#45;&gt;C2 -->
<!-- C1&#45;&gt;C2 -->
<g id="edge14" class="edge">
<title>C1-&gt;C2</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M106.49,-221.1C107.29,-228.82 107.51,-238.09 107.17,-246.69"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="103.68,-246.48 106.47,-256.7 110.66,-246.96 103.68,-246.48"></polygon>
</g>
<!-- C2&#45;&gt;B4 -->
<g id="edge18" class="edge">
<title>C2-&gt;B4</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M127.75,-274.8C155.49,-274.8 183.24,-274.8 210.98,-274.8"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="211.2,-278.3 221.2,-274.8 211.2,-271.3 211.2,-278.3"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="练习场景描述" class="slide level2 smaller">
<h2>练习：场景描述</h2>
<ul>
<li>P0 / ATM（客户存款前端）：受理客户向账户存入 ¥500，并把“存款事务”发给核心账本。</li>
<li>P1 / Ledger（核心账本服务）：接收并入账此存款，写 WAL；随后给 ATM 回执；并向移动端侧推送“余额已更新”事件；稍后处理来自移动端的余额查询并回复当前余额。</li>
<li>P2 / Mobile（移动端/余额查询）：用户打开 App；先收到“余额已更新”的推送，再主动发起“查询余额”，并收到账本回复。</li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>注记</strong></p>
</div>
<div class="callout-content">
<p>发送前对本进程分量 +1；接收时先逐位 max，再对本进程分量 +1</p>
</div>
</div>
</div>
</section>
<section id="练习时序" class="slide level2">
<h2>练习：时序</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<svg aria-roledescription="sequence" role="graphics-document document" viewbox="-58.5 -10 925.5 857" style="; display: block; margin: auto auto auto auto" xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="960" id="mermaid-figure-4" height="480">
<g><rect class="actor actor-bottom" ry="3" rx="3" name="P2" height="65" width="150" stroke="#666" fill="#eaeaea" y="771" x="626"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="803.5" x="701"><tspan dy="0" x="701">Mobile</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="P1" height="65" width="150" stroke="#666" fill="#eaeaea" y="771" x="295"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="803.5" x="370"><tspan dy="0" x="370">Ledger</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="P0" height="65" width="150" stroke="#666" fill="#eaeaea" y="771" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="803.5" x="75"><tspan dy="0" x="75">ATM</tspan></text></g><g><line name="P2" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="771" x2="701" y1="5" x1="701" id="actor2"></line><g id="root-2"><rect class="actor actor-top" ry="3" rx="3" name="P2" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="626"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="701"><tspan dy="0" x="701">Mobile</tspan></text></g></g><g><line name="P1" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="771" x2="370" y1="5" x1="370" id="actor1"></line><g id="root-1"><rect class="actor actor-top" ry="3" rx="3" name="P1" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="295"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="370"><tspan dy="0" x="370">Ledger</tspan></text></g></g><g><line name="P0" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="771" x2="75" y1="5" x1="75" id="actor0"></line><g id="root-0"><rect class="actor actor-top" ry="3" rx="3" name="P0" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="75"><tspan dy="0" x="75">ATM</tspan></text></g></g>
<style>#mermaid-figure-4{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-figure-4 .error-icon{fill:#552222;}#mermaid-figure-4 .error-text{fill:#552222;stroke:#552222;}#mermaid-figure-4 .edge-thickness-normal{stroke-width:1px;}#mermaid-figure-4 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-figure-4 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-figure-4 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-figure-4 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-figure-4 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-figure-4 .marker{fill:#333333;stroke:#333333;}#mermaid-figure-4 .marker.cross{stroke:#333333;}#mermaid-figure-4 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-figure-4 p{margin:0;}#mermaid-figure-4 .actor{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-4 text.actor>tspan{fill:black;stroke:none;}#mermaid-figure-4 .actor-line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-4 .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaid-figure-4 .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaid-figure-4 #mermaid-figure-4-arrowhead path{fill:#333;stroke:#333;}#mermaid-figure-4 .sequenceNumber{fill:white;}#mermaid-figure-4 #mermaid-figure-4-sequencenumber{fill:#333;}#mermaid-figure-4 #mermaid-figure-4-crosshead path{fill:#333;stroke:#333;}#mermaid-figure-4 .messageText{fill:#333;stroke:none;}#mermaid-figure-4 .labelBox{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-4 .labelText,#mermaid-figure-4 .labelText>tspan{fill:black;stroke:none;}#mermaid-figure-4 .loopText,#mermaid-figure-4 .loopText>tspan{fill:black;stroke:none;}#mermaid-figure-4 .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-4 .note{stroke:#aaaa33;fill:#fff5ad;}#mermaid-figure-4 .noteText,#mermaid-figure-4 .noteText>tspan{fill:black;stroke:none;}#mermaid-figure-4 .activation0{fill:#f4f4f4;stroke:#666;}#mermaid-figure-4 .activation1{fill:#f4f4f4;stroke:#666;}#mermaid-figure-4 .activation2{fill:#f4f4f4;stroke:#666;}#mermaid-figure-4 .actorPopupMenu{position:absolute;}#mermaid-figure-4 .actorPopupMenuPanel{position:absolute;fill:#ECECFF;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);filter:drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4));}#mermaid-figure-4 .actor-man line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-4 .actor-man circle,#mermaid-figure-4 line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;stroke-width:2px;}#mermaid-figure-4 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style>
<g></g><defs><symbol height="24" width="24" id="mermaid-figure-4-computer"><path d="M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z" transform="scale(.5)"></path></symbol></defs><defs><symbol clip-rule="evenodd" fill-rule="evenodd" id="mermaid-figure-4-database"><path d="M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z" transform="scale(.5)"></path></symbol></defs><defs><symbol height="24" width="24" id="mermaid-figure-4-clock"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z" transform="scale(.5)"></path></symbol></defs><defs><marker orient="auto-start-reverse" markerheight="12" markerwidth="12" markerunits="userSpaceOnUse" refy="5" refx="7.9" id="mermaid-figure-4-arrowhead"><path d="M -1 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker refy="4.5" refx="4" orient="auto" markerheight="8" markerwidth="15" id="mermaid-figure-4-crosshead"><path style="stroke-dasharray: 0, 0;" d="M 1,2 L 6,7 M 6,2 L 1,7" stroke-width="1pt" stroke="#000000" fill="none"></path></marker></defs><defs><marker orient="auto" markerheight="28" markerwidth="20" refy="7" refx="15.5" id="mermaid-figure-4-filled-head"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerheight="40" markerwidth="60" refy="15" refx="15" id="mermaid-figure-4-sequencenumber"><circle r="6" cy="15" cx="15"></circle></marker></defs><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="80" x="221">A1 存款 ¥500 (msg.vc=[1,0,0])</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-4-sequencenumber)" marker-end="url(#mermaid-figure-4-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="111" x2="366" y1="111" x1="76"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="115" x="76">1</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="126" x="371">B1 接收存款并入账 (vc=[1,1,0])</text><path style="fill: none;" marker-start="url(#mermaid-figure-4-sequencenumber)" marker-end="url(#mermaid-figure-4-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 371,157 C 431,147 431,187 371,177"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="161" x="371">2</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="202" x="224">B2 回执(已入账) (msg.vc=[1,2,0])</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-4-sequencenumber)" marker-end="url(#mermaid-figure-4-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="233" x2="79" y1="233" x1="369"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="237" x="369">3</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="248" x="534">B3 推送“余额已更新” (msg.vc=[1,3,0])</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-4-sequencenumber)" marker-end="url(#mermaid-figure-4-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="279" x2="697" y1="279" x1="371"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="283" x="371">4</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="294" x="76">A2 收到回执 (vc=[2,2,0])</text><path style="fill: none;" marker-start="url(#mermaid-figure-4-sequencenumber)" marker-end="url(#mermaid-figure-4-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 76,325 C 136,315 136,355 76,345"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="329" x="76">5</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="370" x="702">C0 打开App (vc=[0,0,1])</text><path style="fill: none;" marker-start="url(#mermaid-figure-4-sequencenumber)" marker-end="url(#mermaid-figure-4-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 702,401 C 762,391 762,431 702,421"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="405" x="702">6</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="446" x="702">C1 收到“余额已更新” (vc=[1,3,2])</text><path style="fill: none;" marker-start="url(#mermaid-figure-4-sequencenumber)" marker-end="url(#mermaid-figure-4-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 702,477 C 762,467 762,507 702,497"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="481" x="702">7</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="522" x="537">C2 查询余额 (msg.vc=[1,3,3])</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-4-sequencenumber)" marker-end="url(#mermaid-figure-4-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="553" x2="374" y1="553" x1="700"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="557" x="700">8</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="568" x="371">B4 接收查询 (vc=[1,4,3])</text><path style="fill: none;" marker-start="url(#mermaid-figure-4-sequencenumber)" marker-end="url(#mermaid-figure-4-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 371,599 C 431,589 431,629 371,619"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="603" x="371">9</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="644" x="534">B5 返回当前余额 (msg.vc=[1,5,3])</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-4-sequencenumber)" marker-end="url(#mermaid-figure-4-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="675" x2="697" y1="675" x1="371"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="679" x="371">10</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="690" x="702">C3 收到余额回复 (vc=[1,5,4])</text><path style="fill: none;" marker-start="url(#mermaid-figure-4-sequencenumber)" marker-end="url(#mermaid-figure-4-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 702,721 C 762,711 762,751 702,741"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="725" x="702">11</text>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="练习事件清单" class="slide level2 smaller">
<h2>练习：事件清单</h2>
<div class="columns">
<div class="column">
<ul>
<li>P0 / ATM
<ul>
<li>A1：发送“存款 ¥500” → P1，vc = [1,0,0]</li>
<li>A2：接收“回执(已入账)” ← P1，vc = [2,2,0]</li>
</ul></li>
<li>P1 / Ledger
<ul>
<li>B1：接收“存款” ← P0，vc = [1,1,0]</li>
<li>B2：发送“回执(已入账)” → P0，vc = [1,2,0]</li>
<li>B3：发送“余额已更新” → P2，vc = [1,3,0]</li>
</ul></li>
</ul>
</div><div class="column">
<ul>
<li>P1 / Ledger
<ul>
<li>B4：接收“查询余额” ← P2，vc = [1,4,3]</li>
<li>B5：发送“当前余额” → P2，vc = [1,5,3]</li>
</ul></li>
<li>P2 / Mobile
<ul>
<li>C0：打开 App，vc = [0,0,1]</li>
<li>C1：接收“余额已更新” ← P1，vc = [1,3,2]</li>
<li>C2：发送“查询余额” → P1，vc = [1,3,3]</li>
<li>C3：接收“当前余额” ← P1，vc = [1,5,4]</li>
</ul></li>
</ul>
</div></div>
</section>
<section id="练习hb-关系" class="slide level2">
<h2>练习：HB 关系</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<svg width="960" height="480" viewbox="0.00 0.00 813.50 262.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none; display: block; margin: auto auto auto auto">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 258)">
<title>HB_Deposit</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-258 809.5,-258 809.5,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_P0</title>
<polygon fill="#cfe8ff" stroke="#cfe8ff" points="8,-172 8,-246 189,-246 189,-172 8,-172"></polygon>
<text text-anchor="middle" x="98.5" y="-231.2" font-family="Helvetica,sans-Serif" font-size="12.00">P0 / ATM</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_P1</title>
<polygon fill="#dff5e5" stroke="#dff5e5" points="119,-90 119,-164 665.5,-164 665.5,-90 119,-90"></polygon>
<text text-anchor="middle" x="392.25" y="-149.2" font-family="Helvetica,sans-Serif" font-size="12.00">P1 / Ledger</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_P2</title>
<polygon fill="#fff0d9" stroke="#fff0d9" points="321,-8 321,-82 797.5,-82 797.5,-8 321,-8"></polygon>
<text text-anchor="middle" x="559.25" y="-67.2" font-family="Helvetica,sans-Serif" font-size="12.00">P2 / Mobile</text>
</g>
<!-- A1 -->
<g id="node1" class="node">
<title>A1</title>
<path fill="white" stroke="black" d="M58,-216C58,-216 28,-216 28,-216 22,-216 16,-210 16,-204 16,-204 16,-192 16,-192 16,-186 22,-180 28,-180 28,-180 58,-180 58,-180 64,-180 70,-186 70,-192 70,-192 70,-204 70,-204 70,-210 64,-216 58,-216"></path>
<text text-anchor="middle" x="43" y="-201.3" font-family="Helvetica,sans-Serif" font-size="11.00">A1</text>
<text text-anchor="middle" x="43" y="-188.1" font-family="Helvetica,sans-Serif" font-size="11.00">[1,0,0]</text>
</g>
<!-- A2 -->
<g id="node2" class="node">
<title>A2</title>
<path fill="white" stroke="black" d="M169,-216C169,-216 139,-216 139,-216 133,-216 127,-210 127,-204 127,-204 127,-192 127,-192 127,-186 133,-180 139,-180 139,-180 169,-180 169,-180 175,-180 181,-186 181,-192 181,-192 181,-204 181,-204 181,-210 175,-216 169,-216"></path>
<text text-anchor="middle" x="154" y="-201.3" font-family="Helvetica,sans-Serif" font-size="11.00">A2</text>
<text text-anchor="middle" x="154" y="-188.1" font-family="Helvetica,sans-Serif" font-size="11.00">[2,2,0]</text>
</g>
<!-- A1&#45;&gt;A2 -->
<g id="edge1" class="edge">
<title>A1-&gt;A2</title>
<path fill="none" stroke="#bbbbbb" stroke-dasharray="5,2" d="M70.11,-198C84.03,-198 101.37,-198 116.6,-198"></path>
<polygon fill="#bbbbbb" stroke="#bbbbbb" points="116.73,-201.5 126.73,-198 116.73,-194.5 116.73,-201.5"></polygon>
</g>
<!-- B1 -->
<g id="node3" class="node">
<title>B1</title>
<path fill="white" stroke="black" d="M169,-134C169,-134 139,-134 139,-134 133,-134 127,-128 127,-122 127,-122 127,-110 127,-110 127,-104 133,-98 139,-98 139,-98 169,-98 169,-98 175,-98 181,-104 181,-110 181,-110 181,-122 181,-122 181,-128 175,-134 169,-134"></path>
<text text-anchor="middle" x="154" y="-119.3" font-family="Helvetica,sans-Serif" font-size="11.00">B1</text>
<text text-anchor="middle" x="154" y="-106.1" font-family="Helvetica,sans-Serif" font-size="11.00">[1,1,0]</text>
</g>
<!-- A1&#45;&gt;B1 -->
<g id="edge9" class="edge">
<title>A1-&gt;B1</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M68.19,-179.8C83.57,-168.23 103.68,-153.1 120.45,-140.49"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="122.99,-142.96 128.88,-134.15 118.78,-137.36 122.99,-142.96"></polygon>
<text text-anchor="middle" x="98.5" y="-168.2" font-family="Times,serif" font-size="14.00">存款</text>
</g>
<!-- B2 -->
<g id="node4" class="node">
<title>B2</title>
<path fill="white" stroke="black" d="M280,-134C280,-134 250,-134 250,-134 244,-134 238,-128 238,-122 238,-122 238,-110 238,-110 238,-104 244,-98 250,-98 250,-98 280,-98 280,-98 286,-98 292,-104 292,-110 292,-110 292,-122 292,-122 292,-128 286,-134 280,-134"></path>
<text text-anchor="middle" x="265" y="-119.3" font-family="Helvetica,sans-Serif" font-size="11.00">B2</text>
<text text-anchor="middle" x="265" y="-106.1" font-family="Helvetica,sans-Serif" font-size="11.00">[1,2,0]</text>
</g>
<!-- B1&#45;&gt;B2 -->
<g id="edge2" class="edge">
<title>B1-&gt;B2</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M181.11,-116C195.03,-116 212.37,-116 227.6,-116"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="227.73,-119.5 237.73,-116 227.73,-112.5 227.73,-119.5"></polygon>
</g>
<!-- B2&#45;&gt;A2 -->
<g id="edge10" class="edge">
<title>B2-&gt;A2</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M239.88,-134.15C224.51,-145.71 204.41,-160.83 187.62,-173.46"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="185.08,-170.99 179.19,-179.8 189.29,-176.59 185.08,-170.99"></polygon>
<text text-anchor="middle" x="209.5" y="-168.2" font-family="Times,serif" font-size="14.00">回执</text>
</g>
<!-- B3 -->
<g id="node5" class="node">
<title>B3</title>
<path fill="white" stroke="black" d="M371,-134C371,-134 341,-134 341,-134 335,-134 329,-128 329,-122 329,-122 329,-110 329,-110 329,-104 335,-98 341,-98 341,-98 371,-98 371,-98 377,-98 383,-104 383,-110 383,-110 383,-122 383,-122 383,-128 377,-134 371,-134"></path>
<text text-anchor="middle" x="356" y="-119.3" font-family="Helvetica,sans-Serif" font-size="11.00">B3</text>
<text text-anchor="middle" x="356" y="-106.1" font-family="Helvetica,sans-Serif" font-size="11.00">[1,3,0]</text>
</g>
<!-- B2&#45;&gt;B3 -->
<g id="edge3" class="edge">
<title>B2-&gt;B3</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M292.22,-116C300.55,-116 309.91,-116 318.82,-116"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="318.97,-119.5 328.97,-116 318.97,-112.5 318.97,-119.5"></polygon>
</g>
<!-- B4 -->
<g id="node6" class="node">
<title>B4</title>
<path fill="white" stroke="black" d="M513.5,-134C513.5,-134 483.5,-134 483.5,-134 477.5,-134 471.5,-128 471.5,-122 471.5,-122 471.5,-110 471.5,-110 471.5,-104 477.5,-98 483.5,-98 483.5,-98 513.5,-98 513.5,-98 519.5,-98 525.5,-104 525.5,-110 525.5,-110 525.5,-122 525.5,-122 525.5,-128 519.5,-134 513.5,-134"></path>
<text text-anchor="middle" x="498.5" y="-119.3" font-family="Helvetica,sans-Serif" font-size="11.00">B4</text>
<text text-anchor="middle" x="498.5" y="-106.1" font-family="Helvetica,sans-Serif" font-size="11.00">[1,4,3]</text>
</g>
<!-- B3&#45;&gt;B4 -->
<g id="edge4" class="edge">
<title>B3-&gt;B4</title>
<path fill="none" stroke="#bbbbbb" stroke-dasharray="5,2" d="M383.1,-116C404.94,-116 436.37,-116 460.75,-116"></path>
<polygon fill="#bbbbbb" stroke="#bbbbbb" points="461.07,-119.5 471.07,-116 461.07,-112.5 461.07,-119.5"></polygon>
</g>
<!-- C1 -->
<g id="node9" class="node">
<title>C1</title>
<path fill="white" stroke="black" d="M513.5,-52C513.5,-52 483.5,-52 483.5,-52 477.5,-52 471.5,-46 471.5,-40 471.5,-40 471.5,-28 471.5,-28 471.5,-22 477.5,-16 483.5,-16 483.5,-16 513.5,-16 513.5,-16 519.5,-16 525.5,-22 525.5,-28 525.5,-28 525.5,-40 525.5,-40 525.5,-46 519.5,-52 513.5,-52"></path>
<text text-anchor="middle" x="498.5" y="-37.3" font-family="Helvetica,sans-Serif" font-size="11.00">C1</text>
<text text-anchor="middle" x="498.5" y="-24.1" font-family="Helvetica,sans-Serif" font-size="11.00">[1,3,2]</text>
</g>
<!-- B3&#45;&gt;C1 -->
<g id="edge11" class="edge">
<title>B3-&gt;C1</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M383.1,-100.77C405.43,-87.73 437.78,-68.85 462.38,-54.49"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="464.19,-57.49 471.07,-49.43 460.66,-51.45 464.19,-57.49"></polygon>
<text text-anchor="middle" x="427.25" y="-94.2" font-family="Times,serif" font-size="14.00">余额已更新</text>
</g>
<!-- B5 -->
<g id="node7" class="node">
<title>B5</title>
<path fill="white" stroke="black" d="M645.5,-134C645.5,-134 615.5,-134 615.5,-134 609.5,-134 603.5,-128 603.5,-122 603.5,-122 603.5,-110 603.5,-110 603.5,-104 609.5,-98 615.5,-98 615.5,-98 645.5,-98 645.5,-98 651.5,-98 657.5,-104 657.5,-110 657.5,-110 657.5,-122 657.5,-122 657.5,-128 651.5,-134 645.5,-134"></path>
<text text-anchor="middle" x="630.5" y="-119.3" font-family="Helvetica,sans-Serif" font-size="11.00">B5</text>
<text text-anchor="middle" x="630.5" y="-106.1" font-family="Helvetica,sans-Serif" font-size="11.00">[1,5,3]</text>
</g>
<!-- B4&#45;&gt;B5 -->
<g id="edge5" class="edge">
<title>B4-&gt;B5</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M525.81,-116C545.19,-116 571.79,-116 593.2,-116"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="593.23,-119.5 603.23,-116 593.23,-112.5 593.23,-119.5"></polygon>
</g>
<!-- C3 -->
<g id="node11" class="node">
<title>C3</title>
<path fill="white" stroke="black" d="M777.5,-52C777.5,-52 747.5,-52 747.5,-52 741.5,-52 735.5,-46 735.5,-40 735.5,-40 735.5,-28 735.5,-28 735.5,-22 741.5,-16 747.5,-16 747.5,-16 777.5,-16 777.5,-16 783.5,-16 789.5,-22 789.5,-28 789.5,-28 789.5,-40 789.5,-40 789.5,-46 783.5,-52 777.5,-52"></path>
<text text-anchor="middle" x="762.5" y="-37.3" font-family="Helvetica,sans-Serif" font-size="11.00">C3</text>
<text text-anchor="middle" x="762.5" y="-24.1" font-family="Helvetica,sans-Serif" font-size="11.00">[1,5,4]</text>
</g>
<!-- B5&#45;&gt;C3 -->
<g id="edge13" class="edge">
<title>B5-&gt;C3</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M657.81,-99.41C677.63,-86.9 705,-69.64 726.65,-55.98"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="728.64,-58.86 735.23,-50.57 724.91,-52.94 728.64,-58.86"></polygon>
<text text-anchor="middle" x="696.5" y="-92.2" font-family="Times,serif" font-size="14.00">余额回复</text>
</g>
<!-- C0 -->
<g id="node8" class="node">
<title>C0</title>
<path fill="white" stroke="black" d="M371,-52C371,-52 341,-52 341,-52 335,-52 329,-46 329,-40 329,-40 329,-28 329,-28 329,-22 335,-16 341,-16 341,-16 371,-16 371,-16 377,-16 383,-22 383,-28 383,-28 383,-40 383,-40 383,-46 377,-52 371,-52"></path>
<text text-anchor="middle" x="356" y="-37.3" font-family="Helvetica,sans-Serif" font-size="11.00">C0</text>
<text text-anchor="middle" x="356" y="-24.1" font-family="Helvetica,sans-Serif" font-size="11.00">[0,0,1]</text>
</g>
<!-- C0&#45;&gt;C1 -->
<g id="edge6" class="edge">
<title>C0-&gt;C1</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M383.1,-34C404.94,-34 436.37,-34 460.75,-34"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="461.07,-37.5 471.07,-34 461.07,-30.5 461.07,-37.5"></polygon>
</g>
<!-- C2 -->
<g id="node10" class="node">
<title>C2</title>
<path fill="white" stroke="black" d="M645.5,-52C645.5,-52 615.5,-52 615.5,-52 609.5,-52 603.5,-46 603.5,-40 603.5,-40 603.5,-28 603.5,-28 603.5,-22 609.5,-16 615.5,-16 615.5,-16 645.5,-16 645.5,-16 651.5,-16 657.5,-22 657.5,-28 657.5,-28 657.5,-40 657.5,-40 657.5,-46 651.5,-52 645.5,-52"></path>
<text text-anchor="middle" x="630.5" y="-37.3" font-family="Helvetica,sans-Serif" font-size="11.00">C2</text>
<text text-anchor="middle" x="630.5" y="-24.1" font-family="Helvetica,sans-Serif" font-size="11.00">[1,3,3]</text>
</g>
<!-- C1&#45;&gt;C2 -->
<g id="edge7" class="edge">
<title>C1-&gt;C2</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M525.81,-34C545.19,-34 571.79,-34 593.2,-34"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="593.23,-37.5 603.23,-34 593.23,-30.5 593.23,-37.5"></polygon>
</g>
<!-- C2&#45;&gt;B4 -->
<g id="edge12" class="edge">
<title>C2-&gt;B4</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M603.23,-50.57C583.42,-63.07 556.05,-80.33 534.4,-93.99"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="532.4,-91.11 525.81,-99.41 536.13,-97.03 532.4,-91.11"></polygon>
<text text-anchor="middle" x="564.5" y="-92.2" font-family="Times,serif" font-size="14.00">查询余额</text>
</g>
<!-- C2&#45;&gt;C3 -->
<g id="edge8" class="edge">
<title>C2-&gt;C3</title>
<path fill="none" stroke="#bbbbbb" stroke-dasharray="5,2" d="M657.81,-34C677.19,-34 703.79,-34 725.2,-34"></path>
<polygon fill="#bbbbbb" stroke="#bbbbbb" points="725.23,-37.5 735.23,-34 725.23,-30.5 725.23,-37.5"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section></section>
<section>
<section id="工业方案" class="title-slide slide level1 center">
<h1>工业方案</h1>

</section>
<section id="混合逻辑时钟hlc" class="slide level2">
<h2>混合逻辑时钟（HLC）</h2>
<ul>
<li>结构：<code>(pt, lc)</code> = 物理时间戳 + 逻辑计数器</li>
<li>在保留物理时间可读性的同时，用逻辑计数消除回拨/并发造成的逆序</li>
<li>对事件用词典序 <code>(pt, lc, node_id)</code> 排序即可得到全序，同时保持消息的因果先后不被时钟偏差打乱</li>
</ul>
</section>
<section id="混合逻辑时钟本地事件tick" class="slide level2">
<h2>混合逻辑时钟：本地事件（tick）</h2>
<ul>
<li>读取当前物理时间 <code>now</code>，令 <code>pt ← max(pt, now)</code>。</li>
<li>若 <code>pt == now</code>（物理时间未落后于本地 HLC），则 <code>lc ← lc + 1</code>；否则（<code>pt</code> 来自旧的 HLC 而非 <code>now</code>），<code>lc ← 0</code>。</li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>注记</strong></p>
</div>
<div class="callout-content">
<p>优先跟随物理时间；当物理时间未回退时，逻辑计数器累加用来区分同一物理毫秒内的多事件。</p>
</div>
</div>
</div>
</section>
<section id="混合逻辑时钟发送消息send" class="slide level2 smaller">
<h2>混合逻辑时钟：发送消息（send）</h2>
<ul>
<li>先执行一次<strong>本地事件</strong>更新。</li>
<li>将当前 <code>(pt, lc)</code> 附在消息上发送。</li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>注记</strong></p>
</div>
<div class="callout-content">
<p>每次发送都会产生一个<strong>单调递增</strong>的本地 HLC，并把这个“时间证据”随消息传播出去。</p>
</div>
</div>
</div>
</section>
<section id="混合逻辑时钟接收消息recv" class="slide level2 smaller">
<h2>混合逻辑时钟：接收消息（recv）</h2>
<ul>
<li><p>读取 <code>now</code>，令 <code>pt ← max(local.pt, msg.pt, now)</code>。</p></li>
<li><p>然后根据 <code>pt</code> 的来源更新 <code>lc</code>：</p>
<ul>
<li>若 <code>pt == msg.pt == now</code>：<code>lc ← max(local.lc, msg.lc) + 1</code></li>
<li>若 <code>pt == msg.pt</code>：<code>lc ← msg.lc + 1</code></li>
<li>若 <code>pt == now</code>：<code>lc ← local.lc + 1</code></li>
<li>否则：<code>lc ← 0</code></li>
</ul></li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>注记</strong></p>
</div>
<div class="callout-content">
<p>接收方把“最大时间证据”合并进来，并用 <code>lc</code> 打破同毫秒内或跨源的并发/并列，确保 <strong>send &lt; recv</strong> 的因果单调性。</p>
</div>
</div>
</div>
</section>
<section id="混合逻辑时钟算法" class="slide level2">
<h2>混合逻辑时钟：算法</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href=""></a><span class="im">import</span> time</span>
<span id="cb4-2"><a href=""></a></span>
<span id="cb4-3"><a href=""></a><span class="kw">class</span> HLC:</span>
<span id="cb4-4"><a href=""></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb4-5"><a href=""></a>        <span class="va">self</span>.pt <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-6"><a href=""></a>        <span class="va">self</span>.lc <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-7"><a href=""></a></span>
<span id="cb4-8"><a href=""></a>    <span class="kw">def</span> now_ms(<span class="va">self</span>):</span>
<span id="cb4-9"><a href=""></a>        <span class="cf">return</span> <span class="bu">int</span>(time.time() <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb4-10"><a href=""></a></span>
<span id="cb4-11"><a href=""></a>    <span class="kw">def</span> tick(<span class="va">self</span>):</span>
<span id="cb4-12"><a href=""></a>        now <span class="op">=</span> <span class="va">self</span>.now_ms()</span>
<span id="cb4-13"><a href=""></a>        <span class="va">self</span>.pt <span class="op">=</span> <span class="bu">max</span>(<span class="va">self</span>.pt, now)</span>
<span id="cb4-14"><a href=""></a>        <span class="va">self</span>.lc <span class="op">=</span> (<span class="va">self</span>.lc <span class="op">+</span> <span class="dv">1</span>) <span class="cf">if</span> <span class="va">self</span>.pt <span class="op">==</span> now <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb4-15"><a href=""></a>        <span class="cf">return</span> (<span class="va">self</span>.pt, <span class="va">self</span>.lc)</span>
<span id="cb4-16"><a href=""></a></span>
<span id="cb4-17"><a href=""></a>    <span class="kw">def</span> send(<span class="va">self</span>, m):</span>
<span id="cb4-18"><a href=""></a>        m[<span class="st">"hlc"</span>] <span class="op">=</span> <span class="va">self</span>.tick()</span>
<span id="cb4-19"><a href=""></a>        <span class="cf">return</span> m</span>
<span id="cb4-20"><a href=""></a></span>
<span id="cb4-21"><a href=""></a>    <span class="kw">def</span> recv(<span class="va">self</span>, m):</span>
<span id="cb4-22"><a href=""></a>        mpt, mlc <span class="op">=</span> m[<span class="st">"hlc"</span>]</span>
<span id="cb4-23"><a href=""></a>        now <span class="op">=</span> <span class="va">self</span>.now_ms()</span>
<span id="cb4-24"><a href=""></a>        <span class="va">self</span>.pt <span class="op">=</span> <span class="bu">max</span>(<span class="va">self</span>.pt, mpt, now)</span>
<span id="cb4-25"><a href=""></a>        <span class="cf">if</span> <span class="va">self</span>.pt <span class="op">==</span> mpt <span class="op">==</span> now:</span>
<span id="cb4-26"><a href=""></a>            <span class="va">self</span>.lc <span class="op">=</span> <span class="bu">max</span>(<span class="va">self</span>.lc, mlc) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb4-27"><a href=""></a>        <span class="cf">elif</span> <span class="va">self</span>.pt <span class="op">==</span> mpt:</span>
<span id="cb4-28"><a href=""></a>            <span class="va">self</span>.lc <span class="op">=</span> mlc <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb4-29"><a href=""></a>        <span class="cf">elif</span> <span class="va">self</span>.pt <span class="op">==</span> now:</span>
<span id="cb4-30"><a href=""></a>            <span class="va">self</span>.lc <span class="op">=</span> <span class="va">self</span>.lc <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb4-31"><a href=""></a>        <span class="cf">else</span>:</span>
<span id="cb4-32"><a href=""></a>            <span class="va">self</span>.lc <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-33"><a href=""></a>        <span class="cf">return</span> (<span class="va">self</span>.pt, <span class="va">self</span>.lc)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>参考</strong>：<a href="https://cse.buffalo.edu/tech-reports/2014-04.pdf">Kulkarni et al.&nbsp;2014（PODC）</a></p>
</section>
<section id="混合逻辑时钟示例" class="slide level2">
<h2>混合逻辑时钟：示例</h2>
<p>还是<strong>银行转账</strong>的例子：</p>
<ul>
<li><strong>P0（Client/Alice 手机）</strong>：向银行发起“转账 ¥100 给 Bob”。</li>
<li><strong>P1（Ledger/核心账本）</strong>：收到转账→扣减 Alice 账户→向分区/副本发“记入 Bob（待确认）”→收到副本确认→给客户端回执。</li>
<li><strong>P2（Replica/分区副本）</strong>：收到“记入 Bob”→入账→回 Ack。</li>
</ul>
<blockquote>
<p>采用 HLC=<code>(pt,lc)</code>，以毫秒计。发送前先本地 tick；接收用三元 <code>max</code> 合并后按规则更新 <code>lc</code>。节点号用 P0=0，P1=1，P2=2 作为并列时的最后比较键。</p>
</blockquote>
</section>
<section id="混合逻辑时钟示例续" class="slide level2">
<h2>混合逻辑时钟：示例（续）</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<svg aria-roledescription="sequence" role="graphics-document document" viewbox="-236.5 -10 1287.5 1345" style="; display: block; margin: auto auto auto auto" xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="960" id="mermaid-figure-3" height="480">
<rect class="rect" height="88" width="523" fill="rgba(220,240,255,0.5)" y="1151" x="-186.5"></rect><rect class="rect" height="88" width="523" fill="rgba(220,240,255,0.5)" y="882" x="138.5"></rect><rect class="rect" height="88" width="502" fill="rgba(220,240,255,0.5)" y="488" x="499"></rect><rect class="rect" height="88" width="502" fill="rgba(220,240,255,0.5)" y="170" x="149"></rect><g><rect class="actor actor-bottom" ry="3" rx="3" name="P2" height="65" width="150" stroke="#666" fill="#eaeaea" y="1259" x="675"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="1291.5" x="750"><tspan dy="0" x="750">Replica</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="P1" height="65" width="150" stroke="#666" fill="#eaeaea" y="1259" x="325"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="1291.5" x="400"><tspan dy="0" x="400">Ledger</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="P0" height="65" width="150" stroke="#666" fill="#eaeaea" y="1259" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="1291.5" x="75"><tspan dy="0" x="75">Client</tspan></text></g><g><line name="P2" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="1259" x2="750" y1="5" x1="750" id="actor2"></line><g id="root-2"><rect class="actor actor-top" ry="3" rx="3" name="P2" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="675"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="750"><tspan dy="0" x="750">Replica</tspan></text></g></g><g><line name="P1" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="1259" x2="400" y1="5" x1="400" id="actor1"></line><g id="root-1"><rect class="actor actor-top" ry="3" rx="3" name="P1" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="325"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="400"><tspan dy="0" x="400">Ledger</tspan></text></g></g><g><line name="P0" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="1259" x2="75" y1="5" x1="75" id="actor0"></line><g id="root-0"><rect class="actor actor-top" ry="3" rx="3" name="P0" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="75"><tspan dy="0" x="75">Client</tspan></text></g></g>
<style>#mermaid-figure-3{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-figure-3 .error-icon{fill:#552222;}#mermaid-figure-3 .error-text{fill:#552222;stroke:#552222;}#mermaid-figure-3 .edge-thickness-normal{stroke-width:1px;}#mermaid-figure-3 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-figure-3 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-figure-3 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-figure-3 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-figure-3 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-figure-3 .marker{fill:#333333;stroke:#333333;}#mermaid-figure-3 .marker.cross{stroke:#333333;}#mermaid-figure-3 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-figure-3 p{margin:0;}#mermaid-figure-3 .actor{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-3 text.actor>tspan{fill:black;stroke:none;}#mermaid-figure-3 .actor-line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-3 .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaid-figure-3 .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaid-figure-3 #mermaid-figure-3-arrowhead path{fill:#333;stroke:#333;}#mermaid-figure-3 .sequenceNumber{fill:white;}#mermaid-figure-3 #mermaid-figure-3-sequencenumber{fill:#333;}#mermaid-figure-3 #mermaid-figure-3-crosshead path{fill:#333;stroke:#333;}#mermaid-figure-3 .messageText{fill:#333;stroke:none;}#mermaid-figure-3 .labelBox{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-3 .labelText,#mermaid-figure-3 .labelText>tspan{fill:black;stroke:none;}#mermaid-figure-3 .loopText,#mermaid-figure-3 .loopText>tspan{fill:black;stroke:none;}#mermaid-figure-3 .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-3 .note{stroke:#aaaa33;fill:#fff5ad;}#mermaid-figure-3 .noteText,#mermaid-figure-3 .noteText>tspan{fill:black;stroke:none;}#mermaid-figure-3 .activation0{fill:#f4f4f4;stroke:#666;}#mermaid-figure-3 .activation1{fill:#f4f4f4;stroke:#666;}#mermaid-figure-3 .activation2{fill:#f4f4f4;stroke:#666;}#mermaid-figure-3 .actorPopupMenu{position:absolute;}#mermaid-figure-3 .actorPopupMenuPanel{position:absolute;fill:#ECECFF;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);filter:drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4));}#mermaid-figure-3 .actor-man line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-3 .actor-man circle,#mermaid-figure-3 line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;stroke-width:2px;}#mermaid-figure-3 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style>
<g></g><defs><symbol height="24" width="24" id="mermaid-figure-3-computer"><path d="M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z" transform="scale(.5)"></path></symbol></defs><defs><symbol clip-rule="evenodd" fill-rule="evenodd" id="mermaid-figure-3-database"><path d="M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z" transform="scale(.5)"></path></symbol></defs><defs><symbol height="24" width="24" id="mermaid-figure-3-clock"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z" transform="scale(.5)"></path></symbol></defs><defs><marker orient="auto-start-reverse" markerheight="12" markerwidth="12" markerunits="userSpaceOnUse" refy="5" refx="7.9" id="mermaid-figure-3-arrowhead"><path d="M -1 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker refy="4.5" refx="4" orient="auto" markerheight="8" markerwidth="15" id="mermaid-figure-3-crosshead"><path style="stroke-dasharray: 0, 0;" d="M 1,2 L 6,7 M 6,2 L 1,7" stroke-width="1pt" stroke="#000000" fill="none"></path></marker></defs><defs><marker orient="auto" markerheight="28" markerwidth="20" refy="7" refx="15.5" id="mermaid-figure-3-filled-head"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerheight="40" markerwidth="60" refy="15" refx="15" id="mermaid-figure-3-sequencenumber"><circle r="6" cy="15" cx="15"></circle></marker></defs><g><rect class="note" height="39" width="200" stroke="#666" fill="#EDF2AE" y="75" x="-25"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="80" x="75"><tspan x="75">tick: now=1000 → (1000,1)</tspan></text></g><g><rect class="note" height="58" width="482" stroke="#666" fill="#EDF2AE" y="190" x="159"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="195" x="400"><tspan x="400">recv: now=0999</tspan></text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="214" x="400"><tspan x="400">pt=max(0,1000,999)=1000，pt==msg.pt → lc=msg.lc+1=2 → (1000,2)</tspan></text></g><g><rect class="note" height="39" width="382" stroke="#666" fill="#EDF2AE" y="268" x="209"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="273" x="400"><tspan x="400">local: now=1000 → pt=1000==now → lc=3 → (1000,3)</tspan></text></g><g><rect class="note" height="39" width="306" stroke="#666" fill="#EDF2AE" y="393" x="247"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="398" x="400"><tspan x="400">send 前 tick: now=1000 → lc=4 → (1000,4)</tspan></text></g><g><rect class="note" height="58" width="482" stroke="#666" fill="#EDF2AE" y="508" x="509"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="513" x="750"><tspan x="750">recv: now=0995</tspan></text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="532" x="750"><tspan x="750">pt=max(0,1000,995)=1000，pt==msg.pt → lc=msg.lc+1=5 → (1000,5)</tspan></text></g><g><rect class="note" height="39" width="259" stroke="#666" fill="#EDF2AE" y="662" x="620.5"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="667" x="750"><tspan x="750">local: now=1000 → lc=6 → (1000,6)</tspan></text></g><g><rect class="note" height="39" width="306" stroke="#666" fill="#EDF2AE" y="787" x="597"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="792" x="750"><tspan x="750">send 前 tick: now=1000 → lc=7 → (1000,7)</tspan></text></g><g><rect class="note" height="58" width="503" stroke="#666" fill="#EDF2AE" y="902" x="148.5"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="907" x="400"><tspan x="400">recv: now=1001</tspan></text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="926" x="400"><tspan x="400">pt=max(1000,1000,1001)=1001，pt==now → lc=local.lc+1=5 → (1001,5)</tspan></text></g><g><rect class="note" height="39" width="306" stroke="#666" fill="#EDF2AE" y="1056" x="247"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="1061" x="400"><tspan x="400">send 前 tick: now=1001 → lc=6 → (1001,6)</tspan></text></g><g><rect class="note" height="58" width="503" stroke="#666" fill="#EDF2AE" y="1171" x="-176.5"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="1176" x="75"><tspan x="75">recv: now=1002</tspan></text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="1195" x="75"><tspan x="75">pt=max(1000,1001,1002)=1002，pt==now → lc=local.lc+1=2 → (1002,2)</tspan></text></g><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="129" x="236">E1 TransferRequest (msg.hlc=(1000,1))</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-3-sequencenumber)" marker-end="url(#mermaid-figure-3-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="160" x2="396" y1="160" x1="76"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="164" x="76">1</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="322" x="401">E3 Debit(Alice) (1000,3)</text><path style="fill: none;" marker-start="url(#mermaid-figure-3-sequencenumber)" marker-end="url(#mermaid-figure-3-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 401,353 C 461,343 461,383 401,373"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="357" x="401">2</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="447" x="574">E4 Credit(Bob,prepare) (msg.hlc=(1000,4))</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-3-sequencenumber)" marker-end="url(#mermaid-figure-3-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="478" x2="746" y1="478" x1="401"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="482" x="401">3</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="591" x="751">E5 Apply(Bob,hold) (1000,5)</text><path style="fill: none;" marker-start="url(#mermaid-figure-3-sequencenumber)" marker-end="url(#mermaid-figure-3-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 751,622 C 811,612 811,652 751,642"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="626" x="751">4</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="716" x="751">E6 Commit(Bob) (1000,6)</text><path style="fill: none;" marker-start="url(#mermaid-figure-3-sequencenumber)" marker-end="url(#mermaid-figure-3-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 751,747 C 811,737 811,777 751,767"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="751" x="751">5</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="841" x="577">E7 Ack (msg.hlc=(1000,7))</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-3-sequencenumber)" marker-end="url(#mermaid-figure-3-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="872" x2="404" y1="872" x1="749"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="876" x="749">6</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="985" x="401">E8 Finalize Tx (1001,5)</text><path style="fill: none;" marker-start="url(#mermaid-figure-3-sequencenumber)" marker-end="url(#mermaid-figure-3-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 401,1016 C 461,1006 461,1046 401,1036"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="1020" x="401">7</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="1110" x="239">E9 Receipt (msg.hlc=(1001,6))</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-3-sequencenumber)" marker-end="url(#mermaid-figure-3-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="1141" x2="79" y1="1141" x1="399"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="1145" x="399">8</text>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="混合逻辑时钟示例续-1" class="slide level2 smaller">
<h2>混合逻辑时钟：示例（续）</h2>
<p>记节点号 P0=0，P1=1，P2=2，用词典序 <code>(pt,lc,node)</code> 排序：</p>
<table class="caption-top">
<thead>
<tr class="header">
<th>事件</th>
<th>描述</th>
<th>HLC=(pt,lc)</th>
<th>node</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>E1</strong></td>
<td>P0 发送 TransferRequest → P1</td>
<td>(1000,1)</td>
<td>0</td>
</tr>
<tr class="even">
<td><strong>E2</strong></td>
<td>P1 接收 TransferRequest</td>
<td>(1000,2)</td>
<td>1</td>
</tr>
<tr class="odd">
<td><strong>E3</strong></td>
<td>P1 本地扣款 Alice</td>
<td>(1000,3)</td>
<td>1</td>
</tr>
<tr class="even">
<td><strong>E4</strong></td>
<td>P1 发送 Credit(Bob) → P2</td>
<td>(1000,4)</td>
<td>1</td>
</tr>
<tr class="odd">
<td><strong>E5</strong></td>
<td>P2 接收 Credit</td>
<td>(1000,5)</td>
<td>2</td>
</tr>
<tr class="even">
<td><strong>E6</strong></td>
<td>P2 本地提交 Bob</td>
<td>(1000,6)</td>
<td>2</td>
</tr>
<tr class="odd">
<td><strong>E7</strong></td>
<td>P2 发送 Ack → P1</td>
<td>(1000,7)</td>
<td>2</td>
</tr>
<tr class="even">
<td><strong>E8</strong></td>
<td>P1 接收 Ack 并最终提交</td>
<td>(1001,5)</td>
<td>1</td>
</tr>
<tr class="odd">
<td><strong>E9</strong></td>
<td>P1 发送回执 → P0</td>
<td>(1001,6)</td>
<td>1</td>
</tr>
<tr class="even">
<td><strong>E10</strong></td>
<td>P0 接收回执</td>
<td>(1002,2)</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>物理时间跨节点有偏差，但 HLC 保证 <strong>send &lt; recv</strong> 与整体单调性，体现了<strong>因果性</strong></p>
</section>
<section id="混合逻辑时钟示例续-2" class="slide level2 smaller">
<h2>混合逻辑时钟：示例（续）</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<svg width="960" height="480" viewbox="0.00 0.00 956.18 287.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none; display: block; margin: auto auto auto auto">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 283)">
<title>HB_Transfer_HLC</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-283 952.18,-283 952.18,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_P0</title>
<polygon fill="#cfe8ff" stroke="#cfe8ff" points="629.69,-8 629.69,-82 940.18,-82 940.18,-8 629.69,-8"></polygon>
<text text-anchor="middle" x="784.94" y="-67.2" font-family="Helvetica,sans-Serif" font-size="12.00">P0 / Client</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_P1</title>
<polygon fill="#dff5e5" stroke="#dff5e5" points="8,-90 8,-164 757.38,-164 757.38,-90 8,-90"></polygon>
<text text-anchor="middle" x="382.69" y="-149.2" font-family="Helvetica,sans-Serif" font-size="12.00">P1 / Ledger</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_P2</title>
<polygon fill="#fff0d9" stroke="#fff0d9" points="473.06,-197 473.06,-271 939.27,-271 939.27,-197 473.06,-197"></polygon>
<text text-anchor="middle" x="706.17" y="-256.2" font-family="Helvetica,sans-Serif" font-size="12.00">P2 / Replica</text>
</g>
<!-- E1 -->
<g id="node1" class="node">
<title>E1</title>
<path fill="white" stroke="black" d="M728.01,-52C728.01,-52 649.58,-52 649.58,-52 643.58,-52 637.58,-46 637.58,-40 637.58,-40 637.58,-28 637.58,-28 637.58,-22 643.58,-16 649.58,-16 649.58,-16 728.01,-16 728.01,-16 734.01,-16 740.01,-22 740.01,-28 740.01,-28 740.01,-40 740.01,-40 740.01,-46 734.01,-52 728.01,-52"></path>
<text text-anchor="middle" x="688.79" y="-37.3" font-family="Helvetica,sans-Serif" font-size="11.00">E1 Send Transfer</text>
<text text-anchor="middle" x="688.79" y="-24.1" font-family="Helvetica,sans-Serif" font-size="11.00">(1000,1)</text>
</g>
<!-- E10 -->
<g id="node2" class="node">
<title>E10</title>
<path fill="white" stroke="black" d="M920.21,-52C920.21,-52 840.12,-52 840.12,-52 834.12,-52 828.12,-46 828.12,-40 828.12,-40 828.12,-28 828.12,-28 828.12,-22 834.12,-16 840.12,-16 840.12,-16 920.21,-16 920.21,-16 926.21,-16 932.21,-22 932.21,-28 932.21,-28 932.21,-40 932.21,-40 932.21,-46 926.21,-52 920.21,-52"></path>
<text text-anchor="middle" x="880.16" y="-37.3" font-family="Helvetica,sans-Serif" font-size="11.00">E10 Recv Receipt</text>
<text text-anchor="middle" x="880.16" y="-24.1" font-family="Helvetica,sans-Serif" font-size="11.00">(1002,2)</text>
</g>
<!-- E1&#45;&gt;E10 -->
<g id="edge1" class="edge">
<title>E1-&gt;E10</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M740.04,-34C763.93,-34 792.69,-34 817.85,-34"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="818.02,-37.5 828.02,-34 818.02,-30.5 818.02,-37.5"></polygon>
</g>
<!-- E2 -->
<g id="node3" class="node">
<title>E2</title>
<path fill="white" stroke="black" d="M105.38,-134C105.38,-134 28.21,-134 28.21,-134 22.21,-134 16.21,-128 16.21,-122 16.21,-122 16.21,-110 16.21,-110 16.21,-104 22.21,-98 28.21,-98 28.21,-98 105.38,-98 105.38,-98 111.38,-98 117.38,-104 117.38,-110 117.38,-110 117.38,-122 117.38,-122 117.38,-128 111.38,-134 105.38,-134"></path>
<text text-anchor="middle" x="66.79" y="-119.3" font-family="Helvetica,sans-Serif" font-size="11.00">E2 Recv Transfer</text>
<text text-anchor="middle" x="66.79" y="-106.1" font-family="Helvetica,sans-Serif" font-size="11.00">(1000,2)</text>
</g>
<!-- E1&#45;&gt;E2 -->
<g id="edge8" class="edge">
<title>E1-&gt;E2</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M637.57,-40.63C605.92,-44.25 564.16,-48 527.05,-48 196.13,-48 196.13,-48 196.13,-48 157.84,-48 119.83,-71.92 95.23,-91.39"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="92.94,-88.74 87.42,-97.78 97.37,-94.15 92.94,-88.74"></polygon>
<text text-anchor="middle" x="333.28" y="-52.2" font-family="Times,serif" font-size="14.00">Transfer</text>
</g>
<!-- E3 -->
<g id="node4" class="node">
<title>E3</title>
<path fill="white" stroke="black" d="M227.72,-134C227.72,-134 166.54,-134 166.54,-134 160.54,-134 154.54,-128 154.54,-122 154.54,-122 154.54,-110 154.54,-110 154.54,-104 160.54,-98 166.54,-98 166.54,-98 227.72,-98 227.72,-98 233.72,-98 239.72,-104 239.72,-110 239.72,-110 239.72,-122 239.72,-122 239.72,-128 233.72,-134 227.72,-134"></path>
<text text-anchor="middle" x="197.13" y="-119.3" font-family="Helvetica,sans-Serif" font-size="11.00">E3 Debit Alice</text>
<text text-anchor="middle" x="197.13" y="-106.1" font-family="Helvetica,sans-Serif" font-size="11.00">(1000,3)</text>
</g>
<!-- E2&#45;&gt;E3 -->
<g id="edge2" class="edge">
<title>E2-&gt;E3</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M117.41,-116C126.23,-116 135.44,-116 144.32,-116"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="144.55,-119.5 154.55,-116 144.55,-112.5 144.55,-119.5"></polygon>
</g>
<!-- E4 -->
<g id="node5" class="node">
<title>E4</title>
<path fill="white" stroke="black" d="M378,-134C378,-134 288.56,-134 288.56,-134 282.56,-134 276.56,-128 276.56,-122 276.56,-122 276.56,-110 276.56,-110 276.56,-104 282.56,-98 288.56,-98 288.56,-98 378,-98 378,-98 384,-98 390,-104 390,-110 390,-110 390,-122 390,-122 390,-128 384,-134 378,-134"></path>
<text text-anchor="middle" x="333.28" y="-119.3" font-family="Helvetica,sans-Serif" font-size="11.00">E4 Send Credit→P2</text>
<text text-anchor="middle" x="333.28" y="-106.1" font-family="Helvetica,sans-Serif" font-size="11.00">(1000,4)</text>
</g>
<!-- E3&#45;&gt;E4 -->
<g id="edge3" class="edge">
<title>E3-&gt;E4</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M239.84,-116C248.22,-116 257.22,-116 266.2,-116"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="266.3,-119.5 276.3,-116 266.3,-112.5 266.3,-119.5"></polygon>
</g>
<!-- E8 -->
<g id="node6" class="node">
<title>E8</title>
<path fill="white" stroke="black" d="M579.36,-134C579.36,-134 472.73,-134 472.73,-134 466.73,-134 460.73,-128 460.73,-122 460.73,-122 460.73,-110 460.73,-110 460.73,-104 466.73,-98 472.73,-98 472.73,-98 579.36,-98 579.36,-98 585.36,-98 591.36,-104 591.36,-110 591.36,-110 591.36,-122 591.36,-122 591.36,-128 585.36,-134 579.36,-134"></path>
<text text-anchor="middle" x="526.05" y="-119.3" font-family="Helvetica,sans-Serif" font-size="11.00">E8 Recv Ack &amp; Finalize</text>
<text text-anchor="middle" x="526.05" y="-106.1" font-family="Helvetica,sans-Serif" font-size="11.00">(1001,5)</text>
</g>
<!-- E4&#45;&gt;E8 -->
<g id="edge4" class="edge">
<title>E4-&gt;E8</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M389.97,-116C408.88,-116 430.33,-116 450.47,-116"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="450.55,-119.5 460.55,-116 450.55,-112.5 450.55,-119.5"></polygon>
</g>
<!-- E5 -->
<g id="node8" class="node">
<title>E5</title>
<path fill="white" stroke="black" d="M559.02,-241C559.02,-241 493.08,-241 493.08,-241 487.08,-241 481.08,-235 481.08,-229 481.08,-229 481.08,-217 481.08,-217 481.08,-211 487.08,-205 493.08,-205 493.08,-205 559.02,-205 559.02,-205 565.02,-205 571.02,-211 571.02,-217 571.02,-217 571.02,-229 571.02,-229 571.02,-235 565.02,-241 559.02,-241"></path>
<text text-anchor="middle" x="526.05" y="-226.3" font-family="Helvetica,sans-Serif" font-size="11.00">E5 Recv Credit</text>
<text text-anchor="middle" x="526.05" y="-213.1" font-family="Helvetica,sans-Serif" font-size="11.00">(1000,5)</text>
</g>
<!-- E4&#45;&gt;E5 -->
<g id="edge9" class="edge">
<title>E4-&gt;E5</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M366.64,-134.15C398.94,-152.27 448.69,-180.17 483.81,-199.87"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="482.41,-203.1 492.85,-204.94 485.84,-196.99 482.41,-203.1"></polygon>
<text text-anchor="middle" x="425.39" y="-179.2" font-family="Times,serif" font-size="14.00">Credit</text>
</g>
<!-- E9 -->
<g id="node7" class="node">
<title>E9</title>
<path fill="white" stroke="black" d="M737.47,-134C737.47,-134 640.12,-134 640.12,-134 634.12,-134 628.12,-128 628.12,-122 628.12,-122 628.12,-110 628.12,-110 628.12,-104 634.12,-98 640.12,-98 640.12,-98 737.47,-98 737.47,-98 743.47,-98 749.47,-104 749.47,-110 749.47,-110 749.47,-122 749.47,-122 749.47,-128 743.47,-134 737.47,-134"></path>
<text text-anchor="middle" x="688.79" y="-119.3" font-family="Helvetica,sans-Serif" font-size="11.00">E9 Send Receipt→P0</text>
<text text-anchor="middle" x="688.79" y="-106.1" font-family="Helvetica,sans-Serif" font-size="11.00">(1001,6)</text>
</g>
<!-- E8&#45;&gt;E9 -->
<g id="edge5" class="edge">
<title>E8-&gt;E9</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M591.5,-116C600.17,-116 609.09,-116 617.84,-116"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="618.01,-119.5 628.01,-116 618.01,-112.5 618.01,-119.5"></polygon>
</g>
<!-- E9&#45;&gt;E10 -->
<g id="edge11" class="edge">
<title>E9-&gt;E10</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M731.82,-97.8C760.24,-85.5 797.93,-69.18 828.08,-56.12"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="829.79,-59.19 837.58,-52.01 827.01,-52.77 829.79,-59.19"></polygon>
<text text-anchor="middle" x="788.76" y="-86.2" font-family="Times,serif" font-size="14.00">Receipt</text>
</g>
<!-- E6 -->
<g id="node9" class="node">
<title>E6</title>
<path fill="white" stroke="black" d="M723.32,-241C723.32,-241 654.27,-241 654.27,-241 648.27,-241 642.27,-235 642.27,-229 642.27,-229 642.27,-217 642.27,-217 642.27,-211 648.27,-205 654.27,-205 654.27,-205 723.32,-205 723.32,-205 729.32,-205 735.32,-211 735.32,-217 735.32,-217 735.32,-229 735.32,-229 735.32,-235 729.32,-241 723.32,-241"></path>
<text text-anchor="middle" x="688.79" y="-226.3" font-family="Helvetica,sans-Serif" font-size="11.00">E6 Commit Bob</text>
<text text-anchor="middle" x="688.79" y="-213.1" font-family="Helvetica,sans-Serif" font-size="11.00">(1000,6)</text>
</g>
<!-- E5&#45;&gt;E6 -->
<g id="edge6" class="edge">
<title>E5-&gt;E6</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M571.4,-223C590.15,-223 612.21,-223 632.05,-223"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="632.19,-226.5 642.19,-223 632.19,-219.5 632.19,-226.5"></polygon>
</g>
<!-- E7 -->
<g id="node10" class="node">
<title>E7</title>
<path fill="white" stroke="black" d="M919.38,-241C919.38,-241 840.95,-241 840.95,-241 834.95,-241 828.95,-235 828.95,-229 828.95,-229 828.95,-217 828.95,-217 828.95,-211 834.95,-205 840.95,-205 840.95,-205 919.38,-205 919.38,-205 925.38,-205 931.38,-211 931.38,-217 931.38,-217 931.38,-229 931.38,-229 931.38,-235 925.38,-241 919.38,-241"></path>
<text text-anchor="middle" x="880.16" y="-226.3" font-family="Helvetica,sans-Serif" font-size="11.00">E7 Send Ack→P1</text>
<text text-anchor="middle" x="880.16" y="-213.1" font-family="Helvetica,sans-Serif" font-size="11.00">(1000,7)</text>
</g>
<!-- E6&#45;&gt;E7 -->
<g id="edge7" class="edge">
<title>E6-&gt;E7</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M735.63,-223C760.58,-223 791.75,-223 818.67,-223"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="818.75,-226.5 828.75,-223 818.75,-219.5 818.75,-226.5"></polygon>
</g>
<!-- E7&#45;&gt;E8 -->
<g id="edge10" class="edge">
<title>E7-&gt;E8</title>
<path fill="none" stroke="#1f78b4" stroke-width="2" d="M831.74,-204.98C809.33,-196.71 782.12,-187.03 757.38,-179.2 742.21,-174.4 662.38,-152.62 600.91,-135.96"></path>
<polygon fill="#1f78b4" stroke="#1f78b4" stroke-width="2" points="601.79,-132.57 591.22,-133.33 599.96,-139.33 601.79,-132.57"></polygon>
<text text-anchor="middle" x="688.79" y="-183.2" font-family="Times,serif" font-size="14.00">Ack</text>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="工业方案对比" class="slide level2 smaller">
<h2>工业方案对比</h2>
<ul>
<li>CockroachDB：<code>txn_timestamp()</code> / <code>hlc_to_timestamp()</code></li>
<li>TiDB/Percolator 由 Placement Driver（PD）负责全局时间戳（TS）分配</li>
</ul>
<table class="caption-top">
<thead>
<tr class="header">
<th>特性</th>
<th>CockroachDB</th>
<th>TiDB（PD/TSO）</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>授时机制</td>
<td><strong>HLC</strong>（分布式）</td>
<td><strong>TSO</strong>（中心化分配）</td>
</tr>
<tr class="even">
<td>顺序保证</td>
<td>偏序 + 物理可读</td>
<td>严格单调递增</td>
</tr>
<tr class="odd">
<td>扩展性</td>
<td>水平扩展佳</td>
<td>受 TSO 扩展/冗余设计影响</td>
</tr>
<tr class="even">
<td>工程复杂度</td>
<td>较高</td>
<td>相对较低，贴近 Percolator</td>
</tr>
</tbody>
</table>
<blockquote>
<p>延伸阅读：<a href="https://www.usenix.org/legacy/event/osdi10/tech/full_papers/Peng.pdf">Peng &amp; Dabek 2010（Percolator）</a>；<a href="https://learning.oreilly.com/library/view/designing-data-intensive-applications/9781491903063/">Kleppmann 2017（DDIA）</a></p>
</blockquote>
</section></section>
<section>
<section id="日志" class="title-slide slide level1 center">
<h1>日志</h1>

</section>
<section id="错误的直觉同步状态" class="slide level2">
<h2>错误的直觉：同步状态</h2>
<p><strong>如何在多台机器间保持数据一致？</strong></p>
<p>传统的思路是尝试同步状态：</p>
<pre><code>A的余额 = 1000  → 同步 → B的余额 = 1000</code></pre>
<ul>
<li>需要“瞬时”完成；网络与并发让“同时”成为幻觉</li>
<li>如果半途失败（A 成功 / B 失败），永久不一致</li>
<li>如果并发写入（转账+退款）顺序不一致，读到不同状态</li>
</ul>
</section>
<section id="正确的方法同步可重放的操作" class="slide level2">
<h2>正确的方法：同步“可重放的操作”</h2>
<pre><code>在A上写日志：  [T1: 扣款500]
复制日志到B：  [T1: 扣款500]
B按顺序重放：余额 ← 余额 - 500</code></pre>
<ul>
<li><strong>日志（WAL/Replication Log）</strong>只追加、有序、可重放</li>
<li>复制“<strong>因果与顺序</strong>”，而不是复制易变的“结果状态”</li>
<li>崩溃后“<strong>重放日志</strong>”恢复到崩溃前的确定状态</li>
</ul>
</section>
<section id="对比状态同步-vs-操作同步" class="slide level2">
<h2>对比：状态同步 vs 操作同步</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class=""><p></p>
<div>
<svg aria-roledescription="sequence" role="graphics-document document" viewbox="-50 -10 685 896" style="; display: block; margin: auto auto auto auto" xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="960" id="mermaid-figure-2" height="480">
<rect class="rect" height="419" width="501" fill="rgba(235,255,235,0.5)" y="371" x="64"></rect><rect class="rect" height="286" width="521" fill="rgba(255,235,235,0.5)" y="75" x="64"></rect><g><rect class="actor actor-bottom" ry="3" rx="3" name="B" height="65" width="150" stroke="#666" fill="#eaeaea" y="810" x="404"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="842.5" x="479"><tspan dy="0" x="479">节点B（从）</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="A" height="65" width="150" stroke="#666" fill="#eaeaea" y="810" x="200"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="842.5" x="275"><tspan dy="0" x="275">节点A（主）</tspan></text></g><g><rect class="actor actor-bottom" ry="3" rx="3" name="Client" height="65" width="150" stroke="#666" fill="#eaeaea" y="810" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="842.5" x="75"><tspan dy="0" x="75">客户</tspan></text></g><g><line name="B" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="810" x2="479" y1="5" x1="479" id="actor2"></line><g id="root-2"><rect class="actor actor-top" ry="3" rx="3" name="B" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="404"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="479"><tspan dy="0" x="479">节点B（从）</tspan></text></g></g><g><line name="A" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="810" x2="275" y1="5" x1="275" id="actor1"></line><g id="root-1"><rect class="actor actor-top" ry="3" rx="3" name="A" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="200"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="275"><tspan dy="0" x="275">节点A（主）</tspan></text></g></g><g><line name="Client" stroke="#999" stroke-width="0.5px" class="actor-line 200" y2="810" x2="75" y1="5" x1="75" id="actor0"></line><g id="root-0"><rect class="actor actor-top" ry="3" rx="3" name="Client" height="65" width="150" stroke="#666" fill="#eaeaea" y="0" x="0"></rect><text style="text-anchor: middle; font-size: 16px; font-weight: 400;" class="actor actor-box" alignment-baseline="central" dominant-baseline="central" y="32.5" x="75"><tspan dy="0" x="75">客户</tspan></text></g></g>
<style>#mermaid-figure-2{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-figure-2 .error-icon{fill:#552222;}#mermaid-figure-2 .error-text{fill:#552222;stroke:#552222;}#mermaid-figure-2 .edge-thickness-normal{stroke-width:1px;}#mermaid-figure-2 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-figure-2 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-figure-2 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-figure-2 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-figure-2 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-figure-2 .marker{fill:#333333;stroke:#333333;}#mermaid-figure-2 .marker.cross{stroke:#333333;}#mermaid-figure-2 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-figure-2 p{margin:0;}#mermaid-figure-2 .actor{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-2 text.actor>tspan{fill:black;stroke:none;}#mermaid-figure-2 .actor-line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-2 .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaid-figure-2 .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaid-figure-2 #mermaid-figure-2-arrowhead path{fill:#333;stroke:#333;}#mermaid-figure-2 .sequenceNumber{fill:white;}#mermaid-figure-2 #mermaid-figure-2-sequencenumber{fill:#333;}#mermaid-figure-2 #mermaid-figure-2-crosshead path{fill:#333;stroke:#333;}#mermaid-figure-2 .messageText{fill:#333;stroke:none;}#mermaid-figure-2 .labelBox{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-2 .labelText,#mermaid-figure-2 .labelText>tspan{fill:black;stroke:none;}#mermaid-figure-2 .loopText,#mermaid-figure-2 .loopText>tspan{fill:black;stroke:none;}#mermaid-figure-2 .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);}#mermaid-figure-2 .note{stroke:#aaaa33;fill:#fff5ad;}#mermaid-figure-2 .noteText,#mermaid-figure-2 .noteText>tspan{fill:black;stroke:none;}#mermaid-figure-2 .activation0{fill:#f4f4f4;stroke:#666;}#mermaid-figure-2 .activation1{fill:#f4f4f4;stroke:#666;}#mermaid-figure-2 .activation2{fill:#f4f4f4;stroke:#666;}#mermaid-figure-2 .actorPopupMenu{position:absolute;}#mermaid-figure-2 .actorPopupMenuPanel{position:absolute;fill:#ECECFF;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);filter:drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4));}#mermaid-figure-2 .actor-man line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;}#mermaid-figure-2 .actor-man circle,#mermaid-figure-2 line{stroke:hsl(259.6261682243, 59.7765363128%, 87.9019607843%);fill:#ECECFF;stroke-width:2px;}#mermaid-figure-2 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style>
<g></g><defs><symbol height="24" width="24" id="mermaid-figure-2-computer"><path d="M2 2v13h20v-13h-20zm18 11h-16v-9h16v9zm-10.228 6l.466-1h3.524l.467 1h-4.457zm14.228 3h-24l2-6h2.104l-1.33 4h18.45l-1.297-4h2.073l2 6zm-5-10h-14v-7h14v7z" transform="scale(.5)"></path></symbol></defs><defs><symbol clip-rule="evenodd" fill-rule="evenodd" id="mermaid-figure-2-database"><path d="M12.258.001l.256.004.255.005.253.008.251.01.249.012.247.015.246.016.242.019.241.02.239.023.236.024.233.027.231.028.229.031.225.032.223.034.22.036.217.038.214.04.211.041.208.043.205.045.201.046.198.048.194.05.191.051.187.053.183.054.18.056.175.057.172.059.168.06.163.061.16.063.155.064.15.066.074.033.073.033.071.034.07.034.069.035.068.035.067.035.066.035.064.036.064.036.062.036.06.036.06.037.058.037.058.037.055.038.055.038.053.038.052.038.051.039.05.039.048.039.047.039.045.04.044.04.043.04.041.04.04.041.039.041.037.041.036.041.034.041.033.042.032.042.03.042.029.042.027.042.026.043.024.043.023.043.021.043.02.043.018.044.017.043.015.044.013.044.012.044.011.045.009.044.007.045.006.045.004.045.002.045.001.045v17l-.001.045-.002.045-.004.045-.006.045-.007.045-.009.044-.011.045-.012.044-.013.044-.015.044-.017.043-.018.044-.02.043-.021.043-.023.043-.024.043-.026.043-.027.042-.029.042-.03.042-.032.042-.033.042-.034.041-.036.041-.037.041-.039.041-.04.041-.041.04-.043.04-.044.04-.045.04-.047.039-.048.039-.05.039-.051.039-.052.038-.053.038-.055.038-.055.038-.058.037-.058.037-.06.037-.06.036-.062.036-.064.036-.064.036-.066.035-.067.035-.068.035-.069.035-.07.034-.071.034-.073.033-.074.033-.15.066-.155.064-.16.063-.163.061-.168.06-.172.059-.175.057-.18.056-.183.054-.187.053-.191.051-.194.05-.198.048-.201.046-.205.045-.208.043-.211.041-.214.04-.217.038-.22.036-.223.034-.225.032-.229.031-.231.028-.233.027-.236.024-.239.023-.241.02-.242.019-.246.016-.247.015-.249.012-.251.01-.253.008-.255.005-.256.004-.258.001-.258-.001-.256-.004-.255-.005-.253-.008-.251-.01-.249-.012-.247-.015-.245-.016-.243-.019-.241-.02-.238-.023-.236-.024-.234-.027-.231-.028-.228-.031-.226-.032-.223-.034-.22-.036-.217-.038-.214-.04-.211-.041-.208-.043-.204-.045-.201-.046-.198-.048-.195-.05-.19-.051-.187-.053-.184-.054-.179-.056-.176-.057-.172-.059-.167-.06-.164-.061-.159-.063-.155-.064-.151-.066-.074-.033-.072-.033-.072-.034-.07-.034-.069-.035-.068-.035-.067-.035-.066-.035-.064-.036-.063-.036-.062-.036-.061-.036-.06-.037-.058-.037-.057-.037-.056-.038-.055-.038-.053-.038-.052-.038-.051-.039-.049-.039-.049-.039-.046-.039-.046-.04-.044-.04-.043-.04-.041-.04-.04-.041-.039-.041-.037-.041-.036-.041-.034-.041-.033-.042-.032-.042-.03-.042-.029-.042-.027-.042-.026-.043-.024-.043-.023-.043-.021-.043-.02-.043-.018-.044-.017-.043-.015-.044-.013-.044-.012-.044-.011-.045-.009-.044-.007-.045-.006-.045-.004-.045-.002-.045-.001-.045v-17l.001-.045.002-.045.004-.045.006-.045.007-.045.009-.044.011-.045.012-.044.013-.044.015-.044.017-.043.018-.044.02-.043.021-.043.023-.043.024-.043.026-.043.027-.042.029-.042.03-.042.032-.042.033-.042.034-.041.036-.041.037-.041.039-.041.04-.041.041-.04.043-.04.044-.04.046-.04.046-.039.049-.039.049-.039.051-.039.052-.038.053-.038.055-.038.056-.038.057-.037.058-.037.06-.037.061-.036.062-.036.063-.036.064-.036.066-.035.067-.035.068-.035.069-.035.07-.034.072-.034.072-.033.074-.033.151-.066.155-.064.159-.063.164-.061.167-.06.172-.059.176-.057.179-.056.184-.054.187-.053.19-.051.195-.05.198-.048.201-.046.204-.045.208-.043.211-.041.214-.04.217-.038.22-.036.223-.034.226-.032.228-.031.231-.028.234-.027.236-.024.238-.023.241-.02.243-.019.245-.016.247-.015.249-.012.251-.01.253-.008.255-.005.256-.004.258-.001.258.001zm-9.258 20.499v.01l.001.021.003.021.004.022.005.021.006.022.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.023.018.024.019.024.021.024.022.025.023.024.024.025.052.049.056.05.061.051.066.051.07.051.075.051.079.052.084.052.088.052.092.052.097.052.102.051.105.052.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.048.144.049.147.047.152.047.155.047.16.045.163.045.167.043.171.043.176.041.178.041.183.039.187.039.19.037.194.035.197.035.202.033.204.031.209.03.212.029.216.027.219.025.222.024.226.021.23.02.233.018.236.016.24.015.243.012.246.01.249.008.253.005.256.004.259.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.021.224-.024.22-.026.216-.027.212-.028.21-.031.205-.031.202-.034.198-.034.194-.036.191-.037.187-.039.183-.04.179-.04.175-.042.172-.043.168-.044.163-.045.16-.046.155-.046.152-.047.148-.048.143-.049.139-.049.136-.05.131-.05.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.053.083-.051.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.05.023-.024.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.023.01-.022.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.127l-.077.055-.08.053-.083.054-.085.053-.087.052-.09.052-.093.051-.095.05-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.045-.118.044-.12.043-.122.042-.124.042-.126.041-.128.04-.13.04-.132.038-.134.038-.135.037-.138.037-.139.035-.142.035-.143.034-.144.033-.147.032-.148.031-.15.03-.151.03-.153.029-.154.027-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.01-.179.008-.179.008-.181.006-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.006-.179-.008-.179-.008-.178-.01-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.027-.153-.029-.151-.03-.15-.03-.148-.031-.146-.032-.145-.033-.143-.034-.141-.035-.14-.035-.137-.037-.136-.037-.134-.038-.132-.038-.13-.04-.128-.04-.126-.041-.124-.042-.122-.042-.12-.044-.117-.043-.116-.045-.113-.045-.112-.046-.109-.047-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.05-.093-.052-.09-.051-.087-.052-.085-.053-.083-.054-.08-.054-.077-.054v4.127zm0-5.654v.011l.001.021.003.021.004.021.005.022.006.022.007.022.009.022.01.022.011.023.012.023.013.023.015.024.016.023.017.024.018.024.019.024.021.024.022.024.023.025.024.024.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.052.11.051.114.051.119.052.123.05.127.051.131.05.135.049.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.044.171.042.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.022.23.02.233.018.236.016.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.012.241-.015.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.048.139-.05.136-.049.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.051.051-.049.023-.025.023-.024.021-.025.02-.024.019-.024.018-.024.017-.024.015-.023.014-.023.013-.024.012-.022.01-.023.01-.023.008-.022.006-.022.006-.022.004-.021.004-.022.001-.021.001-.021v-4.139l-.077.054-.08.054-.083.054-.085.052-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.049-.105.048-.106.047-.109.047-.111.046-.114.045-.115.044-.118.044-.12.044-.122.042-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.035-.143.033-.144.033-.147.033-.148.031-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.025-.161.024-.162.023-.163.022-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.011-.178.009-.179.009-.179.007-.181.007-.182.005-.182.004-.184.003-.184.002h-.37l-.184-.002-.184-.003-.182-.004-.182-.005-.181-.007-.179-.007-.179-.009-.178-.009-.176-.011-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.022-.162-.023-.161-.024-.159-.025-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.031-.146-.033-.145-.033-.143-.033-.141-.035-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.04-.126-.041-.124-.042-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.047-.105-.048-.102-.049-.1-.049-.097-.05-.095-.051-.093-.051-.09-.051-.087-.053-.085-.052-.083-.054-.08-.054-.077-.054v4.139zm0-5.666v.011l.001.02.003.022.004.021.005.022.006.021.007.022.009.023.01.022.011.023.012.023.013.023.015.023.016.024.017.024.018.023.019.024.021.025.022.024.023.024.024.025.052.05.056.05.061.05.066.051.07.051.075.052.079.051.084.052.088.052.092.052.097.052.102.052.105.051.11.052.114.051.119.051.123.051.127.05.131.05.135.05.139.049.144.048.147.048.152.047.155.046.16.045.163.045.167.043.171.043.176.042.178.04.183.04.187.038.19.037.194.036.197.034.202.033.204.032.209.03.212.028.216.027.219.025.222.024.226.021.23.02.233.018.236.017.24.014.243.012.246.01.249.008.253.006.256.003.259.001.26-.001.257-.003.254-.006.25-.008.247-.01.244-.013.241-.014.237-.016.233-.018.231-.02.226-.022.224-.024.22-.025.216-.027.212-.029.21-.03.205-.032.202-.033.198-.035.194-.036.191-.037.187-.039.183-.039.179-.041.175-.042.172-.043.168-.044.163-.045.16-.045.155-.047.152-.047.148-.048.143-.049.139-.049.136-.049.131-.051.126-.05.123-.051.118-.052.114-.051.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.052.07-.051.065-.051.06-.051.056-.05.051-.049.023-.025.023-.025.021-.024.02-.024.019-.024.018-.024.017-.024.015-.023.014-.024.013-.023.012-.023.01-.022.01-.023.008-.022.006-.022.006-.022.004-.022.004-.021.001-.021.001-.021v-4.153l-.077.054-.08.054-.083.053-.085.053-.087.053-.09.051-.093.051-.095.051-.097.05-.1.049-.102.048-.105.048-.106.048-.109.046-.111.046-.114.046-.115.044-.118.044-.12.043-.122.043-.124.042-.126.041-.128.04-.13.039-.132.039-.134.038-.135.037-.138.036-.139.036-.142.034-.143.034-.144.033-.147.032-.148.032-.15.03-.151.03-.153.028-.154.028-.156.027-.158.026-.159.024-.161.024-.162.023-.163.023-.165.021-.166.02-.167.019-.169.018-.169.017-.171.016-.173.015-.173.014-.175.013-.175.012-.177.01-.178.01-.179.009-.179.007-.181.006-.182.006-.182.004-.184.003-.184.001-.185.001-.185-.001-.184-.001-.184-.003-.182-.004-.182-.006-.181-.006-.179-.007-.179-.009-.178-.01-.176-.01-.176-.012-.175-.013-.173-.014-.172-.015-.171-.016-.17-.017-.169-.018-.167-.019-.166-.02-.165-.021-.163-.023-.162-.023-.161-.024-.159-.024-.157-.026-.156-.027-.155-.028-.153-.028-.151-.03-.15-.03-.148-.032-.146-.032-.145-.033-.143-.034-.141-.034-.14-.036-.137-.036-.136-.037-.134-.038-.132-.039-.13-.039-.128-.041-.126-.041-.124-.041-.122-.043-.12-.043-.117-.044-.116-.044-.113-.046-.112-.046-.109-.046-.106-.048-.105-.048-.102-.048-.1-.05-.097-.049-.095-.051-.093-.051-.09-.052-.087-.052-.085-.053-.083-.053-.08-.054-.077-.054v4.153zm8.74-8.179l-.257.004-.254.005-.25.008-.247.011-.244.012-.241.014-.237.016-.233.018-.231.021-.226.022-.224.023-.22.026-.216.027-.212.028-.21.031-.205.032-.202.033-.198.034-.194.036-.191.038-.187.038-.183.04-.179.041-.175.042-.172.043-.168.043-.163.045-.16.046-.155.046-.152.048-.148.048-.143.048-.139.049-.136.05-.131.05-.126.051-.123.051-.118.051-.114.052-.11.052-.106.052-.101.052-.096.052-.092.052-.088.052-.083.052-.079.052-.074.051-.07.052-.065.051-.06.05-.056.05-.051.05-.023.025-.023.024-.021.024-.02.025-.019.024-.018.024-.017.023-.015.024-.014.023-.013.023-.012.023-.01.023-.01.022-.008.022-.006.023-.006.021-.004.022-.004.021-.001.021-.001.021.001.021.001.021.004.021.004.022.006.021.006.023.008.022.01.022.01.023.012.023.013.023.014.023.015.024.017.023.018.024.019.024.02.025.021.024.023.024.023.025.051.05.056.05.06.05.065.051.07.052.074.051.079.052.083.052.088.052.092.052.096.052.101.052.106.052.11.052.114.052.118.051.123.051.126.051.131.05.136.05.139.049.143.048.148.048.152.048.155.046.16.046.163.045.168.043.172.043.175.042.179.041.183.04.187.038.191.038.194.036.198.034.202.033.205.032.21.031.212.028.216.027.22.026.224.023.226.022.231.021.233.018.237.016.241.014.244.012.247.011.25.008.254.005.257.004.26.001.26-.001.257-.004.254-.005.25-.008.247-.011.244-.012.241-.014.237-.016.233-.018.231-.021.226-.022.224-.023.22-.026.216-.027.212-.028.21-.031.205-.032.202-.033.198-.034.194-.036.191-.038.187-.038.183-.04.179-.041.175-.042.172-.043.168-.043.163-.045.16-.046.155-.046.152-.048.148-.048.143-.048.139-.049.136-.05.131-.05.126-.051.123-.051.118-.051.114-.052.11-.052.106-.052.101-.052.096-.052.092-.052.088-.052.083-.052.079-.052.074-.051.07-.052.065-.051.06-.05.056-.05.051-.05.023-.025.023-.024.021-.024.02-.025.019-.024.018-.024.017-.023.015-.024.014-.023.013-.023.012-.023.01-.023.01-.022.008-.022.006-.023.006-.021.004-.022.004-.021.001-.021.001-.021-.001-.021-.001-.021-.004-.021-.004-.022-.006-.021-.006-.023-.008-.022-.01-.022-.01-.023-.012-.023-.013-.023-.014-.023-.015-.024-.017-.023-.018-.024-.019-.024-.02-.025-.021-.024-.023-.024-.023-.025-.051-.05-.056-.05-.06-.05-.065-.051-.07-.052-.074-.051-.079-.052-.083-.052-.088-.052-.092-.052-.096-.052-.101-.052-.106-.052-.11-.052-.114-.052-.118-.051-.123-.051-.126-.051-.131-.05-.136-.05-.139-.049-.143-.048-.148-.048-.152-.048-.155-.046-.16-.046-.163-.045-.168-.043-.172-.043-.175-.042-.179-.041-.183-.04-.187-.038-.191-.038-.194-.036-.198-.034-.202-.033-.205-.032-.21-.031-.212-.028-.216-.027-.22-.026-.224-.023-.226-.022-.231-.021-.233-.018-.237-.016-.241-.014-.244-.012-.247-.011-.25-.008-.254-.005-.257-.004-.26-.001-.26.001z" transform="scale(.5)"></path></symbol></defs><defs><symbol height="24" width="24" id="mermaid-figure-2-clock"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.848 12.459c.202.038.202.333.001.372-1.907.361-6.045 1.111-6.547 1.111-.719 0-1.301-.582-1.301-1.301 0-.512.77-5.447 1.125-7.445.034-.192.312-.181.343.014l.985 6.238 5.394 1.011z" transform="scale(.5)"></path></symbol></defs><defs><marker orient="auto-start-reverse" markerheight="12" markerwidth="12" markerunits="userSpaceOnUse" refy="5" refx="7.9" id="mermaid-figure-2-arrowhead"><path d="M -1 0 L 10 5 L 0 10 z"></path></marker></defs><defs><marker refy="4.5" refx="4" orient="auto" markerheight="8" markerwidth="15" id="mermaid-figure-2-crosshead"><path style="stroke-dasharray: 0, 0;" d="M 1,2 L 6,7 M 6,2 L 1,7" stroke-width="1pt" stroke="#000000" fill="none"></path></marker></defs><defs><marker orient="auto" markerheight="28" markerwidth="20" refy="7" refx="15.5" id="mermaid-figure-2-filled-head"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerheight="40" markerwidth="60" refy="15" refx="15" id="mermaid-figure-2-sequencenumber"><circle r="6" cy="15" cx="15"></circle></marker></defs><g><rect class="note" height="39" width="254" stroke="#666" fill="#EDF2AE" y="95" x="250"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="100" x="377"><tspan x="377">同步状态（脆弱）</tspan></text></g><g><rect class="note" height="39" width="192" stroke="#666" fill="#EDF2AE" y="312" x="383"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="317" x="479"><tspan x="479">网络延迟/故障 → 未生效</tspan></text></g><g><rect class="note" height="39" width="254" stroke="#666" fill="#EDF2AE" y="391" x="250"></rect><text style="font-size: 16px; font-weight: 400;" dy="1em" class="noteText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="396" x="377"><tspan x="377">同步操作（日志）</tspan></text></g><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="149" x="174">扣款500</text><line style="fill: none;" marker-start="url(#mermaid-figure-2-sequencenumber)" marker-end="url(#mermaid-figure-2-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="180" x2="271" y1="180" x1="76"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="184" x="76">1</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="195" x="276">直接改状态（余额-500）</text><path style="fill: none;" marker-start="url(#mermaid-figure-2-sequencenumber)" marker-end="url(#mermaid-figure-2-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 276,226 C 336,216 336,256 276,246"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="230" x="276">2</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="271" x="376">同步“状态=500”</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-2-sequencenumber)" marker-end="url(#mermaid-figure-2-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="302" x2="475" y1="302" x1="276"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="306" x="276">3</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="445" x="174">扣款500</text><line style="fill: none;" marker-start="url(#mermaid-figure-2-sequencenumber)" marker-end="url(#mermaid-figure-2-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" y2="476" x2="271" y1="476" x1="76"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="480" x="76">4</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="491" x="276">先写 WAL: [T1: -500]</text><path style="fill: none;" marker-start="url(#mermaid-figure-2-sequencenumber)" marker-end="url(#mermaid-figure-2-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 276,522 C 336,512 336,552 276,542"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="526" x="276">5</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="567" x="276">再改状态（余额-500）</text><path style="fill: none;" marker-start="url(#mermaid-figure-2-sequencenumber)" marker-end="url(#mermaid-figure-2-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 276,598 C 336,588 336,628 276,618"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="602" x="276">6</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="643" x="376">复制日志 [T1: -500]</text><line style="stroke-dasharray: 3, 3; fill: none;" marker-start="url(#mermaid-figure-2-sequencenumber)" marker-end="url(#mermaid-figure-2-arrowhead)" stroke="none" stroke-width="2" class="messageLine1" y2="674" x2="475" y1="674" x1="276"></line><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="678" x="276">7</text><text style="font-size: 16px; font-weight: 400;" dy="1em" class="messageText" alignment-baseline="middle" dominant-baseline="middle" text-anchor="middle" y="689" x="480">重放 [T1] → 余额-500</text><path style="fill: none;" marker-start="url(#mermaid-figure-2-sequencenumber)" marker-end="url(#mermaid-figure-2-arrowhead)" stroke="none" stroke-width="2" class="messageLine0" d="M 480,720 C 540,710 540,750 480,740"></path><text class="sequenceNumber" text-anchor="middle" font-size="12px" font-family="sans-serif" y="724" x="480">8</text>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="把时间观固化为可重放序列" class="slide level2">
<h2>把“时间观”固化为可重放序列</h2>
<p><strong>只追加、有序、可重放</strong>：</p>
<pre><code>[T1: 操作1] → [T2: 操作2] → [T3: 操作3] → ...</code></pre>
<ul>
<li><strong>WAL（Write-Ahead Log，预写日志）</strong>：先写日志，后改状态，崩溃后按序重放</li>
<li><strong>主从复制</strong>：用时间戳/偏序确保重放一致</li>
<li><strong>Apache Kafka</strong>分区内严格有序，全局以时间/偏序归并</li>
<li><strong>区块链</strong>本质上是全局共识的“时间链”</li>
</ul>
</section>
<section id="示例银行账户的日志重放" class="slide level2">
<h2>示例：银行账户的日志重放</h2>
<p>初始：余额=1000</p>
<pre><code>[T1] -500   ; 转账
[T2] +200   ; 退款
[T3] +300   ; 存款</code></pre>
<p>在任一副本，只要按 <strong>T1 → T2 → T3</strong> 重放，最终余额一致： 1000 - 500 + 200 + 300 = <strong>1000</strong></p>
</section>
<section id="典型写入路径" class="slide level2">
<h2>典型写入路径</h2>
<p>伪代码：</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href=""></a><span class="kw">def</span> process(op):</span>
<span id="cb9-2"><a href=""></a>    ts <span class="op">=</span> hlc.tick()             <span class="co"># 取时间戳/顺序凭据（HLC/逻辑时钟）</span></span>
<span id="cb9-3"><a href=""></a>    wal.append(op, ts)          <span class="co"># 先写日志，持久化</span></span>
<span id="cb9-4"><a href=""></a>    <span class="bu">apply</span>(op)                   <span class="co"># 再改内存/状态</span></span>
<span id="cb9-5"><a href=""></a>    replicate(op, ts)           <span class="co"># 复制给从节点</span></span>
<span id="cb9-6"><a href=""></a>    ack_when_safe()             <span class="co"># 按策略确认（本地/多数派/提交点）</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>注记</strong></p>
</div>
<div class="callout-content">
<p>保障<strong>崩溃不丢序、不乱序、可恢复</strong></p>
</div>
</div>
</div>
</section>
<section id="日志解决的问题" class="slide level2">
<h2>日志解决的问题</h2>
<ul>
<li><strong>顺序统一</strong>：跨节点用 Lamport/向量时钟/HLC 或共识，给操作建立可靠的顺序</li>
<li><strong>恢复与再现</strong>：WAL 先写日志再改状态；崩溃后按序重放</li>
<li><strong>复制与扩展</strong>：主从/Raft/Kafka 分区内严格有序；读副本按日志跟进</li>
<li><strong>幂等与去重</strong>：以请求ID+日志偏移管理重试，避免重复生效</li>
<li><strong>审计与回溯</strong>：随时重建“当时世界”，方便调试/审计/回滚</li>
</ul>
</section>
<section id="可观察性" class="slide level2">
<h2>可观察性</h2>
<blockquote>
<p>“Logs, metrics, and traces are often known as the three pillars of observability. While plainly having access to logs, metrics, and traces doesn’t necessarily make systems more observable, these are powerful tools that, if understood well, can unlock the ability to build better systems.”</p>
<p>—— Cindy Sridharan, <em>Distributed Systems Observability</em></p>
</blockquote>
</section>
<section id="实战演示分布式-rpc" class="slide level2">
<h2>实战演示：分布式 RPC</h2>
<ul>
<li>多节点并发发送请求，加入<strong>随机网络延迟/丢包</strong></li>
<li>以 <strong>HLC</strong> 记录消息时序</li>
<li>观察本地时间（<code>time.time()</code>/墙钟）排序与 HLC 排序的差异</li>
<li>结论：<strong>逻辑时间</strong>比本地时钟更稳定地反映“因果顺序”</li>
</ul>
<blockquote>
<p>课堂代码示例见课程仓库，可在本地运行观察排序差异。</p>
</blockquote>
</section>
<section id="演示代码" class="slide level2">
<h2>演示代码</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href=""></a><span class="im">import</span> time</span>
<span id="cb10-2"><a href=""></a><span class="im">import</span> random</span>
<span id="cb10-3"><a href=""></a><span class="im">import</span> threading</span>
<span id="cb10-4"><a href=""></a><span class="im">import</span> uuid</span>
<span id="cb10-5"><a href=""></a></span>
<span id="cb10-6"><a href=""></a></span>
<span id="cb10-7"><a href=""></a><span class="kw">class</span> HybridLogicalClock:</span>
<span id="cb10-8"><a href=""></a>    <span class="co">"""HLC = (pt, lc), pt=physical ms, lc=logical counter."""</span></span>
<span id="cb10-9"><a href=""></a></span>
<span id="cb10-10"><a href=""></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb10-11"><a href=""></a>        <span class="va">self</span>.pt <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb10-12"><a href=""></a>        <span class="va">self</span>.lc <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb10-13"><a href=""></a>        <span class="va">self</span>._lock <span class="op">=</span> threading.Lock()</span>
<span id="cb10-14"><a href=""></a></span>
<span id="cb10-15"><a href=""></a>    <span class="kw">def</span> _now_ms(<span class="va">self</span>):</span>
<span id="cb10-16"><a href=""></a>        <span class="cf">return</span> <span class="bu">int</span>(time.time() <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb10-17"><a href=""></a></span>
<span id="cb10-18"><a href=""></a>    <span class="kw">def</span> tick(<span class="va">self</span>):</span>
<span id="cb10-19"><a href=""></a>        <span class="co">"""Local event update, return (pt, lc)."""</span></span>
<span id="cb10-20"><a href=""></a>        <span class="cf">with</span> <span class="va">self</span>._lock:</span>
<span id="cb10-21"><a href=""></a>            now <span class="op">=</span> <span class="va">self</span>._now_ms()</span>
<span id="cb10-22"><a href=""></a>            <span class="va">self</span>.pt <span class="op">=</span> <span class="bu">max</span>(<span class="va">self</span>.pt, now)</span>
<span id="cb10-23"><a href=""></a>            <span class="cf">if</span> <span class="va">self</span>.pt <span class="op">==</span> now:</span>
<span id="cb10-24"><a href=""></a>                <span class="va">self</span>.lc <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb10-25"><a href=""></a>            <span class="cf">else</span>:</span>
<span id="cb10-26"><a href=""></a>                <span class="va">self</span>.lc <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb10-27"><a href=""></a>            <span class="cf">return</span> (<span class="va">self</span>.pt, <span class="va">self</span>.lc)</span>
<span id="cb10-28"><a href=""></a></span>
<span id="cb10-29"><a href=""></a>    <span class="kw">def</span> send(<span class="va">self</span>):</span>
<span id="cb10-30"><a href=""></a>        <span class="co">"""Call before attaching to outgoing message."""</span></span>
<span id="cb10-31"><a href=""></a>        <span class="cf">return</span> <span class="va">self</span>.tick()</span>
<span id="cb10-32"><a href=""></a></span>
<span id="cb10-33"><a href=""></a>    <span class="kw">def</span> recv(<span class="va">self</span>, msg_ts):</span>
<span id="cb10-34"><a href=""></a>        <span class="co">"""Merge incoming (pt, lc) and return updated (pt, lc)."""</span></span>
<span id="cb10-35"><a href=""></a>        <span class="co"># msg_ts could be a tuple or a dict containing HLC</span></span>
<span id="cb10-36"><a href=""></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(msg_ts, <span class="bu">dict</span>):</span>
<span id="cb10-37"><a href=""></a>            <span class="cf">if</span> <span class="st">"hlc"</span> <span class="kw">in</span> msg_ts:</span>
<span id="cb10-38"><a href=""></a>                mpt, mlc <span class="op">=</span> msg_ts[<span class="st">"hlc"</span>]</span>
<span id="cb10-39"><a href=""></a>            <span class="cf">elif</span> <span class="st">"hlc_timestamp"</span> <span class="kw">in</span> msg_ts:</span>
<span id="cb10-40"><a href=""></a>                mpt, mlc <span class="op">=</span> msg_ts[<span class="st">"hlc_timestamp"</span>]</span>
<span id="cb10-41"><a href=""></a>            <span class="cf">elif</span> <span class="st">"timestamp"</span> <span class="kw">in</span> msg_ts:</span>
<span id="cb10-42"><a href=""></a>                mpt, mlc <span class="op">=</span> msg_ts[<span class="st">"timestamp"</span>]</span>
<span id="cb10-43"><a href=""></a>            <span class="cf">else</span>:</span>
<span id="cb10-44"><a href=""></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Incoming message missing HLC."</span>)</span>
<span id="cb10-45"><a href=""></a>        <span class="cf">else</span>:</span>
<span id="cb10-46"><a href=""></a>            mpt, mlc <span class="op">=</span> msg_ts</span>
<span id="cb10-47"><a href=""></a></span>
<span id="cb10-48"><a href=""></a>        <span class="cf">with</span> <span class="va">self</span>._lock:</span>
<span id="cb10-49"><a href=""></a>            now <span class="op">=</span> <span class="va">self</span>._now_ms()</span>
<span id="cb10-50"><a href=""></a>            new_pt <span class="op">=</span> <span class="bu">max</span>(<span class="va">self</span>.pt, mpt, now)</span>
<span id="cb10-51"><a href=""></a>            <span class="cf">if</span> new_pt <span class="op">==</span> mpt <span class="op">==</span> now:</span>
<span id="cb10-52"><a href=""></a>                new_lc <span class="op">=</span> <span class="bu">max</span>(<span class="va">self</span>.lc, mlc) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb10-53"><a href=""></a>            <span class="cf">elif</span> new_pt <span class="op">==</span> mpt:</span>
<span id="cb10-54"><a href=""></a>                new_lc <span class="op">=</span> mlc <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb10-55"><a href=""></a>            <span class="cf">elif</span> new_pt <span class="op">==</span> now:</span>
<span id="cb10-56"><a href=""></a>                new_lc <span class="op">=</span> <span class="va">self</span>.lc <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb10-57"><a href=""></a>            <span class="cf">else</span>:</span>
<span id="cb10-58"><a href=""></a>                new_lc <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb10-59"><a href=""></a>            <span class="va">self</span>.pt, <span class="va">self</span>.lc <span class="op">=</span> new_pt, new_lc</span>
<span id="cb10-60"><a href=""></a>            <span class="cf">return</span> (<span class="va">self</span>.pt, <span class="va">self</span>.lc)</span>
<span id="cb10-61"><a href=""></a></span>
<span id="cb10-62"><a href=""></a>    <span class="kw">def</span> current(<span class="va">self</span>):</span>
<span id="cb10-63"><a href=""></a>        <span class="cf">with</span> <span class="va">self</span>._lock:</span>
<span id="cb10-64"><a href=""></a>            <span class="cf">return</span> (<span class="va">self</span>.pt, <span class="va">self</span>.lc)</span>
<span id="cb10-65"><a href=""></a></span>
<span id="cb10-66"><a href=""></a></span>
<span id="cb10-67"><a href=""></a><span class="kw">class</span> Network:</span>
<span id="cb10-68"><a href=""></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, drop_prob<span class="op">=</span><span class="fl">0.1</span>, delay_range<span class="op">=</span>(<span class="fl">0.01</span>, <span class="fl">0.1</span>)):</span>
<span id="cb10-69"><a href=""></a>        <span class="va">self</span>.nodes <span class="op">=</span> {}</span>
<span id="cb10-70"><a href=""></a>        <span class="va">self</span>.drop_prob <span class="op">=</span> drop_prob</span>
<span id="cb10-71"><a href=""></a>        <span class="va">self</span>.delay_range <span class="op">=</span> delay_range</span>
<span id="cb10-72"><a href=""></a></span>
<span id="cb10-73"><a href=""></a>    <span class="kw">def</span> register(<span class="va">self</span>, node):</span>
<span id="cb10-74"><a href=""></a>        <span class="va">self</span>.nodes[node.node_id] <span class="op">=</span> node</span>
<span id="cb10-75"><a href=""></a></span>
<span id="cb10-76"><a href=""></a>    <span class="kw">def</span> send(<span class="va">self</span>, message):</span>
<span id="cb10-77"><a href=""></a>        src <span class="op">=</span> message[<span class="st">"from"</span>]</span>
<span id="cb10-78"><a href=""></a>        dst <span class="op">=</span> message[<span class="st">"to"</span>]</span>
<span id="cb10-79"><a href=""></a>        delay <span class="op">=</span> random.uniform(<span class="op">*</span><span class="va">self</span>.delay_range)</span>
<span id="cb10-80"><a href=""></a></span>
<span id="cb10-81"><a href=""></a>        <span class="kw">def</span> _deliver():</span>
<span id="cb10-82"><a href=""></a>            time.sleep(delay)</span>
<span id="cb10-83"><a href=""></a>            <span class="cf">if</span> random.random() <span class="op">&lt;</span> <span class="va">self</span>.drop_prob:</span>
<span id="cb10-84"><a href=""></a>                <span class="bu">print</span>(<span class="ss">f"网络失败：</span><span class="sc">{</span>src<span class="sc">}</span><span class="ss"> -&gt; </span><span class="sc">{</span>dst<span class="sc">}</span><span class="ss"> (drop)"</span>)</span>
<span id="cb10-85"><a href=""></a>                <span class="cf">return</span></span>
<span id="cb10-86"><a href=""></a>            target <span class="op">=</span> <span class="va">self</span>.nodes.get(dst)</span>
<span id="cb10-87"><a href=""></a>            <span class="cf">if</span> target <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb10-88"><a href=""></a>                <span class="bu">print</span>(<span class="ss">f"投递失败：目标节点不存在 </span><span class="sc">{</span>dst<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-89"><a href=""></a>                <span class="cf">return</span></span>
<span id="cb10-90"><a href=""></a>            target.receive_message(message)</span>
<span id="cb10-91"><a href=""></a></span>
<span id="cb10-92"><a href=""></a>        threading.Thread(target<span class="op">=</span>_deliver, daemon<span class="op">=</span><span class="va">True</span>).start()</span>
<span id="cb10-93"><a href=""></a>        <span class="cf">return</span> delay</span>
<span id="cb10-94"><a href=""></a></span>
<span id="cb10-95"><a href=""></a></span>
<span id="cb10-96"><a href=""></a><span class="kw">class</span> DistributedRPCSystem:</span>
<span id="cb10-97"><a href=""></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, node_id, network: Network):</span>
<span id="cb10-98"><a href=""></a>        <span class="va">self</span>.node_id <span class="op">=</span> node_id</span>
<span id="cb10-99"><a href=""></a>        <span class="va">self</span>.hlc <span class="op">=</span> HybridLogicalClock()</span>
<span id="cb10-100"><a href=""></a>        <span class="va">self</span>.network <span class="op">=</span> network</span>
<span id="cb10-101"><a href=""></a>        <span class="va">self</span>.log <span class="op">=</span> []</span>
<span id="cb10-102"><a href=""></a>        <span class="va">self</span>.message_log <span class="op">=</span> []  <span class="co"># 记录所有消息（发送/接收）</span></span>
<span id="cb10-103"><a href=""></a>        <span class="va">self</span>.request_history <span class="op">=</span> <span class="bu">set</span>()  <span class="co"># 防重复的请求ID</span></span>
<span id="cb10-104"><a href=""></a>        <span class="va">self</span>.network.register(<span class="va">self</span>)</span>
<span id="cb10-105"><a href=""></a></span>
<span id="cb10-106"><a href=""></a>    <span class="kw">def</span> _log_send(<span class="va">self</span>, message, delay):</span>
<span id="cb10-107"><a href=""></a>        <span class="va">self</span>.message_log.append(</span>
<span id="cb10-108"><a href=""></a>            {</span>
<span id="cb10-109"><a href=""></a>                <span class="st">"action"</span>: <span class="st">"send"</span>,</span>
<span id="cb10-110"><a href=""></a>                <span class="st">"message"</span>: message,</span>
<span id="cb10-111"><a href=""></a>                <span class="st">"local_time"</span>: time.time(),</span>
<span id="cb10-112"><a href=""></a>                <span class="st">"hlc_time"</span>: message[<span class="st">"hlc"</span>],  <span class="co"># 发送时所附带的 HLC</span></span>
<span id="cb10-113"><a href=""></a>                <span class="st">"delay"</span>: delay,</span>
<span id="cb10-114"><a href=""></a>            }</span>
<span id="cb10-115"><a href=""></a>        )</span>
<span id="cb10-116"><a href=""></a></span>
<span id="cb10-117"><a href=""></a>    <span class="kw">def</span> _log_recv(<span class="va">self</span>, message, recv_hlc):</span>
<span id="cb10-118"><a href=""></a>        <span class="va">self</span>.message_log.append(</span>
<span id="cb10-119"><a href=""></a>            {</span>
<span id="cb10-120"><a href=""></a>                <span class="st">"action"</span>: <span class="st">"receive"</span>,</span>
<span id="cb10-121"><a href=""></a>                <span class="st">"message"</span>: message,</span>
<span id="cb10-122"><a href=""></a>                <span class="st">"local_time"</span>: time.time(),</span>
<span id="cb10-123"><a href=""></a>                <span class="st">"hlc_time"</span>: recv_hlc,  <span class="co"># 接收端合并后的 HLC</span></span>
<span id="cb10-124"><a href=""></a>            }</span>
<span id="cb10-125"><a href=""></a>        )</span>
<span id="cb10-126"><a href=""></a></span>
<span id="cb10-127"><a href=""></a>    <span class="kw">def</span> call_remote(<span class="va">self</span>, target_node, method, args):</span>
<span id="cb10-128"><a href=""></a>        <span class="co">"""发起远程调用（request）。"""</span></span>
<span id="cb10-129"><a href=""></a>        request_id <span class="op">=</span> <span class="bu">str</span>(uuid.uuid4())</span>
<span id="cb10-130"><a href=""></a>        hlc_ts <span class="op">=</span> <span class="va">self</span>.hlc.send()  <span class="co"># 发送前 tick</span></span>
<span id="cb10-131"><a href=""></a></span>
<span id="cb10-132"><a href=""></a>        request <span class="op">=</span> {</span>
<span id="cb10-133"><a href=""></a>            <span class="st">"id"</span>: request_id,</span>
<span id="cb10-134"><a href=""></a>            <span class="st">"from"</span>: <span class="va">self</span>.node_id,</span>
<span id="cb10-135"><a href=""></a>            <span class="st">"to"</span>: target_node,</span>
<span id="cb10-136"><a href=""></a>            <span class="st">"method"</span>: method,</span>
<span id="cb10-137"><a href=""></a>            <span class="st">"args"</span>: args,</span>
<span id="cb10-138"><a href=""></a>            <span class="st">"hlc"</span>: hlc_ts,</span>
<span id="cb10-139"><a href=""></a>            <span class="st">"type"</span>: <span class="st">"request"</span>,</span>
<span id="cb10-140"><a href=""></a>        }</span>
<span id="cb10-141"><a href=""></a></span>
<span id="cb10-142"><a href=""></a>        delay <span class="op">=</span> <span class="va">self</span>.network.send(request)</span>
<span id="cb10-143"><a href=""></a>        <span class="bu">print</span>(</span>
<span id="cb10-144"><a href=""></a>            <span class="ss">f"[SEND] </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>node_id<span class="sc">}</span><span class="ss"> -&gt; </span><span class="sc">{</span>target_node<span class="sc">}</span><span class="ss"> | </span><span class="sc">{</span>method<span class="sc">}</span><span class="ss"> | HLC=</span><span class="sc">{</span>hlc_ts<span class="sc">}</span><span class="ss"> | 延迟≈</span><span class="sc">{</span>delay<span class="sc">:.3f}</span><span class="ss">s"</span></span>
<span id="cb10-145"><a href=""></a>        )</span>
<span id="cb10-146"><a href=""></a>        <span class="va">self</span>._log_send(request, delay)</span>
<span id="cb10-147"><a href=""></a>        <span class="cf">return</span> request_id</span>
<span id="cb10-148"><a href=""></a></span>
<span id="cb10-149"><a href=""></a>    <span class="kw">def</span> receive_message(<span class="va">self</span>, message):</span>
<span id="cb10-150"><a href=""></a>        <span class="co">"""接收消息（统一入口：request/response）。"""</span></span>
<span id="cb10-151"><a href=""></a>        <span class="co"># 幂等/去重（针对 request）</span></span>
<span id="cb10-152"><a href=""></a>        <span class="cf">if</span> message[<span class="st">"type"</span>] <span class="op">==</span> <span class="st">"request"</span> <span class="kw">and</span> message[<span class="st">"id"</span>] <span class="kw">in</span> <span class="va">self</span>.request_history:</span>
<span id="cb10-153"><a href=""></a>            <span class="bu">print</span>(<span class="ss">f"[DUP] </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>node_id<span class="sc">}</span><span class="ss"> 检测到重复请求：</span><span class="sc">{</span>message[<span class="st">'id'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-154"><a href=""></a>            <span class="cf">return</span></span>
<span id="cb10-155"><a href=""></a></span>
<span id="cb10-156"><a href=""></a>        <span class="co"># HLC 合并</span></span>
<span id="cb10-157"><a href=""></a>        recv_hlc <span class="op">=</span> <span class="va">self</span>.hlc.recv(message[<span class="st">"hlc"</span>])</span>
<span id="cb10-158"><a href=""></a>        <span class="va">self</span>._log_recv(message, recv_hlc)</span>
<span id="cb10-159"><a href=""></a></span>
<span id="cb10-160"><a href=""></a>        <span class="co"># 标记已处理（仅记录 request 去重；response 在此示例不去重）</span></span>
<span id="cb10-161"><a href=""></a>        <span class="cf">if</span> message[<span class="st">"type"</span>] <span class="op">==</span> <span class="st">"request"</span>:</span>
<span id="cb10-162"><a href=""></a>            <span class="va">self</span>.request_history.add(message[<span class="st">"id"</span>])</span>
<span id="cb10-163"><a href=""></a></span>
<span id="cb10-164"><a href=""></a>        <span class="co"># 分派处理</span></span>
<span id="cb10-165"><a href=""></a>        <span class="cf">if</span> message[<span class="st">"type"</span>] <span class="op">==</span> <span class="st">"request"</span>:</span>
<span id="cb10-166"><a href=""></a>            <span class="va">self</span>.process_request(message)</span>
<span id="cb10-167"><a href=""></a>        <span class="cf">elif</span> message[<span class="st">"type"</span>] <span class="op">==</span> <span class="st">"response"</span>:</span>
<span id="cb10-168"><a href=""></a>            <span class="va">self</span>.process_response(message)</span>
<span id="cb10-169"><a href=""></a></span>
<span id="cb10-170"><a href=""></a>    <span class="kw">def</span> process_request(<span class="va">self</span>, request):</span>
<span id="cb10-171"><a href=""></a>        <span class="co">"""处理 request 并发送 response。"""</span></span>
<span id="cb10-172"><a href=""></a>        method <span class="op">=</span> request[<span class="st">"method"</span>]</span>
<span id="cb10-173"><a href=""></a>        args <span class="op">=</span> request[<span class="st">"args"</span>]</span>
<span id="cb10-174"><a href=""></a>        <span class="bu">print</span>(<span class="ss">f"[PROC] </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>node_id<span class="sc">}</span><span class="ss"> 处理请求：</span><span class="sc">{</span>method<span class="sc">}</span><span class="ss">(</span><span class="sc">{</span>args<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb10-175"><a href=""></a></span>
<span id="cb10-176"><a href=""></a>        <span class="co"># 模拟处理时间</span></span>
<span id="cb10-177"><a href=""></a>        time.sleep(random.uniform(<span class="fl">0.01</span>, <span class="fl">0.05</span>))</span>
<span id="cb10-178"><a href=""></a></span>
<span id="cb10-179"><a href=""></a>        <span class="co"># 构造响应（发送前 tick）</span></span>
<span id="cb10-180"><a href=""></a>        response_hlc <span class="op">=</span> <span class="va">self</span>.hlc.send()</span>
<span id="cb10-181"><a href=""></a>        response <span class="op">=</span> {</span>
<span id="cb10-182"><a href=""></a>            <span class="st">"id"</span>: <span class="bu">str</span>(uuid.uuid4()),</span>
<span id="cb10-183"><a href=""></a>            <span class="st">"from"</span>: <span class="va">self</span>.node_id,</span>
<span id="cb10-184"><a href=""></a>            <span class="st">"to"</span>: request[<span class="st">"from"</span>],</span>
<span id="cb10-185"><a href=""></a>            <span class="st">"original_request_id"</span>: request[<span class="st">"id"</span>],</span>
<span id="cb10-186"><a href=""></a>            <span class="st">"result"</span>: <span class="ss">f"处理结果：</span><span class="sc">{</span>method<span class="sc">}</span><span class="ss">(</span><span class="sc">{</span>args<span class="sc">}</span><span class="ss">)"</span>,</span>
<span id="cb10-187"><a href=""></a>            <span class="st">"hlc"</span>: response_hlc,</span>
<span id="cb10-188"><a href=""></a>            <span class="st">"type"</span>: <span class="st">"response"</span>,</span>
<span id="cb10-189"><a href=""></a>        }</span>
<span id="cb10-190"><a href=""></a></span>
<span id="cb10-191"><a href=""></a>        delay <span class="op">=</span> <span class="va">self</span>.network.send(response)</span>
<span id="cb10-192"><a href=""></a>        <span class="bu">print</span>(</span>
<span id="cb10-193"><a href=""></a>            <span class="ss">f"[RESP] </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>node_id<span class="sc">}</span><span class="ss"> -&gt; </span><span class="sc">{</span>request[<span class="st">'from'</span>]<span class="sc">}</span><span class="ss"> | HLC=</span><span class="sc">{</span>response_hlc<span class="sc">}</span><span class="ss"> | 延迟≈</span><span class="sc">{</span>delay<span class="sc">:.3f}</span><span class="ss">s"</span></span>
<span id="cb10-194"><a href=""></a>        )</span>
<span id="cb10-195"><a href=""></a>        <span class="va">self</span>._log_send(response, delay)</span>
<span id="cb10-196"><a href=""></a></span>
<span id="cb10-197"><a href=""></a>    <span class="kw">def</span> process_response(<span class="va">self</span>, response):</span>
<span id="cb10-198"><a href=""></a>        <span class="co">"""处理 response（演示中仅打印）。"""</span></span>
<span id="cb10-199"><a href=""></a>        <span class="bu">print</span>(</span>
<span id="cb10-200"><a href=""></a>            <span class="ss">f"[RECV-RESP] </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>node_id<span class="sc">}</span><span class="ss"> 收到响应 for </span><span class="sc">{</span>response<span class="sc">.</span>get(<span class="st">'original_request_id'</span>)<span class="sc">}</span><span class="ss"> | HLC=</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>hlc<span class="sc">.</span>current()<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb10-201"><a href=""></a>        )</span>
<span id="cb10-202"><a href=""></a></span>
<span id="cb10-203"><a href=""></a>    <span class="co"># 可扩展：本地业务操作</span></span>
<span id="cb10-204"><a href=""></a>    <span class="kw">def</span> local_event(<span class="va">self</span>, note<span class="op">=</span><span class="st">"local"</span>):</span>
<span id="cb10-205"><a href=""></a>        ts <span class="op">=</span> <span class="va">self</span>.hlc.tick()</span>
<span id="cb10-206"><a href=""></a>        <span class="va">self</span>.log.append((note, ts))</span>
<span id="cb10-207"><a href=""></a>        <span class="cf">return</span> ts</span>
<span id="cb10-208"><a href=""></a></span>
<span id="cb10-209"><a href=""></a></span>
<span id="cb10-210"><a href=""></a><span class="kw">def</span> demonstrate_time_gaps():</span>
<span id="cb10-211"><a href=""></a>    net <span class="op">=</span> Network(drop_prob<span class="op">=</span><span class="fl">0.10</span>, delay_range<span class="op">=</span>(<span class="fl">0.01</span>, <span class="fl">0.10</span>))</span>
<span id="cb10-212"><a href=""></a></span>
<span id="cb10-213"><a href=""></a>    <span class="co"># 创建三个节点</span></span>
<span id="cb10-214"><a href=""></a>    nodes <span class="op">=</span> {<span class="ss">f"node</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>: DistributedRPCSystem(<span class="ss">f"node</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span>, net) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>)}</span>
<span id="cb10-215"><a href=""></a></span>
<span id="cb10-216"><a href=""></a>    <span class="co"># 并发发送请求，观察时间顺序</span></span>
<span id="cb10-217"><a href=""></a>    <span class="kw">def</span> send_requests():</span>
<span id="cb10-218"><a href=""></a>        <span class="co"># 节点0向节点1发送转账请求</span></span>
<span id="cb10-219"><a href=""></a>        nodes[<span class="st">"node0"</span>].call_remote(</span>
<span id="cb10-220"><a href=""></a>            <span class="st">"node1"</span>, <span class="st">"transfer"</span>, {<span class="st">"amount"</span>: <span class="dv">100</span>, <span class="st">"to"</span>: <span class="st">"account_B"</span>}</span>
<span id="cb10-221"><a href=""></a>        )</span>
<span id="cb10-222"><a href=""></a>        time.sleep(<span class="fl">0.05</span>)</span>
<span id="cb10-223"><a href=""></a></span>
<span id="cb10-224"><a href=""></a>        <span class="co"># 节点1向节点2发送查询请求</span></span>
<span id="cb10-225"><a href=""></a>        nodes[<span class="st">"node1"</span>].call_remote(<span class="st">"node2"</span>, <span class="st">"query_balance"</span>, {<span class="st">"account"</span>: <span class="st">"account_B"</span>})</span>
<span id="cb10-226"><a href=""></a>        time.sleep(<span class="fl">0.05</span>)</span>
<span id="cb10-227"><a href=""></a></span>
<span id="cb10-228"><a href=""></a>        <span class="co"># 节点2向节点0发送审计请求</span></span>
<span id="cb10-229"><a href=""></a>        nodes[<span class="st">"node2"</span>].call_remote(<span class="st">"node0"</span>, <span class="st">"audit"</span>, {<span class="st">"transaction_id"</span>: <span class="st">"tx_123"</span>})</span>
<span id="cb10-230"><a href=""></a></span>
<span id="cb10-231"><a href=""></a>    t <span class="op">=</span> threading.Thread(target<span class="op">=</span>send_requests)</span>
<span id="cb10-232"><a href=""></a>    t.start()</span>
<span id="cb10-233"><a href=""></a>    t.join()</span>
<span id="cb10-234"><a href=""></a></span>
<span id="cb10-235"><a href=""></a>    <span class="co"># 等待所有可能的传输/处理完成</span></span>
<span id="cb10-236"><a href=""></a>    time.sleep(<span class="fl">0.6</span>)</span>
<span id="cb10-237"><a href=""></a></span>
<span id="cb10-238"><a href=""></a>    <span class="co"># 汇总并按 HLC 顺序输出</span></span>
<span id="cb10-239"><a href=""></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== 消息时序分析（按 HLC 排序） ==="</span>)</span>
<span id="cb10-240"><a href=""></a>    all_messages <span class="op">=</span> []</span>
<span id="cb10-241"><a href=""></a>    <span class="cf">for</span> node_id, node <span class="kw">in</span> nodes.items():</span>
<span id="cb10-242"><a href=""></a>        <span class="cf">for</span> msg_info <span class="kw">in</span> node.message_log:</span>
<span id="cb10-243"><a href=""></a>            all_messages.append((node_id, msg_info))</span>
<span id="cb10-244"><a href=""></a></span>
<span id="cb10-245"><a href=""></a>    <span class="co"># 加入 node_id 作为并列时的稳定 tie-breaker</span></span>
<span id="cb10-246"><a href=""></a>    all_messages.sort(key<span class="op">=</span><span class="kw">lambda</span> x: (x[<span class="dv">1</span>][<span class="st">"hlc_time"</span>], x[<span class="dv">0</span>], x[<span class="dv">1</span>][<span class="st">"action"</span>]))</span>
<span id="cb10-247"><a href=""></a></span>
<span id="cb10-248"><a href=""></a>    <span class="cf">for</span> node_id, msg_info <span class="kw">in</span> all_messages:</span>
<span id="cb10-249"><a href=""></a>        hlc_time <span class="op">=</span> msg_info[<span class="st">"hlc_time"</span>]</span>
<span id="cb10-250"><a href=""></a>        action <span class="op">=</span> msg_info[<span class="st">"action"</span>]</span>
<span id="cb10-251"><a href=""></a>        message <span class="op">=</span> msg_info[<span class="st">"message"</span>]</span>
<span id="cb10-252"><a href=""></a>        kind <span class="op">=</span> message.get(<span class="st">"method"</span>) <span class="kw">or</span> message.get(<span class="st">"type"</span>)</span>
<span id="cb10-253"><a href=""></a>        delay <span class="op">=</span> msg_info.get(<span class="st">"delay"</span>)</span>
<span id="cb10-254"><a href=""></a>        <span class="cf">if</span> action <span class="op">==</span> <span class="st">"send"</span>:</span>
<span id="cb10-255"><a href=""></a>            <span class="bu">print</span>(</span>
<span id="cb10-256"><a href=""></a>                <span class="ss">f"HLC </span><span class="sc">{</span>hlc_time<span class="sc">}</span><span class="ss"> | </span><span class="sc">{</span>node_id<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>action<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>kind<span class="sc">}</span><span class="ss"> -&gt; </span><span class="sc">{</span>message[<span class="st">'to'</span>]<span class="sc">}</span><span class="ss"> (delay≈</span><span class="sc">{</span>delay<span class="sc">:.3f}</span><span class="ss">s)"</span></span>
<span id="cb10-257"><a href=""></a>            )</span>
<span id="cb10-258"><a href=""></a>        <span class="cf">else</span>:</span>
<span id="cb10-259"><a href=""></a>            <span class="bu">print</span>(<span class="ss">f"HLC </span><span class="sc">{</span>hlc_time<span class="sc">}</span><span class="ss"> | </span><span class="sc">{</span>node_id<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>action<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>kind<span class="sc">}</span><span class="ss"> &lt;- </span><span class="sc">{</span>message[<span class="st">'from'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-260"><a href=""></a></span>
<span id="cb10-261"><a href=""></a></span>
<span id="cb10-262"><a href=""></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb10-263"><a href=""></a>    demonstrate_time_gaps()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section></section>
<section>
<section id="总结-预告" class="title-slide slide level1 center">
<h1>总结 &amp; 预告</h1>

</section>
<section id="本讲小结" class="slide level2">
<h2>本讲小结</h2>
<ol type="1">
<li>关键是顺序而非绝对时间</li>
<li><strong>Lamport 时钟</strong>给出了偏序；<strong>向量时钟</strong>刻画因果/并发；<strong>HLC</strong>平衡实用性与可读性</li>
<li>用<strong>日志</strong>把时间观操作化，WAL/复制/重放提供确定性</li>
</ol>
</section>
<section id="思考题" class="slide level2">
<h2>思考题</h2>
<ol type="1">
<li><strong>Lamport 相等时间戳意味着什么？</strong> 还能否存在未被观测到的因果？</li>
<li><strong>HLC 小于一定表示因果先后吗？</strong> 从因果兼容的全序角度思考</li>
<li><strong>为什么都用 WAL？</strong> 从原子性、恢复确定性与顺序写性能谈起</li>
<li><strong>如何处理重复请求？</strong> 幂等性 + 请求ID/时间窗 +（可选）向量时钟判新颖性</li>
</ol>
</section>
<section id="下节预告" class="slide level2">
<h2>下节预告</h2>
<p>复制语义与共识</p>
<ul>
<li>如何确保多个节点达成一致？</li>
<li>如果有节点宕机了怎么办？</li>
<li>如何保持同步？</li>
</ul>
</section>
<section id="作业-1分布式计数器" class="slide level2 smaller">
<h2>作业 #1：分布式计数器</h2>
<ul>
<li>三节点，可独立 <code>increment()</code>，这是基于 CRDT 的操作</li>
<li>用 Lamport 为操作排序；使用日志同步</li>
<li>模拟网络分区和重启恢复，最终达成一致</li>
<li>需完成代码，并根据测试结果编写观察报告</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href=""></a><span class="kw">class</span> DistributedCounter:</span>
<span id="cb11-2"><a href=""></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, node_id, peers):</span>
<span id="cb11-3"><a href=""></a>        <span class="va">self</span>.node_id <span class="op">=</span> node_id</span>
<span id="cb11-4"><a href=""></a>        <span class="va">self</span>.peers <span class="op">=</span> peers</span>
<span id="cb11-5"><a href=""></a>        <span class="va">self</span>.value <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb11-6"><a href=""></a>        <span class="va">self</span>.clock <span class="op">=</span> LamportClock()</span>
<span id="cb11-7"><a href=""></a>        <span class="va">self</span>.log <span class="op">=</span> []</span>
<span id="cb11-8"><a href=""></a>        <span class="va">self</span>.applied <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb11-9"><a href=""></a></span>
<span id="cb11-10"><a href=""></a>    <span class="kw">def</span> increment(<span class="va">self</span>, k<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb11-11"><a href=""></a>        <span class="co"># </span><span class="al">TODO</span><span class="co">: 生成操作(op_id, node, delta, ts)，追加本地日志并广播</span></span>
<span id="cb11-12"><a href=""></a>        <span class="cf">pass</span></span>
<span id="cb11-13"><a href=""></a></span>
<span id="cb11-14"><a href=""></a>    <span class="kw">def</span> apply_if_ready(<span class="va">self</span>):</span>
<span id="cb11-15"><a href=""></a>        <span class="co"># </span><span class="al">TODO</span><span class="co">: 基于偏序/因果就绪性检查后应用，去重</span></span>
<span id="cb11-16"><a href=""></a>        <span class="cf">pass</span></span>
<span id="cb11-17"><a href=""></a></span>
<span id="cb11-18"><a href=""></a>    <span class="kw">def</span> sync(<span class="va">self</span>):</span>
<span id="cb11-19"><a href=""></a>        <span class="co"># </span><span class="al">TODO</span><span class="co">: 交换日志，按时钟顺序归并与交付</span></span>
<span id="cb11-20"><a href=""></a>        <span class="cf">pass</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="参考资料" class="slide level2 smaller">
<h2>参考资料</h2>
<ol type="1">
<li>Lamport, L. (1978). Time, clocks, and the ordering of events in a distributed system. <em>Communications of the ACM</em>.</li>
<li>Fidge, C. J. (1988). Timestamps in message-passing systems that preserve the partial ordering. In <em>Proceedings of the 11th Australian Computer Science Conference</em>.</li>
<li>Mattern, F. (1988). Virtual time and global states of distributed systems. <em>Parallel and Distributed Algorithms</em>.</li>
<li>Corbett, J. C., Dean, J., Epstein, M., et al.&nbsp;(2012). Spanner: Google’s globally-distributed database. In <em>Proceedings of the 10th USENIX Symposium on Operating Systems Design and Implementation</em> (OSDI 12).</li>
<li>Kulkarni, S. S., Demirbas, M., Madappa, et al.&nbsp;(2014). Logical physical clocks and consistent snapshots in globally distributed databases. In <em>Proceedings of the 2014 ACM symposium on Principles of distributed computing</em>.</li>
</ol>
</section>
<section id="参考资料续" class="slide level2 smaller">
<h2>参考资料（续）</h2>
<ol start="6" type="1">
<li>Peng, D., &amp; Dabek, F. (2010). Large-scale incremental processing using distributed transactions and notifications. In <em>Proceedings of the 9th USENIX Symposium on Operating Systems Design and Implementation</em> (OSDI 10).</li>
<li>Sridharan, C. (2018). <em>Distributed Systems Observability</em>. O’Reilly Media.</li>
<li>Kleppmann, M. (2017). <em>Designing Data-Intensive Applications</em>. O’Reilly Media.</li>
</ol>

</section></section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">

</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="slide02_files/libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="slide02_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="slide02_files/libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="slide02_files/libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="slide02_files/libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="slide02_files/libs/revealjs/plugin/reveal-chalkboard/plugin.js"></script>
  <script src="slide02_files/libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="slide02_files/libs/revealjs/plugin/notes/notes.js"></script>
  <script src="slide02_files/libs/revealjs/plugin/search/search.js"></script>
  <script src="slide02_files/libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="slide02_files/libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': true,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleChalkboard(event)\"><kbd>b</kbd> Toggle Chalkboard</a></li>\n<li class=\"slide-tool-item\" data-item=\"6\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleNotesCanvas(event)\"><kbd>c</kbd> Toggle Notes Canvas</a></li>\n<li class=\"slide-tool-item\" data-item=\"7\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.downloadDrawings(event)\"><kbd>d</kbd> Download Drawings</a></li>\n<li class=\"slide-tool-item\" data-item=\"8\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'chalkboard': {"buttons":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'slide',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, RevealChalkboard, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script id="quarto-html-after-body" type="application/javascript">
      window.document.addEventListener("DOMContentLoaded", function (event) {
        const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
        tabsets.forEach(function(tabset) {
          const tabby = new Tabby('#' + tabset.id);
        });
        const isCodeAnnotation = (el) => {
          for (const clz of el.classList) {
            if (clz.startsWith('code-annotation-')) {                     
              return true;
            }
          }
          return false;
        }
        const onCopySuccess = function(e) {
          // button target
          const button = e.trigger;
          // don't keep focus
          button.blur();
          // flash "checked"
          button.classList.add('code-copy-button-checked');
          var currentTitle = button.getAttribute("title");
          button.setAttribute("title", "已复制");
          let tooltip;
          if (window.bootstrap) {
            button.setAttribute("data-bs-toggle", "tooltip");
            button.setAttribute("data-bs-placement", "left");
            button.setAttribute("data-bs-title", "已复制");
            tooltip = new bootstrap.Tooltip(button, 
              { trigger: "manual", 
                customClass: "code-copy-button-tooltip",
                offset: [0, -8]});
            tooltip.show();    
          }
          setTimeout(function() {
            if (tooltip) {
              tooltip.hide();
              button.removeAttribute("data-bs-title");
              button.removeAttribute("data-bs-toggle");
              button.removeAttribute("data-bs-placement");
            }
            button.setAttribute("title", currentTitle);
            button.classList.remove('code-copy-button-checked');
          }, 1000);
          // clear code selection
          e.clearSelection();
        }
        const getTextToCopy = function(trigger) {
            const codeEl = trigger.previousElementSibling.cloneNode(true);
            for (const childEl of codeEl.children) {
              if (isCodeAnnotation(childEl)) {
                childEl.remove();
              }
            }
            return codeEl.innerText;
        }
        const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
          text: getTextToCopy
        });
        clipboard.on('success', onCopySuccess);
        if (window.document.getElementById('quarto-embedded-source-code-modal')) {
          const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
            text: getTextToCopy,
            container: window.document.getElementById('quarto-embedded-source-code-modal')
          });
          clipboardModal.on('success', onCopySuccess);
        }
          var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
          var mailtoRegex = new RegExp(/^mailto:/);
            var filterRegex = new RegExp('/' + window.location.host + '/');
          var isInternal = (href) => {
              return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
          }
          // Inspect non-navigation links and adorn them if external
         var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
          for (var i=0; i<links.length; i++) {
            const link = links[i];
            if (!isInternal(link.href)) {
              // undo the damage that might have been done by quarto-nav.js in the case of
              // links that we want to consider external
              if (link.dataset.originalHref !== undefined) {
                link.href = link.dataset.originalHref;
              }
            }
          }
        function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
          const config = {
            allowHTML: true,
            maxWidth: 500,
            delay: 100,
            arrow: false,
            appendTo: function(el) {
                return el.closest('section.slide') || el.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'light-border',
            placement: 'bottom-start',
          };
          if (contentFn) {
            config.content = contentFn;
          }
          if (onTriggerFn) {
            config.onTrigger = onTriggerFn;
          }
          if (onUntriggerFn) {
            config.onUntrigger = onUntriggerFn;
          }
            config['offset'] = [0,0];
            config['maxWidth'] = 700;
          window.tippy(el, config); 
        }
        const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
        for (var i=0; i<noterefs.length; i++) {
          const ref = noterefs[i];
          tippyHover(ref, function() {
            // use id or data attribute instead here
            let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
            try { href = new URL(href).hash; } catch {}
            const id = href.replace(/^#\/?/, "");
            const note = window.document.getElementById(id);
            if (note) {
              return note.innerHTML;
            } else {
              return "";
            }
          });
        }
        const findCites = (el) => {
          const parentEl = el.parentElement;
          if (parentEl) {
            const cites = parentEl.dataset.cites;
            if (cites) {
              return {
                el,
                cites: cites.split(' ')
              };
            } else {
              return findCites(el.parentElement)
            }
          } else {
            return undefined;
          }
        };
        var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
        for (var i=0; i<bibliorefs.length; i++) {
          const ref = bibliorefs[i];
          const citeInfo = findCites(ref);
          if (citeInfo) {
            tippyHover(citeInfo.el, function() {
              var popup = window.document.createElement('div');
              citeInfo.cites.forEach(function(cite) {
                var citeDiv = window.document.createElement('div');
                citeDiv.classList.add('hanging-indent');
                citeDiv.classList.add('csl-entry');
                var biblioDiv = window.document.getElementById('ref-' + cite);
                if (biblioDiv) {
                  citeDiv.innerHTML = biblioDiv.innerHTML;
                }
                popup.appendChild(citeDiv);
              });
              return popup.innerHTML;
            });
          }
        }
      });
      </script>
    

</body></html>